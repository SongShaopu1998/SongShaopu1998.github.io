I"ÍI<p>æœ¬ç¯‡æ–‡ç« æ˜¯æˆ‘å­¦ä¹ <em>CS 106L</em>è¯¾ç¨‹çš„ç¬”è®°è®°å½•ï¼Œä½†æœ¬æ–‡ä¸­å¤§éƒ¨åˆ†å†…å®¹æ¥è‡ªäºå­¦ä¹ è¿‡ç¨‹ä¸­æŸ¥é˜…çš„å„ç§<em>blog</em>ä»¥åŠ<em>StackOverflow</em>å’Œ<strong>C++</strong>çš„æ ‡å‡†æ–‡æ¡£ï¼Œå‡é“ºå¼€é™ˆè¿°ä½†æµ…å°è¾„æ­¢ï¼Œä½œä¸ºä¸ªäººæ—¥åæŸ¥è¯¢ã€è¡¥å……å’Œæ·±å…¥å­¦ä¹ çš„æ‰‹å†Œä½¿ç”¨ã€‚æ­¤å¤–ï¼Œæˆ‘å°†2019ç§‹å­£Stanfordçš„CS 106Lä½œä¸šå‘å¸ƒåœ¨æˆ‘çš„<a href="https://github.com/SongShaopu1998/Stanford-CS-106L">Githubä»“åº“</a>.</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111091826467.png" alt="image-20211109182644300" style="zoom:50%;" /></p>

<h2 id="stream">stream</h2>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111091455815.png" alt="image-20211109145516729" style="zoom:50%;" /></p>

<h3 id="stringstream">stringstream</h3>

<p>ä»¥ä¸‹å†…å®¹æ¥è‡ªå®˜æ–¹æ–‡æ¡£ï¼š</p>

<blockquote>
  <p>Stream class to operate on strings.</p>

  <p>Objects of this class use a <em><a href="https://www.cplusplus.com/stringbuf">string buffer</a></em> that contains a sequence of characters. This sequence of characters can be accessed directly as a <a href="https://www.cplusplus.com/string">string</a> object, using member <a href="https://www.cplusplus.com/stringstream::str">str</a>.</p>

  <p>Characters can be inserted and/or extracted from the stream using any operation allowed on both <em><a href="https://www.cplusplus.com/istream">input</a></em> and <em><a href="https://www.cplusplus.com/ostream">output</a></em> streams.</p>

  <p><strong>stream buffer</strong>: â€œA stream buffer is an object in charge of performing the reading and writing operations of the <em>stream</em> object it is associated with: the stream delegates all such operations to its associated <em>stream buffer</em> object, which is <strong>an intermediary between the <em>stream</em> and its <em>controlled input and output sequences</em></strong>.â€</p>

  <p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111100150967.png" alt="image-20211110015005910" style="zoom:50%;" /></p>

  <p><img src="https://upload.cppreference.com/mwiki/images/7/75/std-streambuf.svg" alt="std-streambuf.svg" /></p>
</blockquote>

<blockquote>
  <p><strong>All <em>stream</em> objects, no matter whether buffered or unbuffered, have an associated <em>stream buffer</em></strong>: Some <em>stream buffer</em> types may then be set to either use an intermediate <em>buffer</em> or not.</p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">stringstream</code>ç±»ç»§æ‰¿è‡ªå‡ ä¸ª<code class="language-plaintext highlighter-rouge">ios</code>åŸºç¡€ç±»ï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111081327496.png" alt="image-20211108132713194" style="zoom:50%;" /></p>

<p><code class="language-plaintext highlighter-rouge">stringbuf</code>ç»§æ‰¿è‡ª<code class="language-plaintext highlighter-rouge">streambuf</code>:</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111090021218.png" alt="image-20211109002123175" style="zoom:50%;" /></p>

<h4 id="read--write">read &amp; write</h4>

<p>è¯¥ç±»åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œå¸¸å¸¸ç”¨äºåˆ†å‰²å­—ç¬¦ï¼ˆæŒ‰ç©ºæ ¼ï¼‰ã€‚å®ƒå°†<code class="language-plaintext highlighter-rouge">string</code>å­˜æ”¾åˆ°ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">string buffer</code>ï¼ˆç»§æ‰¿è‡ª<code class="language-plaintext highlighter-rouge">streambuf</code>ï¼‰ä¸­ï¼š</p>

<blockquote>
  <p>Internally, its <a href="https://www.cplusplus.com/iostream::iostream">iostream</a> base constructor is passed a pointer to a <a href="https://www.cplusplus.com/stringbuf">stringbuf</a> object constructed with str and which as arguments.</p>
</blockquote>

<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å‚æ•°<code class="language-plaintext highlighter-rouge">stringstream::ate</code>æŒ‡å®šæŒ‡é’ˆä½ç½®åœ¨æœ«ç«¯ï¼›å¦‚æœæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯<code class="language-plaintext highlighter-rouge">istringstream</code>ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">stringstream::bin</code>çš„æ–¹å¼ä»¥äºŒè¿›åˆ¶è¯»å–ã€‚</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111081336407.png" alt="image-20211108133647355" style="zoom:33%;" /></p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111081337944.png" alt="image-20211108133704904" style="zoom:33%;" /></p>

<p>æ¯å½“æˆ‘ä»¬ä½¿ç”¨<code class="language-plaintext highlighter-rouge">stringstream object</code>å‘è¯¥<code class="language-plaintext highlighter-rouge">string buffer</code>ä¸­è¯»å…¥æ•°æ®æ—¶ï¼ŒæŒ‡é’ˆä¼šä¸æ–­å‘ååšç›¸åº”ç§»åŠ¨ï¼Œå°±åƒè¿™æ ·ï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111081338230.png" alt="image-20211108133834185" style="zoom:33%;" /></p>

<p>æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">.str()</code>æ–¹æ³•å°†å­˜æ”¾äº<code class="language-plaintext highlighter-rouge">string buffer</code>ä¸­çš„å†…å®¹è¯»å–æˆå­—ç¬¦ä¸²ã€‚</p>

<h4 id="about-">about â€œÂ»â€</h4>

<p>æˆ‘ä»¬å¯ä»¥æŒ‡å®šç±»å‹ï¼Œä¹‹åä½¿ç”¨<code class="language-plaintext highlighter-rouge">&gt;&gt;</code>æ“ä½œç¬¦å°†å†…å®¹è¯»å…¥æŒ‡å®šç±»å‹çš„å˜é‡ä¸­ã€‚åœ¨C++å®˜æ–¹<a href="https://www.cplusplus.com/reference/istream/istream/operator%3E%3E/">æ–‡æ¡£é¡µé¢</a>ä¸Šï¼Œå¯¹è¿™ä¸€æ“ä½œè¿›è¡Œäº†è¯¦ç»†çš„æè¿°ï¼Œè¯¥è¿ç®—ç¬¦è¢«å¤šæ¬¡é‡è½½ç”¨ä»¥æ¥å—ä»¥ä¸‹ä¸‰ç§å‚æ•°ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">arithmetic types</code></li>
  <li><code class="language-plaintext highlighter-rouge">stream buffers</code></li>
  <li><code class="language-plaintext highlighter-rouge">manipulators</code></li>
</ul>

<p>å…·ä½“çš„æ“ä½œå¯ä»¥å‚è§ä¸Šè¾¹çš„é“¾æ¥ï¼Œæ€»ä¹‹å°±æ˜¯è¦å€ŸåŠ©äºç»§æ‰¿è‡ª<code class="language-plaintext highlighter-rouge">istream</code>çš„<code class="language-plaintext highlighter-rouge">sentry</code>ç±»æ¥è¾…åŠ©å¤„ç†è¾“å…¥æµï¼ˆæ¥å—ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">stream object parameter</code>ï¼‰ï¼Œ<strong>å®ƒé¦–å…ˆä¼šæ£€æµ‹å½“å‰<code class="language-plaintext highlighter-rouge">internal error flags</code>çš„çŠ¶æ€ï¼Œå¦‚æœä¸º<code class="language-plaintext highlighter-rouge">good</code>ï¼Œåˆ™ç»§ç»­è¿›è¡Œï¼Œå¦åˆ™ä¸ä¼šå¯¹æµåšä»»ä½•æ“ä½œï¼Œè¿™ä¸€ç‚¹éœ€è¦æ³¨æ„ã€‚</strong></p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111100144760.png" alt="image-20211110014417695" style="zoom:50%;" /></p>

<p>åœ¨è¿ç®—è¿‡ç¨‹ä¸­ï¼Œç¨‹åºé€šè¿‡è®¾å®š<code class="language-plaintext highlighter-rouge">ios_base::iostate</code>çš„å€¼æ¥å‘Šè¯‰ç›®å‰<code class="language-plaintext highlighter-rouge">stream</code>çš„æƒ…å†µâ€“è¿˜æä¾›äº†ç›¸åº”çš„å‡½æ•°å¸®åŠ©æˆ‘ä»¬è¿›è¡Œåˆ¤æ–­ï¼Œè¿™å‡ ä¸ªå¸¸é‡è¢«ç§°ä¸º<code class="language-plaintext highlighter-rouge">internal error state flags</code>ï¼Œå…·ä½“è§ä¸‹è¡¨:</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111081426342.png" alt="image-20211108142645284" style="zoom:50%;" /></p>

<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨æ–¹æ³•<code class="language-plaintext highlighter-rouge">ios::rdstate() const</code>æ¥è·å–å½“å‰<code class="language-plaintext highlighter-rouge">internal error state flags</code>çš„å€¼ï¼Œæˆ–è€…ä½¿ç”¨<code class="language-plaintext highlighter-rouge">basic_ios::setstate()</code>æ¥ä¿®æ”¹å½“å‰æ ‡å¿—ä½çš„å€¼ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå·²ç»è®¾ç½®äº†çš„<code class="language-plaintext highlighter-rouge">bitflag</code>æ˜¯ä¸ä¼šè‡ªåŠ¨æ¸…é™¤çš„(<code class="language-plaintext highlighter-rouge">sticky!</code>)ï¼Œéœ€è¦é€šè¿‡è°ƒç”¨<code class="language-plaintext highlighter-rouge">basic_ios::clear(iostate state = goodbit)</code>æ¥æ›¿æ¢å½“å‰çŠ¶æ€ã€‚</p>

<blockquote>
  <p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code class="language-plaintext highlighter-rouge">End-Of-File</code>å¹¶ä¸æ˜¯ä»€ä¹ˆå­˜åœ¨äºæ–‡ä»¶æœ«å°¾çš„å­—ç¬¦ï¼Œ<code class="language-plaintext highlighter-rouge">EOF</code>æ˜¯å®šä¹‰äºæ ‡å‡†åº“å†…çš„ä¸€ä¸ªå®(<code class="language-plaintext highlighter-rouge">macro</code>):</p>

  <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define EOF (-1)
</span></code></pre></div>  </div>

  <p>å½“æ–‡ä»¶æˆ–è€…å­—ç¬¦ä¸²è¢«è¯»å–åˆ°æœ«å°¾æ—¶ï¼Œ<strong>è¯»å–å‡½æ•°ä¼šè¿”å›<code class="language-plaintext highlighter-rouge">-1</code></strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿè¯´<code class="language-plaintext highlighter-rouge">eof reached</code>.å½“æ–‡ä»¶ï¼ˆå­—ç¬¦ä¸²ï¼‰æœ«å°¾åˆ°è¾¾åï¼Œç¨‹åºè®¾ç½®<code class="language-plaintext highlighter-rouge">eofbit</code>ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„æ­¤æ—¶<code class="language-plaintext highlighter-rouge">failbit</code>ä¸<code class="language-plaintext highlighter-rouge">badbit</code>ä¹Ÿå¯èƒ½åŒæ—¶è¢«è®¾ç½®.</p>

  <blockquote>
    <p>â€œReaching the <em>End-of-File</em> sets the eofbit. But note that operations that reach the <em>End-of-File</em> may also set the failbit if this makes them fail (thus setting both eofbit and failbit).â€</p>
  </blockquote>
</blockquote>

<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œ<code class="language-plaintext highlighter-rouge">&gt;&gt;</code>ä¼šåœ¨ä»€ä¹ˆæ—¶å€™è®¾ç½®è¿™å‡ ä¸ª<code class="language-plaintext highlighter-rouge">bitflag</code>å‘¢ï¼Ÿå®˜æ–¹<a href="https://www.cplusplus.com/reference/istream/istream/operator%3E%3E/">æ–‡æ¡£</a>ä¹Ÿç»™å‡ºäº†è¯¦ç»†è¯´æ˜ï¼ˆå•¥éƒ½æ²¡å‘ç”Ÿå°±æ˜¯<code class="language-plaintext highlighter-rouge">goodbit</code>ï¼‰:</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111081445541.png" alt="image-20211108144549477" style="zoom:50%;" /></p>

<p>å½“å†…ç½®é”™è¯¯æ ‡å¿—ä¸º<code class="language-plaintext highlighter-rouge">fail</code>æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨C++åº“çš„ä»<code class="language-plaintext highlighter-rouge">istream object&amp;</code>åˆ°<code class="language-plaintext highlighter-rouge">bool</code>çš„éšå¼è½¬æ¢<code class="language-plaintext highlighter-rouge">ss &gt;&gt; ch</code>ä½œä¸º<code class="language-plaintext highlighter-rouge">!ss.fail()</code>çš„æ›¿ä»£:</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111102311395.png" alt="image-20211110231100308" style="zoom:50%;" /></p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111102311243.png" alt="image-20211110231116176" style="zoom:50%;" /></p>

<p>åœ¨æœ¬è¯¾çš„<code class="language-plaintext highlighter-rouge">stringToInteger</code>å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬è§åˆ°å¦‚ä¸‹ä½¿ç”¨æ–¹å¼ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">stringToInteger</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">istringstream</span> <span class="n">iss</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
    <span class="n">iss</span> <span class="o">&gt;&gt;</span> <span class="n">result</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"result: "</span> <span class="o">&lt;&lt;</span> <span class="n">result</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">iss</span><span class="p">.</span><span class="n">fail</span><span class="p">())</span>
        <span class="k">throw</span> <span class="n">domain_error</span><span class="p">(</span><span class="s">"error1"</span><span class="p">);</span>
    <span class="kt">char</span> <span class="n">remain</span><span class="p">;</span>
    <span class="n">iss</span> <span class="o">&gt;&gt;</span> <span class="n">remain</span><span class="p">;</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"remain: "</span> <span class="o">&lt;&lt;</span> <span class="n">remain</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iss</span><span class="p">.</span><span class="n">fail</span><span class="p">())</span>
        <span class="k">throw</span> <span class="n">domain_error</span><span class="p">(</span><span class="s">"error2"</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// case 1:</span>
<span class="c1">// result: 5, remain: l</span>
<span class="c1">// error2</span>
<span class="n">stringToInetger</span><span class="p">(</span><span class="s">"5lol"</span><span class="p">);</span>
<span class="c1">// case 2:</span>
<span class="c1">// result: 0</span>
<span class="c1">// error1</span>
<span class="n">stringToInteger</span><span class="p">(</span><span class="s">"lol"</span><span class="p">);</span>
</code></pre></div></div>

<p>ä¸ºä»€ä¹ˆä¼šå‡ºç°å¦‚ä¸Šçš„æƒ…å†µï¼Ÿè¿™è¦è€ƒè™‘åˆ°<code class="language-plaintext highlighter-rouge">&gt;&gt;</code>ç¬¬ä¸€ç§é‡è½½æ¨¡å¼ï¼Œå³ç”¨æ¥è¯»å–ç®—æœ¯ç±»å‹çš„å†…ç½®æ“ä½œï¼š</p>

<blockquote>
  <p>â€œExtracts and parses characters sequentially from the stream to interpret them as the representation of a value of the proper type, which is stored as the value of val.
Internally, the function accesses the input sequence by first constructing a <a href="https://www.cplusplus.com/istream::sentry">sentry</a> object (with noskipws set to <code class="language-plaintext highlighter-rouge">false</code>). Then (if <a href="https://www.cplusplus.com/ios::good">good</a>), it calls <a href="https://www.cplusplus.com/num_get::get">num_get::get</a> (using the streamâ€™s <em><a href="https://www.cplusplus.com/ios_base::getloc">selected locale</a></em>) to perform both the extraction and the parsing operations, adjusting the streamâ€™s <em><a href="https://www.cplusplus.com/basic_ios::rdstate">internal state flags</a></em> accordingly. Finally, it destroys the <a href="https://www.cplusplus.com/istream::sentry">sentry</a> object before returning.â€</p>
</blockquote>

<p>æ³¨æ„åˆ°æ­¤æ—¶åœ¨å†…éƒ¨æ˜¯ä½¿ç”¨äº†<code class="language-plaintext highlighter-rouge">num_get::get</code>æ–¹æ³•å¯¹æ•°å­—è¿›è¡Œè¯»å–çš„ï¼Œå¦‚æœæˆåŠŸè¯»å–ï¼ŒæŠŠç»“æœå­˜å‚¨åœ¨å‚æ•°<code class="language-plaintext highlighter-rouge">val</code>ä¸­ï¼Œå¹¶åˆ©ç”¨æ­¤å‡½æ•°æ›´æ–°<code class="language-plaintext highlighter-rouge">internal error flags</code>(åˆ©ç”¨ä¼ é€’ç»™<code class="language-plaintext highlighter-rouge">get</code>æ–¹æ³•çš„<code class="language-plaintext highlighter-rouge">ios_base::iostate&amp; err</code>å‚æ•°)ï¼š</p>

<blockquote>
  <ul>
    <li>
      <p>â€œThe function stops reading characters from the sequence as soon as one character cannot be part of a valid numerical expression (or end is reached). The next character in the sequence is pointed by the iterator returned by the function.â€</p>
    </li>
    <li>â€œ<em>Return value</em>: The next character in the sequence right after where the extraction operation ended.â€</li>
    <li><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111081615482.png" alt="image-20211108161553419" style="zoom:50%;" /></li>
  </ul>
</blockquote>

<p>å½“å°è¯•ä½¿ç”¨<code class="language-plaintext highlighter-rouge">int type</code>è¯»å…¥å­—ç¬¦ä¸²<code class="language-plaintext highlighter-rouge">"5lol"</code>æ—¶ï¼Œé¦–å…ˆ<code class="language-plaintext highlighter-rouge">num_get::get</code>æ–¹æ³•è¯»å–æ•°å­—5ï¼Œç”±äºä¸‹ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">char</code>ä¸æ˜¯<code class="language-plaintext highlighter-rouge">part of valid numerical expression</code>ï¼Œæ‰€ä»¥ä»–ç«‹å³åœæ­¢è¯»å–ï¼Œæ­¤æ—¶<code class="language-plaintext highlighter-rouge">val</code>çš„æ•°å€¼ä¸º<code class="language-plaintext highlighter-rouge">5</code>. æŒ‡é’ˆæŒ‡å‘<code class="language-plaintext highlighter-rouge">5</code>çš„ä¸‹ä¸€ä¸ªå­—ç¬¦<code class="language-plaintext highlighter-rouge">l</code>.</p>

<p>å½“å°è¯•ä½¿ç”¨<code class="language-plaintext highlighter-rouge">int type</code>è¯»å…¥å­—ç¬¦ä¸²<code class="language-plaintext highlighter-rouge">"lol"</code>æ—¶ï¼Œé¦–å…ˆ<code class="language-plaintext highlighter-rouge">num_get::get</code>æ–¹æ³•è¯»å–å­—ç¬¦<code class="language-plaintext highlighter-rouge">l</code>ï¼Œå‘ç°<code class="language-plaintext highlighter-rouge"> The sequence did not match the expected format</code>ï¼Œæ‰€ä»¥ä»–ç«‹å³åœæ­¢è¯»å–ï¼Œæ­¤æ—¶<code class="language-plaintext highlighter-rouge">val</code>çš„æ•°å€¼ä¸º<code class="language-plaintext highlighter-rouge">0</code>. æŒ‡é’ˆä»ç„¶æŒ‡å‘å¤´éƒ¨ï¼Œå¹¶è®¾ç½®äº†ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">failbit</code>ï¼Œäºæ˜¯å½“æˆ‘ä»¬è¿”å›åˆ°<code class="language-plaintext highlighter-rouge">&gt;&gt;</code>çš„å¤„ç†è¿‡ç¨‹ä¸­æ—¶ï¼Œå°±ä¼šæ˜¾ç¤º<code class="language-plaintext highlighter-rouge">fail()</code>äº†ï¼Œè¿™ä¹Ÿä¸<code class="language-plaintext highlighter-rouge">&gt;&gt;</code>äº§ç”Ÿ<code class="language-plaintext highlighter-rouge">failbit</code>çš„æ¡ä»¶å»åˆï¼Œå› ä¸ºæ­¤æ—¶ç›¸å½“äºæ²¡æœ‰æ–°çš„å­—ç¬¦è¢«æˆåŠŸæå–ï¼ŒåŒæ—¶<code class="language-plaintext highlighter-rouge">sb</code>æ­¤æ—¶ä¹Ÿæ˜¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">null pointer</code>.(å› ä¸ºæˆ‘ä»¬ç”¨çš„æ˜¯<code class="language-plaintext highlighter-rouge">int type</code>å¤„ç†)ã€‚å¹¶ä¸”<code class="language-plaintext highlighter-rouge">result</code>çš„è¾“å‡ºå€¼ä¸º<code class="language-plaintext highlighter-rouge">0</code>ï¼Œè¿™ä¹Ÿæ˜¯<code class="language-plaintext highlighter-rouge">num_get::get</code>æ–¹æ³•ä¸­<code class="language-plaintext highlighter-rouge">val</code>è¢«å­˜å‚¨çš„å€¼ã€‚</p>

<blockquote>
  <p>å¦‚æœæˆ‘ä»¬æŠŠç¬¬äºŒæ¬¡è¯»å–çš„ç±»å‹æ¢æˆ<code class="language-plaintext highlighter-rouge">double</code>ï¼Œå¹¶å°è¯•è¯»å…¥å­—ç¬¦ä¸²â€œ5.2â€æ—¶ï¼Œä¸ä¼šå‡ºç°ä»»ä½•é—®é¢˜ï¼Œå› ä¸ºåœ¨ç¬¬ä¸€æ¬¡è¯»å–<code class="language-plaintext highlighter-rouge">5</code>ä¹‹åï¼Œåºåˆ—ä¸­ä½™ä¸‹çš„<code class="language-plaintext highlighter-rouge">.2</code>è¢«ç¨‹åºç†è§£ä¸º<code class="language-plaintext highlighter-rouge">0.2</code>ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬ç¬¬äºŒæ¬¡è¯»å–è¾“å‡ºçš„ç»“æœã€‚</p>
</blockquote>

<h4 id="white-space-separating">white space separatingï¼Ÿ</h4>

<p>ä¸ºä»€ä¹ˆä½¿ç”¨<code class="language-plaintext highlighter-rouge">stringstream</code>ä¹‹å<code class="language-plaintext highlighter-rouge">istream &gt;&gt; string</code>è¯»å–å­—ç¬¦ä¸²èƒ½å¤Ÿè‡ªåŠ¨ä»¥ç©ºç™½å­—ç¬¦ä½œä¸ºåˆ†å‰²ï¼Ÿ</p>

<p>è¿™æ˜¯å› ä¸º<code class="language-plaintext highlighter-rouge">string</code>ç±»æœ¬èº«ä¹Ÿå¯¹<code class="language-plaintext highlighter-rouge">extraction operator</code>è¿›è¡Œäº†é‡è½½ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">istream</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">istream</span><span class="o">&amp;</span> <span class="n">is</span><span class="p">,</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">);</span>
</code></pre></div></div>

<p>æŒ‰ç…§<em>StackOverflow</em>çš„è¯´æ³•ï¼Œè¯¥å‡½æ•°çš„å®ç°ç±»ä¼¼äº<strong>C</strong>ä¸­çš„<em>scanf %s</em>ï¼Œä»–ä¼šæŒç»­è¯»å–ç›´åˆ°é‡åˆ°ç©ºç™½å­—ç¬¦ï¼ˆåŒ…æ‹¬ç©ºæ ¼ã€tabç­‰ï¼‰ä¸‹ä¸€æ¬¡ä»ç©ºç™½å­—ç¬¦å¼€å§‹è¯»å–ï¼ˆä½†æ˜¯é»˜è®¤ä¼š<code class="language-plaintext highlighter-rouge">skipws</code>ï¼‰ã€‚åœ¨å®˜æ–¹<a href="https://www.cplusplus.com/reference/string/string/operator%3E%3E/">æ–‡æ¡£</a>ä¸­ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†ä¾æ®ï¼š</p>

<blockquote>
  <p>Notice that the <a href="https://www.cplusplus.com/istream">istream</a> extraction operations use whitespaces as separators; Therefore, this operation will only extract what can be considered a word from the stream. To extract entire lines of text, see the <a href="https://www.cplusplus.com/string">string</a> overload of global function <a href="https://www.cplusplus.com/string:getline">getline</a>.</p>

  <p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111100156520.png" alt="image-20211110015649451" style="zoom:50%;" /></p>
</blockquote>

<p>ä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬ä½¿ç”¨<code class="language-plaintext highlighter-rouge">&gt;&gt;</code>å°†æ•°æ®è¯»å…¥å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆä»–ä¼šå°è¯•ç€ä¸€ä¸ªå•è¯ä¸€ä¸ªå•è¯åœ°è¯»å–ã€‚è¯¥è¿‡ç¨‹çš„å®ç°ä¹Ÿæ˜¯å€ŸåŠ©äºä¸€ä¸ªç”±æŒ‡é’ˆ<code class="language-plaintext highlighter-rouge">sb</code>æŒ‡å‘çš„<code class="language-plaintext highlighter-rouge">streambuf object</code>ï¼Œæ¯æ¬¡æˆ‘ä»¬éƒ½åœ¨å‘è¯¥<code class="language-plaintext highlighter-rouge">streambuf</code>å†™å…¥æ•°æ®ï¼Œåœ¨å‘<code class="language-plaintext highlighter-rouge">streambuf</code>å†™å…¥å®Œæ¯•ä¹‹åï¼Œå°†<code class="language-plaintext highlighter-rouge">streambuf object</code>ä¸­çš„å†…å®¹å†™ç»™<code class="language-plaintext highlighter-rouge">string</code>å¯¹è±¡ã€‚<strong>æ‰€æœ‰çš„streamå¯¹è±¡ï¼Œéƒ½æœ‰ä¸€ä¸ªä¸ä¹‹å…³è”çš„<code class="language-plaintext highlighter-rouge">streambuf object</code></strong>.</p>

<h4 id="againabout-whitespaces">Againâ€“About Whitespaces!</h4>

<p>ä¸‹è¾¹æ¥çœ‹è¿™æ ·ä¸¤ä¸ªä¾‹å­ï¼š</p>

<ol>
  <li>
    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">string</span> <span class="n">a</span> <span class="o">=</span> <span class="s">" 12 3"</span><span class="p">;</span>
<span class="n">stringstream</span> <span class="nf">iss</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="kt">char</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
<span class="n">iss</span> <span class="o">&gt;&gt;</span> <span class="n">std</span><span class="o">::</span><span class="n">noskipws</span> <span class="o">&gt;&gt;</span> <span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="n">c</span><span class="p">;</span>
<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"b: "</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="s">" c: "</span> <span class="o">&lt;&lt;</span> <span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="c1">// result: b:  c: 1</span>
</code></pre></div>    </div>

    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">string</span> <span class="n">a</span> <span class="o">=</span> <span class="s">" 12 3"</span><span class="p">;</span>
<span class="n">stringstream</span> <span class="nf">iss</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="kt">char</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
<span class="n">iss</span> <span class="o">&gt;&gt;</span> <span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="n">c</span><span class="p">;</span>
<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"b: "</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="s">" c: "</span> <span class="o">&lt;&lt;</span> <span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="c1">// result: b:1  c: 2</span>
</code></pre></div>    </div>
  </li>
  <li>
    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">string</span> <span class="n">a</span> <span class="o">=</span> <span class="s">" 12 3"</span><span class="p">;</span>
<span class="n">stringstream</span> <span class="nf">iss</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="n">string</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
<span class="n">iss</span> <span class="o">&gt;&gt;</span> <span class="n">std</span><span class="o">::</span><span class="n">noskipws</span> <span class="o">&gt;&gt;</span> <span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="n">c</span><span class="p">;</span>
<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"b: "</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="s">" c: "</span> <span class="o">&lt;&lt;</span> <span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="c1">// result: b:  c: </span>
</code></pre></div>    </div>

    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">string</span> <span class="n">a</span> <span class="o">=</span> <span class="s">" 12 3"</span><span class="p">;</span>
<span class="n">stringstream</span> <span class="nf">iss</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="n">string</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
<span class="n">iss</span> <span class="o">&gt;&gt;</span> <span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="n">c</span><span class="p">;</span>
<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"b: "</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="s">" c: "</span> <span class="o">&lt;&lt;</span> <span class="n">c</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="c1">// result: b: 12 c: 3</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>è¿™ä¸¤ä¸ªä¾‹å­ä¸­å”¯ä¸€çš„åŒºåˆ«å°±æ˜¯ç¬¬ä¸€ä¸ªæˆ‘ä»¬æä¾›äº†<code class="language-plaintext highlighter-rouge">char</code>ç±»å‹ï¼Œè€Œç¬¬äºŒä¸ªæ˜¯<code class="language-plaintext highlighter-rouge">string</code>ç±»å‹ã€‚é¦–å…ˆæˆ‘ä»¬ä¸å»å…³æ³¨ä»£ç ä¸­çš„<code class="language-plaintext highlighter-rouge">noskipws</code>ï¼Œçœ‹ç¬¬äºŒä¸ªä¾‹å­ï¼Œå³<code class="language-plaintext highlighter-rouge">string</code>çš„é‚£ä¸€ä¸ªï¼šæ ¹æ®ä¸Šä¸€èŠ‚çš„æè¿°ï¼Œå½“<code class="language-plaintext highlighter-rouge">istream &gt;&gt; string</code>é‡åˆ°äº†<strong>ç©ºç™½å­—ç¬¦</strong>æ—¶ï¼Œä»–ä¼šåœæ­¢è¯»å–ï¼Œè€Œæ°å¥½ï¼Œåœ¨å­—ç¬¦ä¸²<code class="language-plaintext highlighter-rouge">a</code>çš„æœ€å‰è¾¹å­˜åœ¨ä¸€ä¸ª<strong>ç©ºç™½å­—ç¬¦</strong>ï¼Œæ‰€ä»¥æˆ‘ä»¬æƒ³å®ƒåº”è¯¥ä¼šç›´æ¥åœ¨å¼€å¤´å¤„åœæ­¢ï¼Œä¸ä¼šè¯»å–åˆ°ä»»ä½•ä¸œè¥¿ï¼Œæ‰€ä»¥æœ€åè¿”å›çš„æ˜¯ç©ºå­—ç¬¦ä¸²ã€‚</p>

<p>ä½†æ˜¯æˆ‘ä»¬å‘ç°å¦‚æœå°è¯•å°†ä»£ç ä¸­çš„<code class="language-plaintext highlighter-rouge">std::noskipws</code>å»æ‰ï¼Œé‚£ä¹ˆè¿”å›çš„ç»“æœä¼šä¸ä¹‹å‰ä¸åŒï¼Œè¿™åˆæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>

<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦äº†è§£è¿ç®—ç¬¦<code class="language-plaintext highlighter-rouge">&gt;&gt;</code>é‡è½½çš„ç¬¬ä¸‰ç§ç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">manipulators</code>ã€‚</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111081624307.png" alt="image-20211108162408233" style="zoom:50%;" /></p>

<p>æ³¨æ„åˆ°<code class="language-plaintext highlighter-rouge">skipws/noskipws</code>è¿™ç§ç±»å‹ï¼Œå½“<code class="language-plaintext highlighter-rouge">skipws</code>è¢«è®¾ç½®æ—¶ï¼Œ<code class="language-plaintext highlighter-rouge">stream</code>é»˜è®¤ä¼šå¿½è§†æ‰€æœ‰çš„ç©ºç™½å­—ç¬¦ï¼Œ<a href="https://www.cplusplus.com/reference/ios/skipws/">æ–‡æ¡£</a>ä¸­æåˆ°ï¼š</p>

<blockquote>
  <p>â€œFor standard streams, the skipws flag <strong>is set</strong> on initialization.â€</p>
</blockquote>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹åˆå§‹åŒ–çš„ç»“æœä¸ºè®¾ç½®äº†<code class="language-plaintext highlighter-rouge">skipws</code>ï¼Œæ‰€ä»¥æ‰€æœ‰ç©ºç™½å­—ç¬¦éƒ½ä¼šè¢«è¯»å–ä¹‹åè·³è¿‡ï¼Œç›´åˆ°æˆ‘ä»¬åˆå‘ç°äº†ä¸€ä¸ª<strong>éç©ºç™½å­—ç¬¦</strong>ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œä¸Šè¾¹ä¾‹å­çš„ç»“æœå°±å¥½ç†è§£äº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨C++ä¸­ï¼Œå¯¹äºæ‰€æœ‰çš„<code class="language-plaintext highlighter-rouge">formatted input</code>ï¼ˆå³å¯ä»¥æ ¼å¼åŒ–æˆæˆ‘ä»¬éœ€è¦çš„ç±»å‹çš„ï¼Œæ¯”å¦‚Cä¸­çš„<code class="language-plaintext highlighter-rouge">prinf, scanf</code>ï¼ŒC++ä¸­ä½¿ç”¨<code class="language-plaintext highlighter-rouge">&gt;&gt;</code>æ“ä½œçš„ï¼‰ï¼Œé»˜è®¤éƒ½æ˜¯<code class="language-plaintext highlighter-rouge">noskipws=false</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼š<strong>è·³è¿‡ç©ºç™½å­—ç¬¦</strong>ï¼›è€Œå¯¹äºæ‰€æœ‰çš„<code class="language-plaintext highlighter-rouge">unformatted input</code>ï¼ˆæ¯”å¦‚<code class="language-plaintext highlighter-rouge">getchar(char), getline(string)</code>ï¼‰å‡è®¾ç½®ä¸º<code class="language-plaintext highlighter-rouge">noskipws=true</code>ã€‚</p>

<blockquote>
  <p>å…³äºæ ¼å¼åŒ–è¾“å…¥ä¸éæ ¼å¼åŒ–è¾“å…¥ï¼Œæˆ‘æ˜¯è¿™ä¹ˆç†è§£çš„ï¼Œæ ¼å¼åŒ–è¾“å…¥æ„å‘³ç€æˆ‘ä»¬å¯ä»¥æŠŠè¾“å…¥çš„æ•°æ®å˜æˆæˆ‘ä»¬æƒ³è¦çš„ç±»å‹ï¼Œæ¯”å¦‚å½“æˆ‘ä»¬ä½¿ç”¨<code class="language-plaintext highlighter-rouge">&gt;&gt;</code>æ“ä½œç¬¦æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è¯»å…¥æ•´å‹ï¼Œä¹Ÿå¯ä»¥è¯»å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ï¼›ä½†æ˜¯éæ ¼å¼åŒ–è¾“å…¥åªèƒ½è¯»å…¥<code class="language-plaintext highlighter-rouge">rawText type</code>ï¼Œå¥½æ¯”<code class="language-plaintext highlighter-rouge">geline(string)</code>æˆ‘ä»¬è¾“å…¥äº†ä¸€ä¸ªå­—ç¬¦ä¸²é‚£ä¹ˆæ¥å—ç±»å‹å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸².</p>
</blockquote>

<p>åŒæ—¶ï¼Œ<code class="language-plaintext highlighter-rouge">skipws</code>ä¸<code class="language-plaintext highlighter-rouge">noskipws</code>ä¸¤è€…æ˜¯<code class="language-plaintext highlighter-rouge">sticky</code>çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åªæœ‰é‡æ–°è®¾ç½®ï¼Œæ‰èƒ½å˜å›åŸæ¥çš„çŠ¶æ€ã€‚å¦‚æœæƒ³è¦æ¯ä¸€æ­¥éƒ½å¯ä»¥è®¾ç½®æ˜¯å¦ä¿ç•™<strong>ç©ºç™½å­—ç¬¦</strong>ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">std::ws</code>ï¼Œæå–<strong>ç©ºç™½å­—ç¬¦</strong>ï¼Œç›´åˆ°é‡åˆ°<strong>éç©ºç™½å­—ç¬¦</strong>ã€‚</p>

<blockquote>
  <p>è®¾ç½®<code class="language-plaintext highlighter-rouge">skipws</code>ç­‰çš„æ­¥éª¤æ˜¯åœ¨ä¸ºè¾“å…¥åºåˆ—åˆ›å»º<code class="language-plaintext highlighter-rouge">sentry</code>å¯¹è±¡æ—¶è¿›è¡Œçš„.</p>
</blockquote>

<p>é™¤äº†ä¸Šè¿°æåˆ°çš„<code class="language-plaintext highlighter-rouge">skipws</code>è¿™ç§<code class="language-plaintext highlighter-rouge">manipulator</code>ä¹‹å¤–ï¼Œå¸¸è§çš„å¯ä»¥ç”¨äº<code class="language-plaintext highlighter-rouge">pad output</code>çš„è¿˜æœ‰ï¼š<code class="language-plaintext highlighter-rouge">left/right/internal</code>, <code class="language-plaintext highlighter-rouge">setw</code>, <code class="language-plaintext highlighter-rouge">setfill</code>ç­‰ï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111091756123.png" alt="image-20211109175615973" style="zoom:50%;" /></p>

<p>è¿™å‡ ä¸ª<code class="language-plaintext highlighter-rouge">manipulator</code>åœ¨å†…éƒ¨è°ƒç”¨äº†å†…ç½®çš„ä¸€äº›æ–¹æ³•ï¼Œæ¯”å¦‚<code class="language-plaintext highlighter-rouge">setfill</code>æ˜¯è°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">basic::ios::fill(char_type)</code>ï¼Œ<code class="language-plaintext highlighter-rouge">left</code>æ˜¯è®¾ç½®äº†åä¸º<code class="language-plaintext highlighter-rouge">adjustfiled</code>çš„<code class="language-plaintext highlighter-rouge">flag value</code>ï¼Œ<code class="language-plaintext highlighter-rouge">setw</code>åˆ™å’Œä½¿ç”¨<code class="language-plaintext highlighter-rouge">width(n)</code>çš„æ•ˆæœç›¸åŒï¼Œè®¾ç½®äº†<code class="language-plaintext highlighter-rouge">field width</code>â€“æ‰€ä»¥è¯¥å‡½æ•°æŒ‡å®šçš„æ˜¯è¾“å‡ºåºåˆ—ä¸­å…è®¸å­˜åœ¨çš„<strong>æœ€å°‘çš„å­—ç¬¦æ•°</strong>ã€‚</p>

<h4 id="set-position">set position</h4>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111081358479.png" alt="image-20211108135808429" style="zoom:50%;" /></p>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨<code class="language-plaintext highlighter-rouge">streamoff</code>ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">n</code>çš„å€¼å¯æ­£å¯è´Ÿã€‚å¸¸è§çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fpos</span> <span class="o">=</span> <span class="n">oss</span><span class="p">.</span><span class="n">tellp</span><span class="p">()</span> <span class="o">+</span> <span class="n">streamoff</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="n">oss</span><span class="p">.</span><span class="n">seekp</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
<span class="c1">// or</span>
<span class="n">oss</span><span class="p">.</span><span class="n">seekp</span><span class="p">(</span><span class="n">streamoff</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">stringstream</span><span class="o">::</span><span class="n">cur</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="cin--cout">cin &amp; cout</h3>

<p>ç”±äº<code class="language-plaintext highlighter-rouge">cin</code>å®é™…ä¸Šæ˜¯ä¸€ç§<code class="language-plaintext highlighter-rouge">istream object</code>ï¼Œæœ‰äº›ç‰¹æ€§ä¸Šè¾¹ä¸€èŠ‚å·²ç»æ€»ç»“çš„å·®ä¸å¤šäº†â€¦è¿™é‡Œåªæ€»ç»“ä¸¤ç‚¹ï¼š</p>

<ol>
  <li>ä¸ºä»€ä¹ˆæ˜æ˜è¾“å…¥æµé»˜è®¤è®¾ç½®<code class="language-plaintext highlighter-rouge">skipws</code>ï¼Œä½†æ˜¯æˆ‘ä»¬è¾“å…¥ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">\n</code>æ—¶ï¼Œ<code class="language-plaintext highlighter-rouge">console</code>å†…ä»ç„¶ä¼šæ‰“å°å‡ºæ–°çš„ä¸€è¡Œï¼Ÿ</li>
</ol>

<p>è¿™æ˜¯å› ä¸ºæ§åˆ¶å°å†…çš„æ‰“å°æ˜¯ç”±<code class="language-plaintext highlighter-rouge">consle software</code>æ§åˆ¶çš„ï¼Œä¸<code class="language-plaintext highlighter-rouge">cin</code>æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚</p>

<ol>
  <li>cin is <em><a href="https://www.cplusplus.com/ios::tie">tied</a></em> to the standard output stream <a href="https://www.cplusplus.com/cout">cout</a> (see <a href="https://www.cplusplus.com/ios::tie">ios::tie</a>), which indicates that <a href="https://www.cplusplus.com/cout">cout</a>â€™s buffer is <em>flushed</em> (see <a href="https://www.cplusplus.com/ostream::flush">ostream::flush</a>) before each i/o operation performed on cin.</li>
</ol>

<blockquote>
  <p>The tied stream is an output stream object which is <em><a href="https://www.cplusplus.com/ostream::flush">flushed</a></em> before each i/o operation in this stream object.</p>
</blockquote>

<p>æˆ‘ä»¬å¸¸ç”¨çš„<code class="language-plaintext highlighter-rouge">std::endl</code>å°±æ˜¯<strong>æ¢è¡Œ+åˆ·æ–°è¾“å‡ºç¼“å†²åŒº</strong>ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬ä»…ä»…ä½¿ç”¨<code class="language-plaintext highlighter-rouge">cout</code>è€Œä¸æ·»åŠ <code class="language-plaintext highlighter-rouge">endl</code>ï¼Œå­—ç¬¦ä¼šé¦–å…ˆå­˜åˆ°<code class="language-plaintext highlighter-rouge">output buffer</code>ä¸­ï¼Œ<strong>åªæœ‰å½“<code class="language-plaintext highlighter-rouge">output buffer</code>æ»¡äº†æˆ–è€…ç¨‹åºç»ˆæ­¢æ—¶ï¼Œæ‰ä¼šè°ƒç”¨<code class="language-plaintext highlighter-rouge">flush</code>æ–¹æ³•</strong>ã€‚</p>

<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œ<code class="language-plaintext highlighter-rouge">std::flush</code>æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ<a href="https://stackoverflow.com/questions/14105650/how-does-stdflush-work">è¿™é‡Œ</a>ç»™å‡ºäº†è¾ƒä¸ºè¯¦ç»†çš„è§£ç­”ã€‚</p>

<p>è¨€ç®€æ„èµ…åœ°è¯´ï¼Œ<code class="language-plaintext highlighter-rouge">ostream::flush()</code>ä¼šåœ¨å†…éƒ¨è°ƒç”¨<code class="language-plaintext highlighter-rouge">streambuf::pubsync()</code>æ–¹æ³•ï¼Œå¯¹æµç¼“å†²åŒºè¿›è¡Œæ“ä½œï¼›æµç¼“å†²åŒºçš„ä½œç”¨æ˜¯è´Ÿè´£â€œç¼“å†²â€å­—ç¬¦å¹¶æŠŠæ•°æ®å‘é€ç»™å¤–éƒ¨ç›®çš„åœ°â€“è¿™å‘ç”Ÿåœ¨ç¼“å†²åŒºå·²æ»¡æˆ–è€…å†…éƒ¨æ•°æ®<strong>åº”å½“</strong>ä¸å¤–éƒ¨ç›®çš„åœ°è¿›è¡Œ<strong>åŒæ­¥</strong>çš„æ—¶å€™ï¼ˆæ¯”å¦‚<code class="language-plaintext highlighter-rouge">flush()</code>ï¼‰ã€‚å½“éœ€è¦åŒæ­¥æ—¶ï¼Œç¼“å†²åŒºå†…éƒ¨çš„æ•°æ®ç«‹å³å‘é€ç»™å¤–éƒ¨ç›®çš„åœ°ï¼Œæ ¹æ®å®˜æ–¹<a href="https://www.cplusplus.com/reference/ostream/ostream/flush/">æ–‡æ¡£</a>ï¼š</p>

<blockquote>
  <p>For <em><a href="https://www.cplusplus.com/streambuf">stream buffer</a></em> objects that implement intermediate buffers, this function requests all characters to be written to the controlled sequence.</p>
</blockquote>

<p>è¿™æ„å‘³ç€ï¼Œå¦‚æœæˆ‘ä»¬æ­£åœ¨å°è¯•æŠŠæ•°æ®è¾“å‡ºåˆ°æ§åˆ¶å°ä¸Šï¼Œé‚£ä¹ˆæ­¤æ“ä½œä¼šç«‹å³æŠŠç¼“å†²åŒºå†…ç›®å‰æ‰€æœ‰çš„å­—ç¬¦è¾“å‡ºè¾“å‡ºæµä¸­ï¼Œå†æ˜¾ç¤ºåˆ°æ§åˆ¶å°ç•Œé¢ä¸Šï¼Œè¿™æ„å‘³ç€æ¸…ç©ºäº†<code class="language-plaintext highlighter-rouge">stream buffer</code>ã€‚å¯¹äºæ–‡ä»¶æµæ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡å¤–éƒ¨ç›®çš„åœ°æ¢æˆäº†<strong>æ–‡ä»¶</strong>è€Œå·²ã€‚</p>

<p>æ‰€ä»¥ä½•æ—¶éœ€è¦è¿›è¡Œ<code class="language-plaintext highlighter-rouge">flush</code>æ“ä½œå‘¢ï¼Ÿå½“ç„¶æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥æœ‰å¯èƒ½éœ€è¦å‘å¤–éƒ¨ç›®çš„åœ°å†™å…¥æ•°æ®çš„æ—¶å€™ï¼Œå› ä¸ºå¦‚æœæ­¤æ—¶ç¼“å†²åŒºå†…è¿˜å­˜æœ‰å…ˆå‰çš„æ•°æ®ï¼Œé‚£æ¯«æ— ç–‘é—®çš„ä¼šé€ æˆå½±å“ï¼</p>

<ol>
  <li>å¦‚æœæˆ‘ä»¬æ³¨æ„åœ¨è¾“å…¥è¿‡ç¨‹ä¸­<code class="language-plaintext highlighter-rouge">internal error flag</code>çš„å˜åŒ–ï¼Œåˆ™åœ¨æ¯æ¬¡<code class="language-plaintext highlighter-rouge">flush</code>ä¹‹åï¼Œä»¥åŠæ¯æ¬¡<code class="language-plaintext highlighter-rouge">cin</code>è¯»å–å®Œæ•°æ®åï¼Œå†…ç½®é”™è¯¯æ ‡å¿—ä½éƒ½ä¼šè¢«è®¾ç½®æˆ<code class="language-plaintext highlighter-rouge">eof</code>. å› ä¸ºè¾“å…¥æµæ„è¯†åˆ°è‡ªå·±è¯»åˆ°äº†å­—ç¬¦ä¸²çš„æœ«å°¾ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœåœ¨è¾“å…¥è¿‡ç¨‹ä¸­ï¼Œæ ‡å¿—ä½åœ¨æŸä¸€åˆ»è¢«è®¾ç½®æˆ<code class="language-plaintext highlighter-rouge">fail</code>ï¼Œé‚£ä¹ˆæ­¤åçš„æ‰€æœ‰å°è¯•è¾“å…¥çš„æ“ä½œå‡ä¼šå¤±æ•ˆï¼Œè¿™ä¸€ç‚¹æˆ‘ä»¬åœ¨å‰è¾¹æåˆ°è¿‡ï¼Œå¿…é¡»ä½¿ç”¨<code class="language-plaintext highlighter-rouge">clear()</code>æ¸…ç©ºçŠ¶æ€æ‰å¯ä»¥ç»§ç»­è¿›è¡Œã€‚</li>
</ol>

<h4 id="ignore">ignore</h4>

<p>å‡½æ•°åŸå‹ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">istream</span><span class="o">&amp;</span> <span class="n">ignore</span> <span class="p">(</span><span class="n">streamsize</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delim</span> <span class="o">=</span> <span class="n">EOF</span><span class="p">);</span>
</code></pre></div></div>

<p>æ³¨æ„åˆ°è¿™ç§ç‰¹æ®Šçš„ä½¿ç”¨æ–¹æ³•ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿½ç•¥æ‰å½“å‰<code class="language-plaintext highlighter-rouge">stream buffer</code>ä¸­æ‰€æœ‰çš„æ•°æ®ï¼Œç›´åˆ°<strong>eof</strong>ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">con</span><span class="p">.</span><span class="n">ignore</span><span class="p">(</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">streamsize</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">(),</span> <span class="err">â€˜\</span><span class="n">n</span><span class="err">â€™</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="getlinestring">getline(string)</h3>

<p>è¯¥å‡½æ•°å¸¸è¢«ç”¨æ¥è¯»å–ä¸€æ•´è¡Œçš„æ•°æ®ï¼Œæˆ–è€…æŒ‰ç…§<code class="language-plaintext highlighter-rouge">delimiters</code>åˆ†å‰²æ•°æ®ï¼›è¿™æ˜¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">unformatted input function</code>ï¼Œæ ¹æ®å‰å‡ èŠ‚æ‰€å±çš„ç‰¹ç‚¹ï¼Œéæ ¼å¼åŒ–è¾“å…¥å‡½æ•°é»˜è®¤è®¾ç½®<code class="language-plaintext highlighter-rouge">noskipws</code>ï¼Œé‚£ä¹ˆå½“é‡åˆ°åˆ†å‰²å­—ç¬¦æ—¶ï¼Œå®ƒçš„å¤„ç†æ–¹æ³•æ˜¯ï¼š</p>

<blockquote>
  <p>If the delimiter is found, it is extracted and discarded (i.e. it is not stored and the next input operation will begin after it).</p>
</blockquote>

<p>åŒæ ·çš„ï¼Œè¯¥å‡½æ•°ä¹Ÿä¼šå¯¹<code class="language-plaintext highlighter-rouge">internal error flags</code>è¿›è¡Œè®¾ç½®ã€‚</p>

<p>åœ¨æ–‡ä»¶è¯»å–ä¸­ï¼Œå¦‚æœæˆ‘ä»¬è¯»åˆ°äº†æ–‡ä»¶æœ«å°¾ï¼Œé‚£ä¹ˆ<code class="language-plaintext highlighter-rouge">getline</code>ä¼šè®¾ç½®ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">eofbit</code>ï¼Œä½†æ˜¯æ­¤æ—¶å¹¶ä¸ä¼šè®¾ç½®<code class="language-plaintext highlighter-rouge">failbit</code>ï¼Œè€Œåœ¨ç»§ç»­çš„ä¸‹ä¸€æ¬¡è¯»å–ä¸­ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰è¯»å–åˆ°ä»»ä½•å†…å®¹ï¼Œ<strong>æ ¹æ®failbit</strong>çš„å®šä¹‰ï¼Œ<code class="language-plaintext highlighter-rouge">sentry object</code>ä¼šç½®ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">failbit</code>ï¼Œå€ŸåŠ©è¿™ä¸€ç‰¹ç‚¹ï¼Œæˆ‘ä»¬åœ¨å®é™…ä½¿ç”¨ä¸­å¸¸æŠŠè¯»å–å¾ªç¯å†™ä½œå¦‚ä¸‹å½¢å¼è€Œé<code class="language-plaintext highlighter-rouge">while(!input.fail())</code>ï¼Œè¿›è€Œé¿å…å‘æ•°æ®ç»“æ„ä¸­è¾“å…¥æœ€åä¸€æ¬¡è¯»å–çš„<code class="language-plaintext highlighter-rouge">garbage value</code>ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ifstream</span> <span class="nf">file</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
<span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">string</span> <span class="n">line</span><span class="p">;</span>
    <span class="n">getline</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="n">fail</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// process the read data</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨<code class="language-plaintext highlighter-rouge">char*(c-string)</code>ååŠ ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">s</code>å­—æ¯çš„æ–¹å¼ï¼Œå°†å…¶è½¬åŒ–ä¸º<code class="language-plaintext highlighter-rouge">C++ string</code></p>
</blockquote>

<h2 id="type-deduction">type deduction</h2>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111091508689.png" alt="image-20211109150854609" style="zoom:50%;" /></p>

<h2 id="structure">structure</h2>

<h3 id="pair">pair</h3>

<p>åœ¨C++ä¸­ï¼Œä¼ ç»Ÿçš„è¿”å›å¤šä¸ªå€¼çš„æ–¹æ³•æ˜¯ä½¿ç”¨<code class="language-plaintext highlighter-rouge">reference parameters</code>ï¼Œä½†é—®é¢˜åœ¨äºé™¤éæˆ‘ä»¬æŸ¥çœ‹å‡½æ•°å®šä¹‰ï¼Œå¦åˆ™å¼•ç”¨å‚æ•°å¹¶ä¸æ˜æ˜¾ã€‚åœ¨C++11ä¸­æä¾›äº†<code class="language-plaintext highlighter-rouge">pair</code>æˆ–è€…<code class="language-plaintext highlighter-rouge">tuple</code>ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»–ä»¬ç»„åˆå¤šä¸ªè¿”å›å€¼ï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111091512437.png" alt="image-20211109151222334" style="zoom:50%;" /></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">f</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">p</span><span class="p">.</span><span class="n">second</span><span class="p">,</span> <span class="n">p</span><span class="p">.</span><span class="n">first</span><span class="p">};</span> <span class="c1">// list-initialization in return statement</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="tuple">tuple</h3>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111091657348.png" alt="image-20211109165717288" style="zoom:50%;" /></p>

<h3 id="structured-binding">structured binding</h3>

<p>åœ¨C++17ä¸­ï¼Œä¸Pythonç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥åš<code class="language-plaintext highlighter-rouge">unpack</code>ï¼ˆ<code class="language-plaintext highlighter-rouge">structured binding</code>ï¼‰ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="p">[</span><span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">]</span> <span class="o">=</span> <span class="n">findPriceRange</span><span class="p">(</span><span class="n">dist</span><span class="p">);</span>
</code></pre></div></div>

<p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨ç»“æ„ä½“ä½œä¸ºä»¥ä¸Šå‡½æ•°çš„è¿”å›å€¼ï¼Œé‚£ä¹ˆ<code class="language-plaintext highlighter-rouge">structured binding</code>ä»ç„¶å¯ä»¥ä½¿ç”¨ã€‚</p>

<p>æˆ‘ä»¬è¿˜å¯ä»¥å¯¹å¼•ç”¨ä½¿ç”¨<code class="language-plaintext highlighter-rouge">structured binding</code>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">transformToDST</span><span class="p">(</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Course</span><span class="o">&gt;&amp;</span> <span class="n">courses</span><span class="p">)</span> <span class="p">{</span> 
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span><span class="n">code</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">instructors</span><span class="p">]</span> <span class="o">:</span> <span class="n">courses</span><span class="p">)</span> <span class="p">{</span> 
        <span class="n">start</span><span class="o">++</span><span class="p">;</span> 
        <span class="n">end</span><span class="o">++</span><span class="p">;</span> 
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">print_map</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string_view</span> <span class="n">comment</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">comment</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">]</span> <span class="o">:</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">key</span> <span class="o">&lt;&lt;</span> <span class="s">" = "</span> <span class="o">&lt;&lt;</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="s">"; "</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="aggregate-initialization">Aggregate initialization</h3>

<p>éšç€C++æ ‡å‡†çš„ä¸æ–­æ›´æ–°ï¼Œåˆå§‹åŒ–çš„æ–¹å¼æ„ˆå‘å¤šæ ·åŒ–ã€‚<code class="language-plaintext highlighter-rouge">aggregate initialization</code>æ˜¯ä¸€ç§<code class="language-plaintext highlighter-rouge">list-initilization</code>ï¼Œåœ¨<strong>C++20</strong>ä¸­ä¹Ÿè¢«å«åš<code class="language-plaintext highlighter-rouge">direct initialization</code>. ä»–åº”ç”¨äº<code class="language-plaintext highlighter-rouge">arrays</code>ä»¥åŠ<code class="language-plaintext highlighter-rouge">class type</code>ï¼Œæ¯”å¦‚<strong>ç»“æ„ä½“</strong>æˆ–è€…<strong>è”åˆ</strong>ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨æ—¶æœ‰ä¸€äº›ç‰¹æ®Šè¦æ±‚ï¼Œå¯å‚è§<a href="https://en.cppreference.com/w/cpp/language/aggregate_initialization">æ–‡æ¡£</a>ã€‚</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111111743654.png" alt="image-20211111174324498" style="zoom:50%;" /></p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111091539422.png" alt="image-20211109153853532" style="zoom:50%;" /></p>

<blockquote>
  <p>è¿™é‡Œçš„<code class="language-plaintext highlighter-rouge">course</code>æ˜¯ä¸€ä¸ªç»“æ„ä½“</p>
</blockquote>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“ä½¿ç”¨<code class="language-plaintext highlighter-rouge">uniform initialization</code>ï¼ˆç›®å‰æˆ‘å°†è¿™ä¸¤è€…ç†è§£ä¸ºç›¸åŒçš„ä¸œè¥¿â€¦â€¦ï¼‰æ—¶ï¼Œå¯¹è±¡ä¼šé¦–å…ˆå°è¯•ä½¿ç”¨<code class="language-plaintext highlighter-rouge">initilizer list constructor</code>è€Œéæ™®é€šçš„æ„é€ å‡½æ•°ï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111091548990.png" alt="image-20211109154855889" style="zoom:33%;" /></p>

<p>å¦ä¸€ä¸ªä½¿ç”¨<code class="language-plaintext highlighter-rouge">uniform intialization</code>çš„ä¾‹å­æ˜¯æˆ‘ä»¬å°†è¦åˆå§‹åŒ–ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">std::pair</code>ï¼šæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä½¿ç”¨<code class="language-plaintext highlighter-rouge">{}</code>è¯­æ³•åˆå§‹åŒ–æ‰€æœ‰éƒ¨åˆ†ï¼Œæˆ–è€…åˆå§‹åŒ–ä¸€éƒ¨åˆ†ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">foo</span><span class="p">({</span> <span class="p">{},</span> <span class="p">{}</span> <span class="p">});</span> <span class="c1">// OK: call default constructor on both parts</span>
<span class="n">foo</span><span class="p">({</span> <span class="n">key</span><span class="p">,</span> <span class="p">{}</span> <span class="p">});</span> <span class="c1">// OK: call defualt constructor on the second part</span>
<span class="n">foo</span><span class="p">({</span> <span class="n">key1</span><span class="p">,</span> <span class="n">key2</span> <span class="p">});</span> <span class="c1">// OK</span>
</code></pre></div></div>

<p>ä¸‹è¾¹æ ¹æ®æ–‡æ¡£è¯´ä¸€äº›æ¯”è¾ƒç»†èŠ‚çš„å†…å®¹ï¼š</p>

<p><strong>å½“æˆ‘ä»¬å°è¯•ä½¿ç”¨<code class="language-plaintext highlighter-rouge">aggregate initialization</code>çš„æ–¹æ³•åˆå§‹åŒ–ç»“æ„ä½“ç­‰<code class="language-plaintext highlighter-rouge">class type</code>æ—¶ï¼Œåœ¨C++11ä¸­è¢«åšäº†<code class="language-plaintext highlighter-rouge">ä¸å…è®¸åœ¨å­˜åœ¨é»˜è®¤åˆå§‹åŒ–å‚æ•°çš„æƒ…å†µä¸‹ä½¿ç”¨</code>çš„é™åˆ¶ï¼Œè¿™ä¸€é™åˆ¶æ¡ä»¶åœ¨C++14ä¸­è¢«å–æ¶ˆã€‚</strong>ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="nc">A</span> <span class="p">{</span>
  <span class="n">string</span> <span class="n">str</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">A</span><span class="p">{.</span><span class="n">m</span><span class="o">=</span><span class="mi">21</span><span class="p">}</span>  <span class="c1">// Initializes str with {}, which calls the default constructor</span>
          <span class="c1">// then initializes n with = 42</span>
          <span class="c1">// then initializes m with = 21</span>
</code></pre></div></div>

<p><strong>æ–‡æ¡£æˆªå›¾ä¸­çš„åˆå§‹åŒ–æ–¹æ¡ˆ3ã€4è¢«ç§°ä¸º<code class="language-plaintext highlighter-rouge">designated initilizers</code>ï¼Œè¿™ç§åˆå§‹åŒ–æ–¹æ³•è¦ä¿è¯æ‰€æœ‰å…ƒç´ çš„åˆå§‹åŒ–é¡ºåºä¸å®šä¹‰é¡ºåºä¸€æ ·ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ç¼ºçœæŸä¸ªå‚æ•°ï¼š</strong></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="nc">A</span> <span class="p">{</span> <span class="kt">int</span> <span class="n">x</span><span class="p">;</span> <span class="kt">int</span> <span class="n">y</span><span class="p">;</span> <span class="kt">int</span> <span class="n">z</span><span class="p">;</span> <span class="p">};</span>
<span class="n">A</span> <span class="n">a</span><span class="p">{.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">};</span> <span class="c1">// error; designator order does not match declaration order</span>
<span class="n">A</span> <span class="n">b</span><span class="p">{.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="mi">2</span><span class="p">};</span> <span class="c1">// ok, b.y initialized to 0</span>
</code></pre></div></div>

<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">designated initializers</code>æ¥åˆå§‹åŒ–<strong>è”åˆ</strong>ï¼Œä½†æ˜¯<strong>unionåªå…è®¸æˆ‘ä»¬æä¾›ä¸€ä¸ªåˆå§‹åŒ–å‚æ•°æˆå‘˜ï¼š</strong></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">union</span> <span class="n">u</span> <span class="p">{</span> <span class="kt">int</span> <span class="n">a</span><span class="p">;</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">b</span><span class="p">;</span> <span class="p">};</span>
<span class="n">u</span> <span class="n">f</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="s">"asdf"</span> <span class="p">};</span>         <span class="c1">// OK, active member of the union is b</span>
<span class="n">u</span> <span class="n">g</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="s">"asdf"</span> <span class="p">};</span> <span class="c1">// Error, only one initializer may be provided</span>
</code></pre></div></div>

<p>è¯¦ç»†å†…å®¹å‚è§å®˜æ–¹æ–‡æ¡£.</p>

<h2 id="stl">STL</h2>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111092139795.png" alt="image-20211109213909613" style="zoom:50%;" /></p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">vector[i]</code> causes undefined behavior!</p>
</blockquote>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Sequence containers</code></li>
</ul>

<ol>
  <li>vector</li>
  <li>dequeï¼ˆåŒç«¯é˜Ÿåˆ—ï¼‰</li>
  <li>array</li>
  <li>listï¼ˆåŒå‘é“¾è¡¨ï¼‰</li>
  <li>forward_listï¼ˆå•é“¾è¡¨ï¼‰</li>
</ol>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Container Adaptors</code></li>
</ul>

<ol>
  <li>stack</li>
  <li>queue</li>
  <li>priority_queue</li>
</ol>

<p>è¿™ç±»å®¹å™¨ä¹‹æ‰€ä»¥å«<code class="language-plaintext highlighter-rouge">adaptors</code>ï¼Œæ˜¯å› ä¸ºä»–ä»¬åº•å±‚çš„ç»“æ„å®é™…ä¸Šæ˜¯ç”±å¦ä¸€ç§å®¹å™¨æ„æˆçš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ›´æ¢å‡½æ•°å£°æ˜ä¸­çš„æ¨¡æ¿å‚æ•°: stackå’Œqueueçš„åº•å±‚æ˜¯ä¸€ä¸ªdeque:</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111092042210.png" alt="image-20211109204236062" style="zoom:50%;" /></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Associative containers</code></li>
</ul>

<ol>
  <li>map</li>
  <li>set</li>
  <li>unordered_map</li>
  <li>unordered_set</li>
  <li>multimap/unordered_multimap</li>
  <li>multiset/unordered_multiset</li>
</ol>

<blockquote>
  <p>æ‰€è°“<code class="language-plaintext highlighter-rouge">multimap</code>ä¸<code class="language-plaintext highlighter-rouge">multiset</code>ï¼Œæ˜¯æŒ‡çš„å¯ä»¥å­˜åœ¨å¤šä¸ªç›¸åŒçš„é”®å€¼ï¼ˆå…ƒç´ ï¼‰.</p>
</blockquote>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code class="language-plaintext highlighter-rouge">map</code>æ–¹æ³•<code class="language-plaintext highlighter-rouge">at(i)</code>å’Œ<code class="language-plaintext highlighter-rouge">[i]</code>çš„åŒºåˆ«ï¼š<code class="language-plaintext highlighter-rouge">at</code>æ–¹æ³•å¦‚æœæ²¡æœ‰æ‰¾åˆ°è¯¥å…ƒç´ ï¼Œä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œè€Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨<code class="language-plaintext highlighter-rouge">[]</code>ï¼Œé‚£ä¹ˆåœ¨æ²¡æœ‰æ‰¾åˆ°è¯¥å…ƒç´ æ—¶ï¼Œä¼šå…ˆè¿›è¡Œåˆ›å»ºã€‚</p>

<h3 id="iterator">iterator</h3>

<p>è¿­ä»£å™¨æ˜¯STLçš„é‡è¦æ–¹æ³•ï¼Œæˆ‘ä»¬æ‰€ä½¿ç”¨çš„<code class="language-plaintext highlighter-rouge">range for loop</code>å°±æ˜¯ä½¿ç”¨è¿­ä»£å™¨åœ¨å†…éƒ¨å·¥ä½œçš„ã€‚</p>

<blockquote>
  <p>æ³¨æ„<code class="language-plaintext highlighter-rouge">iterator</code>çš„<code class="language-plaintext highlighter-rouge">end</code>æŒ‡å‘çš„æ˜¯æœ€åä¸€ä¸ªå…ƒç´ çš„åä¸€ä½.</p>
</blockquote>

<h4 id="map-iterator">map iterator</h4>

<p><code class="language-plaintext highlighter-rouge">map</code>çš„è¿­ä»£å™¨æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒæŒ‡å‘ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">pair</code>å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">a.first</code>å’Œ<code class="language-plaintext highlighter-rouge">a.second</code>è·å–é”®ä¸å€¼ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">m</span><span class="p">;</span>
<span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">i</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">end</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
<span class="k">while</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">).</span><span class="n">first</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">).</span><span class="n">second</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="o">++</span><span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åœ¨C++20ä¹‹å‰ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦æŸ¥æ‰¾å®¹å™¨ä¸­æ˜¯å¦å­˜åœ¨æŸä¸ªé”®ï¼Œé‚£ä¹ˆéœ€è¦è°ƒç”¨<code class="language-plaintext highlighter-rouge">find</code>æˆ–è€…<code class="language-plaintext highlighter-rouge">end</code>æ–¹æ³•ï¼Œè€Œåœ¨C++20ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨<code class="language-plaintext highlighter-rouge">contains</code>å³å¯ã€‚</p>

<blockquote>
  <p>å¦‚æœ<code class="language-plaintext highlighter-rouge">find</code>æˆåŠŸï¼Œåˆ™<code class="language-plaintext highlighter-rouge">iterator</code>æŒ‡å‘å¯¹åº”çš„å…ƒç´ ï¼Œå¦åˆ™æŒ‡å‘<code class="language-plaintext highlighter-rouge">end</code>. <code class="language-plaintext highlighter-rouge">count</code>æ–¹æ³•é€šè¿‡è°ƒç”¨<code class="language-plaintext highlighter-rouge">find</code>å®ç°ï¼Œæ‰€ä»¥<code class="language-plaintext highlighter-rouge">find</code>æ–¹æ³•çš„é€Ÿåº¦æ›´å¿«.</p>
</blockquote>

<h4 id="lower_bound--upper_bound">lower_bound &amp; upper_bound</h4>

<p><code class="language-plaintext highlighter-rouge">lower_bound</code>æ¥å—ä¸€ä¸ªå€¼<code class="language-plaintext highlighter-rouge">v</code>ï¼Œè¿”å›ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">iterator</code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æŒ‡å‘ç¬¬ä¸€ä¸ª<strong>ä¸å°äº</strong>å…ƒç´ <code class="language-plaintext highlighter-rouge">v</code>çš„ä½ç½®ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™æŒ‡å‘<code class="language-plaintext highlighter-rouge">end</code>ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">upper_bound</code>ä¸<code class="language-plaintext highlighter-rouge">lower_bound</code>çš„å·¥ä½œæ–¹å¼ç±»ä¼¼ï¼Œä½†æ˜¯å…¶è¿”å›çš„è¿­ä»£å™¨å¯¹è±¡æŒ‡å‘ç¬¬ä¸€ä¸ª<strong>å¤§äº</strong>å…ƒç´ <code class="language-plaintext highlighter-rouge">v</code>çš„ä½ç½®ã€‚</p>

<h4 id="iterator-types-introduction">Iterator Types Introduction</h4>

<p>å…±æœ‰äº”ç§åŸºæœ¬çš„è¿­ä»£å™¨ç±»å‹ï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111100017458.png" alt="image-20211110001729377" style="zoom:50%;" /></p>

<p>ä¸Šå›¾ä¸­çš„ç®­å¤´æˆ‘ä»¬å¯ä»¥ç†è§£æˆ<em>ç»§æ‰¿</em>å…³ç³»ã€‚å¯¹äºæ‰€æœ‰çš„è¿­ä»£å™¨ç±»å‹ï¼Œä»–ä»¬éƒ½å…·å¤‡ä»¥ä¸‹å‡ ç§åŸºæœ¬æ“ä½œåŠŸèƒ½ï¼š</p>

<ul>
  <li>Is <em><a href="https://www.cplusplus.com/CopyConstructible">copy-constructible</a></em>, <a href="https://www.cplusplus.com/CopyAssignable">copy-assignable</a> and <a href="https://www.cplusplus.com/Destructible">destructible</a></li>
  <li>can be advanced using <code class="language-plaintext highlighter-rouge">++</code></li>
  <li>can be derederenced using <code class="language-plaintext highlighter-rouge">*</code></li>
</ul>

<ol>
  <li><code class="language-plaintext highlighter-rouge">Input Iterators</code></li>
</ol>

<p>åº”ç”¨å¯¹è±¡ï¼š<strong>è¿ç»­</strong>+<strong>å•å‘</strong>è¾“å…¥ï¼Œä¸‹è¾¹æ¥åˆ†åˆ«è§£é‡Šè¿™ä¸¤ä¸ªé™åˆ¶æ¡ä»¶çš„æ„æ€ï¼š</p>

<ul>
  <li><strong>è¿ç»­</strong>ï¼Œè¡¨ç¤ºæ‰€åº”ç”¨çš„æ•°æ®ç»“æ„ä¸å¯ä»¥æ˜¯<code class="language-plaintext highlighter-rouge">queue</code>ï¼Œ<code class="language-plaintext highlighter-rouge">stack</code>ç­‰ï¼ˆä¸åŒ…æ‹¬<code class="language-plaintext highlighter-rouge">deque</code>ï¼Œå› ä¸º<code class="language-plaintext highlighter-rouge">deque</code>å®é™…æ•ˆæœä¸Šæ˜¯ä¸€ä¸ªä¼˜åŒ–äº†å‰åºæ’å…¥çš„<code class="language-plaintext highlighter-rouge">vector</code>ï¼‰</li>
  <li><strong>å•å‘</strong>ï¼ˆ<code class="language-plaintext highlighter-rouge">single-pass</code>ï¼‰ï¼Œè¿­ä»£å™¨å¯¹åº”çš„æ¯ä¸ªä½ç½®åªèƒ½å…è®¸è¢«<em>ç»è¿‡</em>ä¸€æ¬¡ï¼Œè¿™ä¸ªé™åˆ¶æ¡ä»¶ä¹‹åä¼šè¯¦ç»†è§£é‡Š</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">input iterators</code>åªèƒ½ä½œä¸ºå³å€¼ï¼ˆ<code class="language-plaintext highlighter-rouge">rvalue</code>ï¼‰è¢«è§£å¼•ç”¨ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">itr</span><span class="p">;</span>
</code></pre></div></div>

<p>è¿™ç§è¿­ä»£å™¨çš„åº”ç”¨åœºæ™¯æœ‰ä¹‹å‰æåˆ°è¿‡çš„<code class="language-plaintext highlighter-rouge">find</code>ä»¥åŠ<code class="language-plaintext highlighter-rouge">count</code>å‡½æ•°ç­‰ã€‚è¿™ç§è¿­ä»£å™¨ç±»å‹æ•°æ®æ˜¯<strong>åªè¯»çš„</strong>ã€‚</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">output iterators</code></li>
</ol>

<p>å®ƒçš„åº”ç”¨æ¡ä»¶ä¸<code class="language-plaintext highlighter-rouge">input iterators</code>ç›¸åŒï¼Œä½†æ˜¯å®ƒåªèƒ½ä½œä¸ºå·¦å€¼ï¼ˆ<code class="language-plaintext highlighter-rouge">lvalue</code>ï¼‰è¢«è§£å¼•ç”¨ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">*</span><span class="n">itr</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
</code></pre></div></div>

<p>è¯¥è¿­ä»£å™¨å¯¹è±¡çš„åº”ç”¨åœºæ™¯ä¸»è¦æœ‰<code class="language-plaintext highlighter-rouge">copy</code>ä»¥åŠ<code class="language-plaintext highlighter-rouge">output streams</code>ç­‰ã€‚å®ƒæ˜¯<strong>åªå†™çš„</strong>ã€‚</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">forward iterators</code></li>
</ol>

<p>è¿™ç§è¿­ä»£å™¨ç±»å‹ä¸æŠŠå‰ä¸¤ç§ç±»å‹ç»“åˆèµ·æ¥çš„æ•ˆæœç±»ä¼¼ï¼Œä¸åŒçš„æ˜¯ï¼Œä»–å¯ä»¥åš<code class="language-plaintext highlighter-rouge">multiple pass</code>. åº”ç”¨åœºæ™¯ä¸»è¦æœ‰<code class="language-plaintext highlighter-rouge">replace</code>å‡½æ•°ä»¥åŠ<code class="language-plaintext highlighter-rouge">forward_list</code>ä¸­ã€‚</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">bidirectional iterators</code></li>
</ol>

<p>æ‰¿æ¥<code class="language-plaintext highlighter-rouge">forward iterators</code>ï¼Œä½†æ˜¯å¯ä»¥åš<code class="language-plaintext highlighter-rouge">--</code>æ“ä½œï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">itr</span> <span class="o">=</span> <span class="n">v</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<span class="o">--</span><span class="n">itr</span><span class="p">;</span>
</code></pre></div></div>

<p>åº”ç”¨åœºæ™¯ä¸»è¦æœ‰<code class="language-plaintext highlighter-rouge">reverse</code>å‡½æ•°ï¼Œ<code class="language-plaintext highlighter-rouge">map</code>, <code class="language-plaintext highlighter-rouge">set</code>ä»¥åŠ<code class="language-plaintext highlighter-rouge">list</code>ç­‰ã€‚</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">random Access iterators</code></li>
</ol>

<p>æ‰¿æ¥ä¸Šä¸€ç§ç±»å‹ï¼Œä½†æ˜¯æ”¯æŒ<code class="language-plaintext highlighter-rouge">+=n</code>ä¸<code class="language-plaintext highlighter-rouge">-=n</code>æ“ä½œï¼ŒåŒæ—¶å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">offset dereference operator ([])</code>ï¼Œåº”ç”¨åœ¨å®¹å™¨<code class="language-plaintext highlighter-rouge">vector</code>, <code class="language-plaintext highlighter-rouge">deque</code>, <code class="language-plaintext highlighter-rouge">string</code>ä»¥åŠ<strong>æŒ‡é’ˆ</strong>ä¸Šã€‚</p>

<blockquote>
  <p>Instead of being defined by specific types, each category of iterator is defined by the operations that can be performed on it. This definition means that any type that supports the necessary operations can be used as an iterator â€“ for example, a pointer supports all of the operations required by <a href="https://en.cppreference.com/w/cpp/named_req/RandomAccessIterator"><em>LegacyRandomAccessIterator</em></a>, so a pointer can be used anywhere a <a href="https://en.cppreference.com/w/cpp/named_req/RandomAccessIterator"><em>LegacyRandomAccessIterator</em></a> is expected.</p>
</blockquote>

<p>å…³äºè¿­ä»£å™¨ç±»å‹ï¼Œè¡¥å……ä»¥ä¸‹ä¸€äº›å†…å®¹ï¼š</p>

<p>é™¤äº†ä¸Šè¿°æåˆ°çš„5ç§åŸºæœ¬ç±»å‹çš„è¿­ä»£å™¨ï¼Œ<strong>C++</strong>åæ¥æ–°å¢äº†ä¸€ç§åŸºæœ¬è¿­ä»£å™¨ç±»å‹ï¼š<code class="language-plaintext highlighter-rouge">Contiguous Iterator</code>ï¼Œè¿™ç§è¿­ä»£å™¨ç±»å‹åœ¨<code class="language-plaintext highlighter-rouge">randomAccess Iterators</code>çš„åŸºç¡€ä¸Šä¿è¯äº†<strong>å…¶ä¸­çš„æ•°æ®åœ¨å†…å­˜å¿…é¡»è¿ç»­å­˜å‚¨</strong>ã€‚</p>

<p>åœ¨<a href="https://en.cppreference.com/w/cpp/iterator"><strong>C++20</strong></a>ä¸­ï¼Œæ ¹æ®æ–°çš„å…³é”®å­—<code class="language-plaintext highlighter-rouge">concept</code>ä»¥åŠ<code class="language-plaintext highlighter-rouge">requires</code>å¯¹è¿­ä»£å™¨ç±»å‹æ ¹æ®æ–°çš„ç³»ç»Ÿè®¾è®¡äº†ä¸€å¥—å®šä¹‰ï¼Œä½†æ˜¯åŸºæœ¬çš„ç±»å‹æ˜¯ç›¸ä¼¼çš„ï¼›</p>

<blockquote>
  <p>æˆ‘ä»¬å¯ä»¥ç®€å•åœ°å°†è¿™ä¸¤ä¸ªå…³é”®å­—çš„åŠŸèƒ½ç†è§£ä¸ºï¼šä¸ºæ¨¡æ¿å‚æ•°åˆ¶å®šä¸€äº›é™åˆ¶ï¼Œä½¿å¾—åœ¨<em>ç¼–è¯‘</em>é˜¶æ®µå°±èƒ½å¤Ÿè¿›è¡Œ<code class="language-plaintext highlighter-rouge">evaluation</code>ã€‚åº”ç”¨ä»–ä»¬çš„ä¸»è¦ä¼˜ç‚¹æ˜¯å¯ä»¥å¾—åˆ°æ›´åŠ æ¸…æ™°åœ°ç¼–è¯‘å™¨æŠ¥é”™ã€‚è¿™é‡Œä¸å»æ·±ç©¶ï¼Œ<a href="https://www.cppstories.com/2021/concepts-intro/">è¿™ç¯‡æ–‡ç« </a>å†™çš„è¾ƒä¸ºæ¸…æ¥šã€‚</p>
</blockquote>

<p>æ–°çš„è¿­ä»£å™¨å®šä¹‰åŸºæœ¬æ–¹æ³•æ˜¯å…ˆä½¿ç”¨è¿™ä¸¤ä¸ªå…³é”®å­—å®šä¹‰äº†ä¸€ç§<code class="language-plaintext highlighter-rouge">input_or_output_iterator</code>ç±»å‹ï¼Œä¹‹åæ‰©å±•çš„æ¯ä¸€ç§ç±»å‹å‡æ»¡è¶³è¿™ç§åŸºæœ¬è¿­ä»£å™¨ç±»å‹çš„è¦æ±‚ï¼Œä»å®šä¹‰ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè¿™ç§åŸºæœ¬ç±»å‹æ”¯æŒä¸¤ç§æ“ä½œï¼šè§£å¼•ç”¨+é€’å¢æ“ä½œç¬¦ï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111101555478.png" alt="image-20211110155516376" style="zoom: 33%;" /></p>

<p>æ–°å®šä¹‰çš„è¿­ä»£å™¨ç±»å‹é™¤äº†<code class="language-plaintext highlighter-rouge">output_iterator</code>æ˜¯ç›´æ¥åœ¨<code class="language-plaintext highlighter-rouge">input_or_output_iterator</code>åŸºç¡€ä¸Šå¢åŠ äº†å†™å…¥åŠŸèƒ½ä¹‹å¤–ï¼Œå…¶ä½™çš„è¿­ä»£å™¨ç±»å‹å‡<a href="https://en.cppreference.com/w/cpp/concepts/derived_from">ç»§æ‰¿</a>è‡ª<strong>C++20</strong>ä¹‹å‰çš„è¿­ä»£å™¨ç±»å‹ï¼Œæ¯”å¦‚å¯¹äº<code class="language-plaintext highlighter-rouge">input iterator</code>:</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111101600970.png" alt="image-20211110160016902" style="zoom:50%;" /></p>

<h4 id="what-is-single-pass">What is single-pass?</h4>

<p>ä»€ä¹ˆæ˜¯<code class="language-plaintext highlighter-rouge">single-pass</code>ï¼Ÿä¸ºä»€ä¹ˆåªèƒ½<code class="language-plaintext highlighter-rouge">single-pass</code>ï¼Ÿ<strong>C++æ ‡å‡†åº“</strong>ä¸­æåˆ°ï¼š</p>

<blockquote>
  <p><strong>For input iterators, a == b does not imply ++a == ++b.</strong> (<em>Equality does not guarantee the substitution property or referential transparency.</em>) Algorithms on input iterators should never attempt to pass through the same iterator twice. They should be single pass algorithms. Value type T is not required to be an Assignable type (23.1). These algorithms can be used with istreams as the source of the input data through the istream_iterator class.</p>
</blockquote>

<p><a href="https://stackoverflow.com/questions/5947683/for-input-iterators-why-a-b-does-not-imply-a-b">è¿™é‡Œ</a>å¯¹è¯¥é—®é¢˜è¿›è¡Œäº†ç»†è‡´çš„è®¨è®ºã€‚åœ¨è®¨è®º<code class="language-plaintext highlighter-rouge">input iterators</code>æ—¶ï¼Œå¸¸ä½¿ç”¨<code class="language-plaintext highlighter-rouge">istream_iterator</code>ä½œä¸ºä¾‹å­ï¼Œè¯¥è¿­ä»£å™¨ç±»å‹ä»è¾“å…¥æµä¸­è¯»å–æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³åˆ°ï¼Œæ— è®ºè¯¥è¯»å–è¿‡ç¨‹æ˜¯å¦éœ€è¦ç”¨åˆ°<code class="language-plaintext highlighter-rouge">stream buffer</code>ï¼Œè¯»å–éƒ½æ˜¯å‘ç”Ÿåœ¨è¿­ä»£å™¨ä¸æ–­å‘å‰æ¨è¿›çš„æ—¶å€™ï¼Œè€Œè¾“å…¥æµæŸä¸ªä½ç½®åœ¨è¢«è¯»å–ä¹‹åï¼Œæˆ‘ä»¬å°±ä¸èƒ½å¤Ÿå†æ¬¡å¯¹æµä¸­åŒä¸€ä¸ªä½ç½®çš„å…ƒç´ è¿›è¡Œæ“ä½œäº†ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬<strong>åªèƒ½ç”¨ä¸€ä¸ªè¿­ä»£å™¨ï¼Œå•å‘ï¼Œèµ°ä¸€æ¬¡</strong>ï¼š</p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">std::istream_iterator</code> is a single-pass input iterator that reads successive objects of type <code class="language-plaintext highlighter-rouge">T</code> from the <a href="https://en.cppreference.com/w/cpp/io/basic_istream">std::basic_istream</a> object for which it was constructed, by calling the appropriate <code class="language-plaintext highlighter-rouge">operator&gt;&gt;</code>. The actual read operation is performed when the iterator is incremented, not when it is dereferenced. The first object is read when the iterator is constructed. Dereferencing only returns a copy of the most recently read object.</p>

  <p>The default-constructed <code class="language-plaintext highlighter-rouge">std::istream_iterator</code> is known as the <em>end-of-stream</em> iterator. When a valid <code class="language-plaintext highlighter-rouge">std::istream_iterator</code> reaches the end of the underlying stream, it becomes equal to the end-of-stream iterator. Dereferencing or incrementing it further invokes undefined behavior.</p>
</blockquote>

<p>æ‰€ä»¥åœ¨æ ‡å‡†æ–‡æ¡£ç»™å‡ºçš„è¯´æ˜ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">++a==++b</code>ä¸ºä»€ä¹ˆæ­¤æ—¶ä¸èƒ½å¤Ÿä¿è¯æˆç«‹å‘¢ï¼Ÿè¿™é‡Œé¦–å…ˆæˆ‘ä»¬è¦æ˜ç¡®ä»¥ä¸‹<code class="language-plaintext highlighter-rouge">++</code>æ“ä½œç¬¦çš„ä½œç”¨æœºç†ï¼š</p>

<h5 id="incrementdecrement-operators">Increment/decrement operators</h5>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111101700052.png" alt="image-20211110170018954" style="zoom:50%;" /></p>

<p>æ ¹æ®<a href="https://en.cppreference.com/w/cpp/language/operator_incdec">å®˜æ–¹æ–‡æ¡£</a>ä¸­çš„è§£é‡Šï¼Œ<strong>å‰ç½®</strong>é€’å¢æ“ä½œç¬¦çš„è¿ç®—è¿‡ç¨‹ä¸<code class="language-plaintext highlighter-rouge">x += 1</code>å®Œå…¨ç›¸åŒï¼Œåœ¨å¯¹å…ƒç´ é€’å¢ä¹‹åï¼Œ<strong>è¿”å›ä¸€ä¸ªè¯¥å…ƒç´ çš„å¼•ç”¨</strong>ï¼›è€Œ<strong>åç½®</strong>é€’å¢æ“ä½œç¬¦åˆ™æ˜¯å…ˆä¿å­˜ä¸€ä¸‹å…ƒç´ å‰¯æœ¬ï¼Œå¯¹è¯¥å…ƒç´ æœ¬èº«ï¼ˆå¼•ç”¨ï¼‰è¿›è¡Œé€’å¢ä¹‹åï¼Œ<strong>æŠŠå‰¯æœ¬ï¼ˆä¿å­˜ç€åŸå€¼ï¼‰è¿”å›</strong>ã€‚</p>

<p>åœ¨æ¸…æ¥šäº†<code class="language-plaintext highlighter-rouge">++</code>æ“ä½œç¬¦çš„ä½œç”¨æœºç†åï¼Œæˆ‘ä»¬æŠŠç›®å…‰è½¬å›åˆ°<code class="language-plaintext highlighter-rouge">iterator</code>ä¸Šã€‚åœ¨è¡¨è¾¾å¼<code class="language-plaintext highlighter-rouge">++a==++b</code>ä¸Šï¼Œå¦‚æœæˆ‘ä»¬å·²ç»è¿›è¡Œäº†<code class="language-plaintext highlighter-rouge">++a</code>çš„æ“ä½œï¼Œé‚£ä¹ˆæ ¹æ®<code class="language-plaintext highlighter-rouge">istream_iterator</code>çš„ç‰¹æ€§ï¼Œå·²ç»å¯¹æµå†…çš„æ•°æ®è¿›è¡Œäº†è¯»å–ï¼Œé‚£ä¹ˆæ­¤æ—¶<code class="language-plaintext highlighter-rouge">iterator b</code>å°±æ‰¾ä¸åˆ°æµå†…åŸä½ä¸Šçš„æ•°æ®äº†ï¼Œæ¢è€Œè¨€ä¹‹ï¼Œ<code class="language-plaintext highlighter-rouge">iterator b</code><strong>å¤±æ•ˆäº†</strong>ï¼</p>

<blockquote>
  <p>å¦‚æœæˆ‘ä»¬è¯»å–çš„æ˜¯å­—ç¬¦ï¼Œé‚£ä¹ˆéœ€è¦ç”¨åˆ°<code class="language-plaintext highlighter-rouge">stream buffer</code>ï¼Œæ­¤æ—¶ä½¿ç”¨<a href="https://en.cppreference.com/w/cpp/iterator/istreambuf_iterator">std::istreambuf_iterator</a>æ˜¯æ•ˆç‡æ›´é«˜çš„é€‰æ‹©ï¼Œå› ä¸ºä»–ä¸éœ€è¦å¯¹æ¯ä¸€ä¸ªå­—ç¬¦å»ºç«‹ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">sentry object</code>ï¼Œç¨‹åºåœ¨å¼€å§‹æ—¶å…ˆå»ºç«‹ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">sentry object</code>ï¼Œä¹‹åæŠŠæ‰€æœ‰æ•°æ®æ”¾å…¥ç¼“å†²åŒºï¼Œå†ä½¿ç”¨è¿­ä»£å™¨è¿›è¡Œè¯»å–.</p>
</blockquote>

<p>æ‰€ä»¥ï¼Œåœ¨<code class="language-plaintext highlighter-rouge">count</code>ä»¥åŠ<code class="language-plaintext highlighter-rouge">find</code>å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ç¡®å®åªéœ€è¦èµ°ä¸€æ¬¡å°±å¯ä»¥è·å¾—æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼Œäºæ˜¯åªéœ€è¦ä½¿ç”¨ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">input iterator</code>å³å¯ã€‚å¯¹åº”ç€<code class="language-plaintext highlighter-rouge">output iterator</code>çš„<code class="language-plaintext highlighter-rouge">ostream_iterator</code>ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ã€‚</p>

<h4 id="write-our-own-iterator">Write our own iterator?</h4>

<p>åœ¨C++17ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ç»™è‡ªå·±çš„ç±»å†™ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">iterator</code>ï¼Œé‚£ä¹ˆä¸€èˆ¬çš„æ–¹æ³•æ˜¯ç»§æ‰¿<code class="language-plaintext highlighter-rouge">std::iterator</code>çš„ç±»æ¨¡æ¿ï¼Œå¹¶åœ¨ç±»æ¨¡æ¿ä¸­æŒ‡å®šæ‰€è°“çš„<code class="language-plaintext highlighter-rouge">iterator_category</code>ï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111101732699.png" alt="image-20211110173203619" style="zoom:50%;" /></p>

<p>è¿­ä»£å™¨æ ‡ç­¾å…³è”ç€ä¹‹å‰æ‰€è¿°çš„è¿­ä»£å™¨å®ä½“ã€‚ä½†æ˜¯è‡ª<strong>C++17</strong>èµ·ï¼Œ<code class="language-plaintext highlighter-rouge">std::iterator</code>çš„ç±»æ¨¡æ¿é­åˆ°èˆå¼ƒï¼Œ<a href="https://stackoverflow.com/questions/37031805/preparation-for-stditerator-being-deprecated">è¯¦æƒ…å‚è§</a>ã€‚æ‰€ä»¥ç°åœ¨ï¼Œæˆ‘ä»¬åªèƒ½æ‰‹å†™è¿­ä»£å™¨ï¼Œå…·ä½“å¯ä»¥çœ‹<a href="https://segmentfault.com/a/1190000040879971">è¿™é‡Œ</a>ã€‚</p>

<blockquote>
  <p>åœ¨è¿™é‡Œï¼Œ<code class="language-plaintext highlighter-rouge">iterator_traits</code>æ˜¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">meta-function</code>ï¼Œè¿”å›çš„æ˜¯æ ¹æ®ç»™å…¥å‚æ•°å†³å®šçš„è¿­ä»£å™¨çš„<code class="language-plaintext highlighter-rouge">type</code>ï¼Œä¹Ÿå³ä¸Šå›¾ä¸­çš„å„ç§<code class="language-plaintext highlighter-rouge">iterator_tag</code>ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™äº›ç±»åˆ«æ„é€ æˆ‘ä»¬è‡ªå·±çš„å‡½æ•°ï¼Œåœ¨ä¸‹æ–¹æ¨¡æ¿ä¸€ç« èŠ‚çš„æœ€åä¸€ä¸ªä¾‹å­ä¸­æœ‰æåˆ°ï¼ˆæ¥è‡ªäº<em>Stanford CS 106L Fa2020 lecture</em>ï¼‰ã€‚</p>
</blockquote>

<h2 id="templategeneric-programming">Templateâ€“Generic Programming</h2>

<p>å…³äºæ¨¡æ¿ï¼Œ<a href="https://sg-first.gitbooks.io/cpp-template-tutorial/content/T_ji_ben_yu_fa.html">è¿™é‡Œ</a>æœ‰ä¸€ç¯‡å¾ˆå¥½çš„æ–‡ç« ã€‚</p>

<h3 id="function-template">function template</h3>

<p>å‡½æ•°æ¨¡æ¿çš„åŸºæœ¬å½¢å¼æ˜¯ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="n">T</span> <span class="nf">getInteger</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">prompt</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">reprompt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">prompt</span><span class="p">;</span> 
        <span class="n">string</span> <span class="n">line</span><span class="p">;</span> 
        <span class="n">T</span> <span class="n">result</span><span class="p">;</span> 
        <span class="kt">char</span> <span class="n">extra</span><span class="p">;</span> 
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">getline</span><span class="p">(</span><span class="n">cin</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
            <span class="k">throw</span> <span class="n">domain_error</span><span class="p">(</span><span class="err">â€œ</span><span class="p">[</span><span class="n">shortened</span><span class="p">]</span><span class="err">â€</span><span class="p">);</span>
        <span class="n">istringstream</span> <span class="n">iss</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">iss</span> <span class="o">&gt;&gt;</span> <span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">iss</span> <span class="o">&gt;&gt;</span> <span class="n">extra</span><span class="p">))</span> 
            <span class="k">return</span> <span class="n">result</span><span class="p">;</span> 
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">reprompt</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span> 
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="class-template">class template</h3>

<p>e.g.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span> <span class="k">class</span> <span class="nc">Container</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="p">&gt;</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">Priority_Q</span> <span class="p">{</span>
  <span class="c1">// do something  </span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="template-parameters--template-arguments">template parameters &amp; template arguments</h3>

<p>å‡½æ•°æ¨¡æ¿çš„å½¢å‚åˆ—è¡¨å¯ä»¥ç”±å‡ ä¸‹å‡ ç§æ–¹å¼æ„æˆï¼š</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">non-type template parameter</code></li>
</ol>

<p>ä»€ä¹ˆæ˜¯éç±»å‹æ¨¡æ¿å‚æ•°ï¼Ÿ<strong>éç±»å‹æ¨¡æ¿å‚æ•°ä¼šåœ¨ç¼–è¯‘é˜¶æ®µè¢«é¢„å®šä¹‰å¹¶è¢«æ›¿æ¢ä¸ºå¸¸é‡å€¼</strong>ä½œä¸ºå®å‚ï¼Œå®ƒå¯ä»¥å…·å¤‡å¦‚ä¸‹ç±»å‹ï¼š</p>

<ul>
  <li>An integral type</li>
  <li>An enumeration type</li>
  <li>A pointer or reference to a class object</li>
  <li>A pointer or reference to a function</li>
  <li>A pointer or reference to a class member function</li>
  <li>std::nullptr_t</li>
  <li>A floating point type (since C++20)</li>
</ul>

<p>å¯¹äºè¯¥ç±»å‹çš„å‚æ•°ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p>

<ol>
  <li><strong>The top-level <code class="language-plaintext highlighter-rouge">cv-qualifiers</code> on the template-parameter are ignored</strong> when determining its type</li>
</ol>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// this const will be ignored</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">int</span> <span class="n">k</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// do something</span>
<span class="p">}</span>
</code></pre></div></div>

<ol>
  <li>When the name of a non-type template parameter is used in an expression within the body of the class template, it is an unmodifiable <a href="https://en.cppreference.com/w/cpp/language/value_category">prvalue</a> unless its type was an lvalue reference type, or unless its type is a class type (since C++20).</li>
</ol>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="kt">int</span> <span class="n">N</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">f</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// N is a prvalue, so this is invalid! It will produce a compile error</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ol>
  <li>the expression we give to the template as its argument must can be parsed and substitued during compile time (<strong>non-constant</strong> expressions <strong>cannot</strong> do this, since they could change during runtime)</li>
</ol>

<blockquote>
  <p>å› ä¸ºæ¨¡æ¿çš„åŒ¹é…æ˜¯åœ¨ç¼–è¯‘çš„æ—¶å€™å®Œæˆçš„ï¼Œæ‰€ä»¥å®ä¾‹åŒ–æ¨¡æ¿çš„æ—¶å€™æ‰€ä½¿ç”¨çš„å‚æ•°ï¼Œä¹Ÿå¿…é¡»è¦åœ¨ç¼–è¯‘æœŸå°±èƒ½ç¡®å®šã€‚</p>
</blockquote>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="kt">int</span> <span class="n">N</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">f</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// do something</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// constexpr int b = 0;</span>
    <span class="c1">// error</span>
    <span class="n">f</span><span class="o">&lt;</span><span class="n">a</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="c1">// ok</span>
    <span class="n">f</span><span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<ol>
  <li><code class="language-plaintext highlighter-rouge">type template parameter</code></li>
</ol>

<p>è¿™ç±»å‚æ•°åŒ…æ‹¬ä½¿ç”¨<code class="language-plaintext highlighter-rouge">typename</code>ä¸<code class="language-plaintext highlighter-rouge">class</code>(å³åˆ†åˆ«å¯¹åº”äº†å‡½æ•°æ¨¡æ¿ä¸ç±»æ¨¡æ¿çš„ä¸¤ç§<code class="language-plaintext highlighter-rouge">type-parameter-key</code>)ï¼Œåœ¨<strong>C++20</strong>ä¸­è¿˜æå‡ºäº†ä½¿ç”¨<code class="language-plaintext highlighter-rouge">constrained type template</code>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="o">...</span> <span class="nc">Ts</span><span class="p">&gt;</span> <span class="n">concept</span> <span class="n">C2</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="c1">// variadic concept</span>
<span class="k">template</span><span class="o">&lt;</span><span class="n">C2</span><span class="p">...</span> <span class="n">T</span><span class="p">&gt;</span> <span class="k">struct</span> <span class="nc">s3</span><span class="p">;</span>      <span class="c1">// constraint-expression is (C2&lt;T&gt; &amp;&amp; ...)</span>
</code></pre></div></div>

<ol>
  <li><code class="language-plaintext highlighter-rouge">template template parameter</code></li>
</ol>

<p>æ¨¡æ¿æ¨¡æ¿å‚æ•°ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// two type template parameters and one template template parameter:</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">K</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">V</span><span class="p">,</span> <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="p">&gt;</span> <span class="k">typename</span> <span class="nc">C</span> <span class="o">=</span> <span class="n">my_array</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">Map</span>
<span class="p">{</span>
    <span class="n">C</span><span class="o">&lt;</span><span class="n">K</span><span class="o">&gt;</span> <span class="n">key</span><span class="p">;</span>
    <span class="n">C</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">value</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="instantiationexplicitimplicit">instantiationï¼ˆexplicit/implicitï¼‰</h4>

<p>åœ¨è°ƒç”¨æ¨¡æ¿å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ˜¾å¼æŒ‡å®šå¯¹åº”çš„æ¨¡æ¿å‚æ•°ç±»å‹ï¼ˆ<code class="language-plaintext highlighter-rouge">explicit instantiation</code>ï¼‰,ä¹Ÿå¯ä»¥ä¸æ˜¾å¼æŒ‡å®šæ¨¡æ¿å‚æ•°ç±»å‹ï¼ˆ<code class="language-plaintext highlighter-rouge">implicit instantiation</code>ï¼‰ï¼Œè®©æ¨¡æ¿å‡½æ•°è¿›è¡Œ<strong>ç±»å‹æ¨æ–­ï¼ˆ<code class="language-plaintext highlighter-rouge">Template Argument Deduction</code>ï¼‰</strong>ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬çœç•¥<code class="language-plaintext highlighter-rouge">&lt;&gt;</code>ç¬¦å·ï¼Œé‚£ä¹ˆ<code class="language-plaintext highlighter-rouge">overload resolution</code>ä¼šæŸ¥æ‰¾æ‰€æœ‰çš„æ¨¡æ¿ç±»å‹é‡è½½ä¸éæ¨¡æ¿ç±»å‹é‡è½½ï¼Œè€Œä¸æ˜¯ä»…ä»…æŸ¥æ‰¾æ¨¡æ¿ç±»å‹é‡è½½ã€‚</p>

<blockquote>
  <p>ä»€ä¹ˆæ˜¯<code class="language-plaintext highlighter-rouge">overload resolution</code>?åè¾¹æœ‰æåˆ°.</p>
</blockquote>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬åœ¨<code class="language-plaintext highlighter-rouge">explicit instantiation</code>ä¹‹å‰å·²ç»åšäº†æ¨¡æ¿ç‰¹åŒ–ï¼ˆ<code class="language-plaintext highlighter-rouge">template specialization</code>ï¼‰ï¼Œé‚£ä¹ˆæ­¤æ—¶çš„å®ä¾‹åŒ–æ˜¯ä¸èµ·ä½œç”¨çš„ã€‚</p>

<h4 id="implicit-inference">implicit inference</h4>

<p>åœ¨æ¨¡æ¿å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šéšå«ç€ä¸€äº›ä½¿ç”¨å‚æ•°çš„é™å®šæ¡ä»¶ï¼Œæ¯”å¦‚å¯¹äºä¸‹å›¾æ‰€ç¤ºçš„å‡½æ•°ï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111131433705.png" alt="image-20211113143322516" style="zoom:50%;" /></p>

<p>å…¶å®éšå«ç€è¿™æ ·ä¸€äº›é™å®šå‚æ•°ä½¿ç”¨æ¡ä»¶ï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111131434734.png" alt="image-20211113143458651" style="zoom:50%;" /></p>

<p>è¿™äº›é™å®šæ¡ä»¶æ„å‘³ç€å¦‚æœæˆ‘ä»¬åœ¨è°ƒç”¨å‡½æ•°æ—¶ç»™å‡ºäº†ä¸æ°å½“çš„å‚æ•°ï¼Œé‚£ä¹ˆè¯¥æ¨¡æ¿å‡½æ•°ä¼šæŠ¥å‡ºä¸€äº›éå¸¸å‡Œä¹±çš„é”™è¯¯â€¦</p>

<p>åœ¨<strong>C++20</strong>ä¸­ç»™å‡ºäº†æ–°çš„å…³é”®å­—<code class="language-plaintext highlighter-rouge">concepts</code>ä¸<code class="language-plaintext highlighter-rouge">requires</code>ï¼Œä¹Ÿå°±æ˜¯åœ¨ä¹‹å‰æˆ‘ä»¬æåˆ°è¿‡ç”¨äºé‡å†™<code class="language-plaintext highlighter-rouge">iterator</code>çš„ä¸¤ä¸ªå…³é”®å­—ï¼Œä»–ä»¬å¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨ç¼–è¯‘é˜¶æ®µå°±æ£€æŸ¥å‡ºå‚æ•°é”™è¯¯ï¼Œå°†æŠ¥é”™çš„ä½ç½®ä»å‡½æ•°ä¸»ä½“è½¬ç§»åˆ°è¿™ä¸¤ä¸ªå…³é”®å­—çš„ä½ç½®ä¸Šï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111131442975.png" alt="image-20211113144241875" style="zoom:50%;" /></p>

<p>æ—¢ç„¶<code class="language-plaintext highlighter-rouge">concepts</code>å…³é”®å­—å¯ä»¥æ–¹ä¾¿è§£å†³æ¨¡æ¿ç¼–è¯‘ä¸è¿è¡Œè¿‡ç¨‹ä¸­çš„æŠ¥é”™é—®é¢˜çš„ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±é’ˆå¯¹æ¨¡æ¿çš„ç¼–è¯‘è¿‡ç¨‹è¿›è¡Œåˆ†æã€‚</p>

<h3 id="compile-a-template-function-call">Compile a template function call</h3>

<p>æ¥ä¸‹æ¥æ‰€è¿°çš„æ¦‚å¿µæ¥è‡ªäºå®˜æ–¹æ–‡æ¡£ä»¥åŠè¿™ä¸¤ç¯‡<a href="https://www.cppstories.com/2016/02/notes-on-c-sfinae/#improved-code">1</a><a href="https://www.cppstories.com/2018/03/ifconstexpr/#c20">2</a>åšå®¢. æ ¹æ®ä½œè€…åŸæ–‡ç»™å‡ºçš„ä¾‹å­:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">truct</span> <span class="n">Bar</span> <span class="p">{</span>
    <span class="k">typedef</span> <span class="kt">double</span> <span class="n">internalType</span><span class="p">;</span>  
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span> 
<span class="k">typename</span> <span class="n">T</span><span class="o">::</span><span class="n">internalType</span> <span class="nf">foo</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span> 
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"foo&lt;T&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span> 
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> 
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">foo</span><span class="p">(</span><span class="n">Bar</span><span class="p">());</span>
    <span class="n">foo</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// &lt;&lt; error!</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å½“æˆ‘ä»¬å‘ç¨‹åºä¸­æ·»åŠ äº†ä¸€ä¸ªæ–°çš„éæ¨¡æ¿å‡½æ•°é‡è½½<code class="language-plaintext highlighter-rouge">int foo(int i)</code>æ—¶ï¼Œç¨‹åºä¾¿ä¸ä¼šæŠ¥é”™ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦äº†è§£å‡½æ•°æ•´ä¸ªçš„ç¼–è¯‘è¿‡ç¨‹ã€‚</p>

<h4 id="name-lookup">name lookup</h4>

<p>æ ¹æ®<a href="https://en.cppreference.com/w/cpp/language/overload_resolution">å®˜æ–¹æ–‡æ¡£</a>,ä¸ºäº†ç¼–è¯‘ä¸€ä¸ªå‡½æ•°è°ƒç”¨ï¼Œç¨‹åºé¦–å…ˆä¼šè¿›è¡Œ<code class="language-plaintext highlighter-rouge">name lookup</code>ï¼Œè¿™ä¸€æ­¥æ˜¯å°†ç¨‹åºä¸­å‡ºç°çš„åå­—ä¸å¼•å…¥å®ƒçš„<strong>å£°æ˜</strong>è”ç³»èµ·æ¥ï¼Œæ¯”å¦‚å¯¹äºå¦‚ä¸‹è¯­å¥ï¼Œç¨‹åºæ­£æ˜¯é€šè¿‡<code class="language-plaintext highlighter-rouge">name lookup</code>çš„æ–¹å¼æ¥è§£æè¿™æ¡è¯­å¥ä¸­å‡ºç°çš„å„ä¸ªåå­—ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</code></pre></div></div>

<blockquote>
  <p>åœ¨è¿›è¡Œ<code class="language-plaintext highlighter-rouge">name lookup</code>æ—¶ï¼Œæˆ‘ä»¬ä¾èµ–çš„æ˜¯<code class="language-plaintext highlighter-rouge">scope</code>è¿™ä¸ªæ¦‚å¿µï¼Œä¹Ÿå³åç§°çš„<strong>å£°æ˜</strong>æ‰€åœ¨åœ°ï¼Œ<code class="language-plaintext highlighter-rouge">scope</code>æœ‰å¾ˆå¤š<a href="https://en.cppreference.com/w/cpp/language/scope">ç§ç±»</a>ï¼Œ<code class="language-plaintext highlighter-rouge">namespace</code>,<code class="language-plaintext highlighter-rouge">function</code>,<code class="language-plaintext highlighter-rouge">class</code>,<code class="language-plaintext highlighter-rouge">block</code>,<code class="language-plaintext highlighter-rouge">enumeration</code>,<code class="language-plaintext highlighter-rouge">template parameter</code>éƒ½æ‹¥æœ‰è‡ªå·±çš„<code class="language-plaintext highlighter-rouge">scope</code>.</p>
</blockquote>

<h5 id="unqualified-name-lookup--qualified-name-lookup">unqualified name lookup &amp; qualified name lookup</h5>

<p>åœ¨ä¸Šè¾¹çš„ä¾‹å­ä¸­ï¼Œç¼–è¯‘å™¨é¦–å…ˆä¼šå¯¹åç§°<code class="language-plaintext highlighter-rouge">std</code>è¿›è¡Œ<code class="language-plaintext highlighter-rouge">unqualified name</code>æŸ¥æ‰¾ï¼Œåœ¨å¤´æ–‡ä»¶<code class="language-plaintext highlighter-rouge">&lt;iostream&gt;</code>ä¸­æ‰¾åˆ°å®ƒï¼›ä¹‹åå†å¯¹<code class="language-plaintext highlighter-rouge">cout, endl</code>åš<code class="language-plaintext highlighter-rouge">qualified name</code>çš„æŸ¥æ‰¾ï¼Œå³åœ¨å‘½åç©ºé—´<code class="language-plaintext highlighter-rouge">std</code>ä¸­è¿›è¡Œçš„æŸ¥æ‰¾è¿‡ç¨‹ã€‚</p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">qualified name</code>å³åœ¨ä½œç”¨åŸŸè§£æç¬¦<code class="language-plaintext highlighter-rouge">::</code>å³ä¾§å‡ºç°çš„åç§°ï¼Œæ‰€ä»¥ä»–åŒ…æ‹¬ï¼š</p>

  <ul>
    <li>class member</li>
    <li>namespace member</li>
    <li>enumerator</li>
  </ul>

  <p>åŒæ ·åœ°ï¼Œ<code class="language-plaintext highlighter-rouge">unqualified name</code>å³æ²¡æœ‰åœ¨ä½œç”¨åŸŸè§£æç¬¦<code class="language-plaintext highlighter-rouge">::</code>å³ä¾§å‡ºç°çš„åç§°</p>
</blockquote>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½œç”¨åŸŸè§£æç¬¦<code class="language-plaintext highlighter-rouge">::</code>å·¦ä¾§æ²¡æœ‰ä¸œè¥¿ï¼Œé‚£ä¹ˆç¨‹åºä¼šé»˜è®¤åœ¨<code class="language-plaintext highlighter-rouge">global namespace scope</code>æˆ–è€…ç”±<code class="language-plaintext highlighter-rouge">using</code>å¼•å…¥çš„å‘½åç©ºé—´ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;iostream&gt;
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="nc">std</span><span class="p">{};</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"fail</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span> <span class="c1">// Error: unqualified lookup for 'std' finds the struct</span>
  <span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"ok</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span> <span class="c1">// OK: ::std finds the namespace std</span>
<span class="p">}</span>
</code></pre></div></div>

<h5 id="argument-dependent-lookup-adl">Argument-dependent lookup (ADL)</h5>

<p><a href="https://en.cppreference.com/w/cpp/language/adl">è¿™ç§</a>åç§°æŸ¥æ‰¾æ–¹å¼ä¹Ÿå±äºä¸€ç§<code class="language-plaintext highlighter-rouge">unqualified name lookup</code>ï¼Œå«<code class="language-plaintext highlighter-rouge">Koenig lookup</code>ï¼Œç”¨äºæŸ¥æ‰¾<code class="language-plaintext highlighter-rouge">function-call expressions</code>ä¸­çš„<code class="language-plaintext highlighter-rouge">unqualified function names</code>ï¼ˆåŒ…æ‹¬è¿ç®—ç¬¦é‡è½½æ—¶å¯¹å‡½æ•°çš„éšå¼è°ƒç”¨ï¼‰ï¼Œè¿™ç§æŸ¥æ‰¾æ–¹å¼çš„å­˜åœ¨ä½¿å¾—åœ¨è¿›è¡Œå‡½æ•°è°ƒç”¨æ—¶ï¼Œç¨‹åºä¸ä»…ä»…ä¼šæŸ¥æ‰¾ä¸€èˆ¬çš„<code class="language-plaintext highlighter-rouge">unqualified name lookup</code>çš„<code class="language-plaintext highlighter-rouge">scope</code>å’Œå‘½åç©ºé—´ï¼Œè¿˜ä¼šæŸ¥æ‰¾<strong>å‡½æ•°å‚æ•°ä»¬æ‰€åœ¨çš„å‘½åç©ºé—´</strong>ï¼š</p>

<p>è¯¥ç¤ºä¾‹æ¥è‡ªäºå®˜æ–¹æ–‡æ¡£ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;iostream&gt;
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Test</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span> <span class="c1">// There is no operator&lt;&lt; in global namespace, but ADL</span>
                           <span class="c1">// examines std namespace because the left argument is in</span>
                           <span class="c1">// std and finds std::operator&lt;&lt;(std::ostream&amp;, const char*)</span>
    <span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">,</span> <span class="s">"Test</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="c1">// same, using function call notation</span>
 
    <span class="c1">// however,</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span> <span class="c1">// Error: 'endl' is not declared in this namespace.</span>
                       <span class="c1">// This is not a function call to endl(), so ADL does not apply</span>
 
    <span class="n">endl</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">);</span> <span class="c1">// OK: this is a function call: ADL examines std namespace</span>
                     <span class="c1">// because the argument of endl is in std, and finds std::endl</span>
 
    <span class="p">(</span><span class="n">endl</span><span class="p">)(</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">);</span> <span class="c1">// Error: 'endl' is not declared in this namespace.</span>
                       <span class="c1">// The sub-expression (endl) is not a function call expression</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="template-argument-deduction">Template Argument Deduction</h4>

<p>åœ¨è¿›è¡Œå®Œ<code class="language-plaintext highlighter-rouge">name lookup</code>è¿™ä¸€æ­¥ä¹‹åï¼Œç¨‹åºä¼šè¿›è¡Œ<code class="language-plaintext highlighter-rouge">Template Argument Deduction</code>ï¼š</p>

<blockquote>
  <p>In order to instantiate a <a href="https://en.cppreference.com/w/cpp/language/function_template">function template</a>, every template argument must be known, but not every template argument has to be specified. When possible, the compiler will deduce the missing template arguments from the function arguments. This occurs when a function call is attempted, when an address of a function template is taken, and in some <a href="https://en.cppreference.com/w/cpp/language/template_argument_deduction#Other_contexts">other contexts</a>.</p>
</blockquote>

<p>è¿™ä¸€æœºåˆ¶ä»¥åŠä¸Šä¸€èŠ‚æåˆ°çš„<code class="language-plaintext highlighter-rouge">ADL</code>ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨<code class="language-plaintext highlighter-rouge">template operator</code>æˆä¸ºå¯èƒ½ï¼Œå› ä¸ºåœ¨ä½¿ç”¨<code class="language-plaintext highlighter-rouge">template operator</code>æ—¶ï¼Œæˆ‘ä»¬æ— æ³•æ˜¾å¼æŒ‡å®šæ‰€ç”¨çš„æ¨¡æ¿å‚æ•°çš„ç±»å‹ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;iostream&gt;
</span> 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> 
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Hello, world"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="c1">// operator&lt;&lt; is looked up via ADL as std::operator&lt;&lt;,</span>
    <span class="c1">// then deduced to operator&lt;&lt;&lt;char, std::char_traits&lt;char&gt;&gt; both times</span>
    <span class="c1">// std::endl is deduced to &amp;std::endl&lt;char, std::char_traits&lt;char&gt;&gt;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºå‡½æ•°ä»¥åŠå‡½æ•°æ¨¡æ¿åç§°ï¼Œ<code class="language-plaintext highlighter-rouge">name lookup</code>å¯ä»¥æ‰¾åˆ°å¤šä¸ªåˆç†çš„åç§°ï¼Œå¹¶äº¤ç»™ä¹‹åçš„<code class="language-plaintext highlighter-rouge">overload resolution</code>è¿‡ç¨‹å¤„ç†ï¼Œä½†æ˜¯å¯¹äºå…¶ä»–çš„åå­—ï¼Œæ¯”å¦‚å˜é‡ï¼Œç±»ï¼Œå‘½åç©ºé—´ç­‰ï¼Œ<code class="language-plaintext highlighter-rouge">name lookup</code><strong>åªå…è®¸æ‰¾åˆ°ä¸€ä¸ªåå­—çš„å£°æ˜ä»¥ä¿è¯æ­£å¸¸ç¼–è¯‘</strong>ã€‚</p>

<h4 id="template-argument-substitution">Template Argument Substitution</h4>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»è·å–åˆ°äº†æ‰€ä½¿ç”¨çš„æ¨¡æ¿å‚æ•°ç±»å‹ï¼Œåœ¨è¿™ä¸€æ­¥æˆ‘ä»¬è¦å°†æ‰€æœ‰å‡ºç°åœ¨åŸæœ¬çš„æ¨¡æ¿ä¸­çš„å‚æ•°<code class="language-plaintext highlighter-rouge">T</code>æ›¿æ¢ä¸ºæˆ‘ä»¬æ¨æ–­å‡ºçš„å‚æ•°ç±»å‹ã€‚</p>

<blockquote>
  <p>When all template arguments have been specified, deduced or obtained from default template arguments, every use of a template parameter in the function parameter list is replaced with the corresponding template arguments.</p>
</blockquote>

<p>éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœåœ¨æ›¿æ¢è¿‡ç¨‹ä¸­ï¼Œå‡ºç°äº†é”™è¯¯ï¼Œæ¯”å¦‚åœ¨å…ˆå‰ç»™å‡ºçš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬è·å¾—äº†ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">int::interalType</code>çš„ç±»å‹ï¼Œé‚£ä¹ˆæ­¤æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè¿™ä¸€å‚æ•°ç±»å‹ï¼ˆä¸€ä¸ªæ›¿æ¢æ–¹æ¡ˆï¼‰å‰”é™¤å‡º<code class="language-plaintext highlighter-rouge">overload set</code>ï¼Œè¿™ä¸€<a href="https://en.wikipedia.org/wiki/Substitution_failure_is_not_an_error">æ“ä½œ</a>è¢«ç§°ä¸º<strong>SFINAEâ€“<em>Substitution failure is not an error</em></strong>.</p>

<h4 id="overload-resolution">overload resolution</h4>

<p>åœ¨åšå®Œ<code class="language-plaintext highlighter-rouge">Template Argument Substitution</code>è¿™ä¸€æ­¥åï¼Œå¦‚æœ<code class="language-plaintext highlighter-rouge">overload set</code>ä¸­å·²ç„¶æ²¡æœ‰å¯ç”¨çš„å‡½æ•°ï¼Œé‚£ä¹ˆç¼–è¯‘å¤±è´¥ï¼Œä½†å­˜åœ¨è¿™æ ·ä¸€ç§æƒ…å†µï¼šå³ç›®å‰æœ‰å¤šä¸ª<code class="language-plaintext highlighter-rouge">candicate function</code>å¯ä¾›é€‰ç”¨ï¼Œé‚£ä¹ˆæ­¤æ—¶<code class="language-plaintext highlighter-rouge">overload resolution</code>ä¾¿ä¼šæ´¾ä¸Šç”¨åœºã€‚</p>

<blockquote>
  <p>In order to compile a function call, the compiler must first perform <a href="https://en.cppreference.com/w/cpp/language/lookup">name lookup</a>, which, for functions, may involve <a href="https://en.cppreference.com/w/cpp/language/adl">argument-dependent lookup</a>, and for function templates may be followed by <a href="https://en.cppreference.com/w/cpp/language/template_argument_deduction">template argument deduction</a>. If these steps produce more than one <em>candidate function</em>, then <em>overload resolution</em> is performed to select the function that will actually be called.</p>
</blockquote>

<blockquote>
  <p>è¿™æ˜¯ä¸€ç§é’ˆå¯¹äº<code class="language-plaintext highlighter-rouge">function call</code>çš„é€šç”¨æ¦‚å¿µï¼Œå¹¶éåªé’ˆå¯¹<code class="language-plaintext highlighter-rouge">template</code>.</p>
</blockquote>

<p>å½“æˆ‘ä»¬è¯•å›¾åœ¨æ¨¡æ¿å‡½æ•°ä¸­åº”ç”¨<code class="language-plaintext highlighter-rouge">overload resolution</code>ä»¥é€‰æ‹©æœ€ä½³åŒ¹é…é‡è½½å‡½æ•°æ—¶ï¼Œä¼šä½¿ç”¨<code class="language-plaintext highlighter-rouge">partial ordering of overloaded function templates</code>çš„<a href="https://en.cppreference.com/w/cpp/language/function_template">æ–¹æ³•</a>æ¥é€‰æ‹©æœ€ä½³åŒ¹é…ã€‚ä»€ä¹ˆæ˜¯æœ€ä½³åŒ¹é…é‡è½½å‡½æ•°ï¼Ÿ</p>

<blockquote>
  <p>Informally â€œA is more specialized than Bâ€ means â€œA accepts fewer types than Bâ€.</p>
</blockquote>

<p><em>StackOverflow</em>ä¸Šæœ‰ä¸€ç¯‡å¾ˆè¯¦ç»†çš„<a href="https://stackoverflow.com/questions/17005985/what-is-the-partial-ordering-procedure-in-template-deduction">æ–‡ç« </a>æè¿°è¿™ä¸€æœºç†ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨å…ˆå‰çš„ä¾‹å­ä¸­åŠ å…¥ä¸€ä¸ªåŒ¹é…çš„æ–°<code class="language-plaintext highlighter-rouge">function</code>ï¼Œå°±å¯ä»¥ç¼–è¯‘æˆåŠŸçš„åŸå› ã€‚</p>

<h4 id="sfinae">SFINAE</h4>

<p>åœ¨ä¸Šä¸€èŠ‚çš„<code class="language-plaintext highlighter-rouge">template argument substituion</code>ä¸­ï¼Œæˆ‘ä»¬æåˆ°äº†<code class="language-plaintext highlighter-rouge">SFINAE</code>çš„å†…éƒ¨ä½œç”¨æœºç†ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦å¦‚ä½•å†™å‡ºè¿™æ ·çš„ä»£ç æˆ–è€…è¯´è¿™ä¸€æœºç†æœ‰ä»€ä¹ˆç”¨å¤„å‘¢ï¼Ÿ</p>

<h5 id="why-we-need-sfinae">Why we need SFINAE?</h5>

<p>åœ¨è¿™ç¯‡<a href="https://www.cppstories.com/2018/03/ifconstexpr/#c20">æ–‡ç« </a>é‡Œï¼Œå…¶å®è§£é‡Šçš„å¾ˆæ¸…æ¥šã€‚è¿™é‡Œæ˜¯æˆ‘çš„ä¸€ä¸ªæ€»ç»“ã€‚ç®€è€Œè¨€ä¹‹ï¼Œå¯¹äºæˆ‘ä»¬è‡ªå·±çš„å‡½æ•°æ¨¡æ¿ä»£ç ï¼Œå¦‚æœå…¶ä¸­å­˜åœ¨<code class="language-plaintext highlighter-rouge">if-else</code>åˆ†æ”¯ï¼Œé‚£ä¹ˆç¨‹åºå¾ˆæœ‰å¯èƒ½ä¼šåœ¨ç¼–è¯‘é˜¶æ®µæŠ¥é”™ï¼Œå› ä¸ºä»–ä¼šç¼–è¯‘<code class="language-plaintext highlighter-rouge">if-else</code>ä¸¤ä¸ªåˆ†æ”¯ï¼Œä¹‹åç¨‹åºå‘ç°è‡ªå·±æ— æ³•<code class="language-plaintext highlighter-rouge">reject the invalid code (for this case)</code>ï¼Œè€Œæˆ‘ä»¬è¦åšçš„ï¼Œå°±æ˜¯è®©ç¨‹åºåœ¨ç¼–è¯‘é˜¶æ®µæŠŠåœ¨å½“å‰æƒ…å†µä¸‹ä¸æ­£ç¡®çš„åˆ†æ”¯ç»™å‰”é™¤ï¼Œä»<code class="language-plaintext highlighter-rouge">overload set</code>ä¸­å°†å…¶å»æ‰ï¼Œåªç¼–è¯‘ç¬¦åˆè¦æ±‚çš„éƒ¨åˆ†ï¼Œè¿™ä¹Ÿå¯¹åº”ç€<code class="language-plaintext highlighter-rouge">SFINAE</code>çš„å®šä¹‰ã€‚</p>

<h5 id="how-to-leverage-sfinae">How to leverage SFINAE?</h5>

<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ<strong>C++11/14/17/20</strong>æå‡ºäº†å¤šç§æ–¹æ¡ˆï¼š</p>

<h6 id="tag-dispatching"><a href="https://www.cppstories.com/2016/02/notes-on-c-sfinae/#improved-code">Tag Dispatching</a></h6>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111132349840.png" alt="image-20211113234948754" style="zoom:50%;" /></p>

<h6 id="enable_if">enable_if</h6>

<blockquote>
  <p><strong>std::enable_if</strong> can be used as an additional function argument (not applicable to operator overloads), as a return type (not applicable to constructors and destructors), or as a class template or function template parameter.</p>
</blockquote>

<p><a href="https://en.cppreference.com/w/cpp/types/enable_if">è¿™ä¸€è¯­æ³•</a>è‡ª<strong>C++11</strong>æå‡ºï¼Œä½†å½“æ—¶çš„å†™æ³•æ˜¯<code class="language-plaintext highlighter-rouge">enable_if</code>ï¼Œåœ¨<strong>C++14/17</strong>ä¸­ï¼Œæå‡ºäº†<code class="language-plaintext highlighter-rouge">enable_if_t</code>.</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111132147605.png" alt="image-20211113214738450" style="zoom:50%;" /></p>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“<code class="language-plaintext highlighter-rouge">B==true</code>æ—¶ï¼Œ<code class="language-plaintext highlighter-rouge">enable_if</code>å…·å¤‡ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">typedef type</code>ï¼Œå³<code class="language-plaintext highlighter-rouge">T</code>ï¼Œå¦åˆ™æ²¡æœ‰è¯¥æˆå‘˜ï¼Œäºæ˜¯å½“æˆ‘ä»¬å†™æˆå¦‚ä¸‹ä»£ç ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">enable_if</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">is_arithmetic</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;::</span><span class="n">type</span>
</code></pre></div></div>

<p>æˆ–è€…å‚çœ‹æ–‡æ¡£ä¸­çš„<code class="language-plaintext highlighter-rouge">alias</code>â€“<code class="language-plaintext highlighter-rouge">enable_if_t</code>çš„å®šä¹‰æ—¶ï¼Œå¦‚æœå…¶ä¸å…·å¤‡æˆå‘˜<code class="language-plaintext highlighter-rouge">type</code>ä½†æ˜¯æˆ‘ä»¬å´ä½¿ç”¨äº†<code class="language-plaintext highlighter-rouge">::type</code>ï¼Œé‚£ä¹ˆç¼–è¯‘å°±ä¼šå‡ºé”™ï¼Œå¹¶ä½¿ç”¨<code class="language-plaintext highlighter-rouge">SFINAE</code>æœºåˆ¶å¤„ç†ã€‚åœ¨<strong>C++14</strong>åŠä»¥åçš„ç‰ˆæœ¬ä¸­ï¼Œä¸Šè¿°ä»£ç å¯è¢«ç®€åŒ–ä¸ºï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">enable_if_t</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">is_arithmetic_v</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span> 
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">enable_if</code>å¸¸ä¸<code class="language-plaintext highlighter-rouge">type traits</code>ä¸€èµ·ä½¿ç”¨ï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111132152195.png" alt="image-20211113215251103" style="zoom:50%;" /></p>

<p><code class="language-plaintext highlighter-rouge">type traits</code>åœ¨<strong>ç¼–è¯‘é˜¶æ®µ</strong>ç”¨ä»¥ç¡®å®šæ¨¡æ¿ç‰¹å¾å’Œå±æ€§ã€‚åœ¨<strong>C++14</strong>ä¸­ä¹Ÿæå‡ºäº†ç±»ä¼¼äº<code class="language-plaintext highlighter-rouge">is_arithmetic_v</code>çš„å½¢å¼ï¼ˆåŸæœ¬çš„<code class="language-plaintext highlighter-rouge">value</code>å½“<code class="language-plaintext highlighter-rouge">T</code>ä¸º<code class="language-plaintext highlighter-rouge">arithmetic type</code>æ˜¯è¿”å›<code class="language-plaintext highlighter-rouge">true</code>ï¼Œåä¹‹<code class="language-plaintext highlighter-rouge">false</code>ï¼‰</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111132155450.png" alt="image-20211113215505370" style="zoom:50%;" /></p>

<p>å€ŸåŠ©äº<code class="language-plaintext highlighter-rouge">enable_if_t</code>ï¼Œæˆ‘ä»¬å¯ä»¥å°†æœ¬èŠ‚æœ€åˆçš„ä»£ç æ›´æ”¹ä¸ºï¼š</p>

<pre><code class="language-cPP">template &lt;typename T&gt;
enable_if_t&lt;is_convertible_v&lt;T, string&gt;, string&gt; strOld(T t) {
    return t;
}

template &lt;typename T&gt;
enable_if_t&lt;!is_convertible_v&lt;T, string&gt;, string&gt; strOld(T t) {
    return to_string(t);
}
</code></pre>

<blockquote>
  <p>å…³äº<code class="language-plaintext highlighter-rouge">enable_if</code>çš„ç¼ºç‚¹ï¼Œ<em>StackOverflow</em>ä¸Šçš„ä¸€ç¯‡<a href="https://stackoverflow.com/questions/14600201/why-should-i-avoid-stdenable-if-in-function-signatures">æ–‡ç« </a>è¿›è¡Œäº†æ¢è®¨ã€‚</p>
</blockquote>

<blockquote>
  <p><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code class="language-plaintext highlighter-rouge">enable_if</code>è¿™é‡Œç›´æ¥å……å½“äº†å‡½æ•°çš„è¿”å›å€¼ç±»å‹ï¼Œå› ä¸ºå®ƒæœ¬èº«å°±è¿”å›ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">type</code></strong></p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">enable_if</code>è¿˜å¯ä»¥ç›´æ¥ä½¿ç”¨åœ¨æ¨¡æ¿å‚æ•°ä¸­ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 2. the second template argument is only valid if T is an integral type:</span>
<span class="k">template</span> <span class="o">&lt;</span> <span class="k">class</span> <span class="nc">T</span><span class="p">,</span>
           <span class="k">class</span> <span class="o">=</span> <span class="k">typename</span> <span class="nc">std</span><span class="o">::</span><span class="n">enable_if</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">is_integral</span><span class="o">&lt;</span><span class="n">T</span><span class="p">&gt;</span><span class="o">::</span><span class="n">value</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">&gt;</span>
<span class="kt">bool</span> <span class="nf">is_even</span> <span class="p">(</span><span class="n">T</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="o">!</span><span class="kt">bool</span><span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="mi">2</span><span class="p">);}</span>
</code></pre></div></div>

<h6 id="notes">Notes</h6>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111132229957.png" alt="image-20211113222941812" style="zoom:50%;" /></p>

<blockquote>
  <p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæåˆ°çš„æ˜¯<code class="language-plaintext highlighter-rouge">only differ in default template arguments</code>ï¼Œå¦‚æœä¸¤ä¸ªæ¨¡æ¿çš„<code class="language-plaintext highlighter-rouge">default template argument</code>ä¸€æ ·ä½†æ˜¯<code class="language-plaintext highlighter-rouge">template parameters</code>ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆä¸ä¼šå‘ç”Ÿç¼–è¯‘é”™è¯¯.</p>
</blockquote>

<h6 id="if-constexpr">if constexpr</h6>

<p>åœ¨<strong>C++17</strong>ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†<code class="language-plaintext highlighter-rouge">if conxtexpr statement</code>ä½¿ç”¨åœ¨æ¨¡æ¿ä¸­ï¼Œèµ·åˆ°ä¸<code class="language-plaintext highlighter-rouge">enable_if_t</code>ç›¸åŒçš„ä½œç”¨ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">auto</span> <span class="nf">get_value</span><span class="p">(</span><span class="n">T</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="k">constexpr</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_pointer_v</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span> <span class="c1">// deduces return type to int for T = int*</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="n">t</span><span class="p">;</span>  <span class="c1">// deduces return type to int for T = int</span>
<span class="p">}</span>
</code></pre></div></div>

<h6 id="concepts-requires">concepts-requires</h6>

<p>ç»ˆäºï¼Œæˆ‘ä»¬æ¥åˆ°äº†<code class="language-plaintext highlighter-rouge">concepts</code>ã€‚</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// concept:</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="n">concept</span> <span class="n">Hashable</span> <span class="o">=</span> <span class="n">requires</span><span class="p">(</span><span class="n">T</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">{</span> <span class="n">std</span><span class="o">::</span><span class="n">hash</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">{}(</span><span class="n">a</span><span class="p">)</span> <span class="p">}</span> <span class="o">-&gt;</span> <span class="n">std</span><span class="o">::</span><span class="n">convertible_to</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">concept</code>ï¼Œå°†ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">requires-expression</code>èµ‹å€¼ç»™å®ƒã€‚<code class="language-plaintext highlighter-rouge">requires</code>å…³é”®å­—æœ‰å¾ˆå¤šç§å†™æ³•ï¼š</p>

<ul>
  <li>requires clauses</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="n">f</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;&amp;</span><span class="p">)</span> <span class="n">requires</span> <span class="n">Eq</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span> <span class="c1">// can appear as the last element of a function declarator</span>
 
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span> <span class="n">requires</span> <span class="n">Addable</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="c1">// or right after a template parameter list</span>
<span class="n">T</span> <span class="nf">add</span><span class="p">(</span><span class="n">T</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>requires expressions</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="n">concept</span> <span class="n">Addable</span> <span class="o">=</span> <span class="n">requires</span> <span class="p">(</span><span class="n">T</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span> <span class="p">};</span> <span class="c1">// requires-expression</span>
</code></pre></div></div>

<ul>
  <li>simple requirements</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="n">concept</span> <span class="n">Addable</span> <span class="o">=</span>
<span class="n">requires</span> <span class="p">(</span><span class="n">T</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span> <span class="c1">// "the expression a+b is a valid expression that will compile"</span>
<span class="p">};</span>
</code></pre></div></div>

<blockquote>
  <p>å› ä¸ºæ‰€æœ‰ä»¥å…³é”®å­—<code class="language-plaintext highlighter-rouge">requires</code>å¼€å¤´çš„<code class="language-plaintext highlighter-rouge">requirements</code>éƒ½ä¼šè¢«è§£é‡Šæˆ<code class="language-plaintext highlighter-rouge">nested requirement</code>ï¼Œæ‰€ä»¥<code class="language-plaintext highlighter-rouge">simple requirements</code>ä¸ä¼šä»¥<code class="language-plaintext highlighter-rouge">requires</code>å¼€å¤´</p>
</blockquote>

<ul>
  <li>Type requirements</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span> <span class="k">using</span> <span class="n">Ref</span> <span class="o">=</span> <span class="n">T</span><span class="o">&amp;</span><span class="p">;</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span> <span class="n">concept</span> <span class="n">C</span> <span class="o">=</span>
<span class="n">requires</span> <span class="p">{</span>
    <span class="k">typename</span> <span class="n">T</span><span class="o">::</span><span class="n">inner</span><span class="p">;</span> <span class="c1">// required nested member name</span>
    <span class="k">typename</span> <span class="n">S</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span>     <span class="c1">// required class template specialization</span>
    <span class="k">typename</span> <span class="n">Ref</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span>   <span class="c1">// required alias template substitution</span>
<span class="p">};</span>
</code></pre></div></div>

<ul>
  <li>Compound requirements</li>
</ul>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111222032893.png" alt="image-20211122203241729" style="zoom:50%;" /></p>

<ul>
  <li>Nested requirements</li>
</ul>

<h6 id="abbreviated-function-template">Abbreviated function template</h6>

<p>è‡ª<strong>C++20</strong>å§‹ï¼Œæå‡ºäº†<code class="language-plaintext highlighter-rouge">Abbreviated function template</code>çš„åšæ³•ï¼Œå³ä½¿ç”¨<code class="language-plaintext highlighter-rouge">placeholder types(auto, concept auto)</code>å‡ºç°åœ¨å‡½æ•°å£°æ˜æˆ–è€…å‡½æ•°æ¨¡æ¿å£°æ˜ä¸­ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">f1</span><span class="p">(</span><span class="k">auto</span><span class="p">);</span> <span class="c1">// same as template&lt;class T&gt; void f(T)</span>
<span class="kt">void</span> <span class="nf">f2</span><span class="p">(</span><span class="n">C1</span> <span class="k">auto</span><span class="p">);</span> <span class="c1">// same as template&lt;C1 T&gt; void f2(T), if C1 is a concept</span>
<span class="kt">void</span> <span class="nf">f3</span><span class="p">(</span><span class="n">C2</span> <span class="k">auto</span><span class="p">...);</span> <span class="c1">// same as template&lt;C2... Ts&gt; void f3(Ts...), if C2 is a concept</span>
<span class="kt">void</span> <span class="nf">f4</span><span class="p">(</span><span class="k">const</span> <span class="n">C3</span> <span class="k">auto</span><span class="o">*</span><span class="p">,</span> <span class="n">C4</span> <span class="k">auto</span><span class="o">&amp;</span><span class="p">);</span> <span class="c1">// same as template&lt;C3 T, C4 U&gt; void f4(const T*, U&amp;);</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span> <span class="n">C</span> <span class="n">U</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">g</span><span class="p">(</span><span class="n">T</span> <span class="n">x</span><span class="p">,</span> <span class="n">U</span> <span class="n">y</span><span class="p">,</span> <span class="n">C</span> <span class="k">auto</span> <span class="n">z</span><span class="p">);</span> <span class="c1">// same as template&lt;class T, C U, C W&gt; void g(T x, U y, W z);</span>
</code></pre></div></div>

<p>äºæ˜¯å¯¹äºåŸåšå®¢ä¸­ç»™å‡ºçš„ä¾‹å­ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// requires:</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="n">requires</span> <span class="n">std</span><span class="o">::</span><span class="n">is_floating_point_v</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
<span class="k">constexpr</span> <span class="kt">bool</span> <span class="nf">close_enough20</span><span class="p">(</span><span class="n">T</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="n">absolute</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">precision_threshold</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">constexpr</span> <span class="kt">bool</span> <span class="nf">close_enough20</span><span class="p">(</span><span class="k">auto</span> <span class="n">a</span><span class="p">,</span> <span class="k">auto</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æ ¹æ®<a href="https://en.cppreference.com/w/cpp/language/function_template#Abbreviated_function_template">å®˜æ–¹æ–‡æ¡£</a>ï¼Œæˆ‘ä»¬åˆ©ç”¨<code class="language-plaintext highlighter-rouge">constrained auto</code>å°†å…¶æ”¹å†™ä¸ºï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">constexpr</span> <span class="kt">bool</span> <span class="nf">close_enough20</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">floating_point</span> <span class="k">auto</span> <span class="n">a</span><span class="p">,</span>
                              <span class="n">std</span><span class="o">::</span><span class="n">floating_point</span> <span class="k">auto</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="n">absolute</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">precision_threshold</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">common_type_t</span><span class="o">&lt;</span><span class="k">decltype</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="k">decltype</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">constexpr</span> <span class="kt">bool</span> <span class="nf">close_enough20</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">integral</span> <span class="k">auto</span> <span class="n">a</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">integral</span> <span class="k">auto</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">return</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™é‡Œæœ‰ä¸€ç¯‡<a href="https://devblogs.microsoft.com/cppblog/abbreviated-function-templates-and-constrained-auto/">æ–‡ç« </a>ä½œäº†è¾ƒä¸ºè¯¦ç»†çš„ä»‹ç»ã€‚</p>

<h3 id="template-meta-programming">Template meta-programming</h3>

<p>æœ¬éƒ¨åˆ†å†…å®¹æ¥è‡ªäº<code class="language-plaintext highlighter-rouge">Stanford CS 106L Fa2020</code>çš„<code class="language-plaintext highlighter-rouge">guest lecture</code>ï¼Œä»¥åŠ<a href="https://sg-first.gitbooks.io/cpp-template-tutorial/content/TMP_ji_chu_md.html">C++ Template Tutorial</a>å’Œ<strong>C++</strong>å®˜æ–¹æ–‡æ¡£ã€‚</p>

<p>åœ¨å­¦ä¹ äº†ä¸€ç³»åˆ—åŸºæœ¬å…³äºæ¨¡æ¿çš„åŸºç¡€çŸ¥è¯†ä»¥åŠå…ˆå‰å…³äº<code class="language-plaintext highlighter-rouge">iterator</code>çš„å†…å®¹åï¼Œå¯¹æ¨¡æ¿å…ƒç¼–ç¨‹ï¼ˆ<code class="language-plaintext highlighter-rouge">Template meta-pragramming</code>ï¼‰åšä¸€ä¸‹æµ…æ˜¾çš„äº†è§£å’Œè®¤è¯†ã€‚åœ¨è¿™ä¸€ç« èŠ‚ï¼Œä¹Ÿä¼šå¯¹å…ˆå‰æ²¡æœ‰æåˆ°çš„æ¨¡æ¿ç‰¹åŒ–ï¼ˆ<code class="language-plaintext highlighter-rouge">Template Specialization</code>ï¼‰åšä¸€äº›ä»‹ç»ã€‚</p>

<p>æ‰€ä»¥ä»€ä¹ˆæ˜¯å…ƒç¼–ç¨‹ï¼Ÿè¿™é‡Œç›´æ¥å¼•ç”¨æåˆ°çš„æ–‡ç« ä¸­çš„ä¸€æ®µè¯ï¼š</p>

<blockquote>
  <p>å…ƒï¼ˆmetaï¼‰æ— è®ºåœ¨ä¸­æ–‡è¿˜æ˜¯è‹±æ–‡é‡Œï¼Œéƒ½æ˜¯ä¸ªå¾ˆâ€œæŠ½è±¡ï¼ˆabstractï¼‰â€çš„è¯ã€‚å› ä¸ºå®ƒçš„æœ¬æ„å°±æ˜¯â€œæŠ½è±¡â€ã€‚å…ƒç¼–ç¨‹ï¼Œä¹Ÿå¯ä»¥è¯´å°±æ˜¯â€œç¼–ç¨‹çš„æŠ½è±¡â€ã€‚ç”¨æ›´å¥½ç†è§£çš„è¯´æ³•ï¼Œå…ƒç¼–ç¨‹æ„å‘³ç€ä½ æ’°å†™ä¸€æ®µç¨‹åºAï¼Œç¨‹åºAä¼šè¿è¡Œåç”Ÿæˆå¦å¤–ä¸€ä¸ªç¨‹åºBï¼Œç¨‹åºBæ‰æ˜¯çœŸæ­£å®ç°åŠŸèƒ½çš„ç¨‹åºã€‚é‚£ä¹ˆè¿™ä¸ªæ—¶å€™ç¨‹åºAå¯ä»¥ç§°ä½œç¨‹åºBçš„å…ƒç¨‹åºï¼Œæ’°å†™ç¨‹åºAçš„è¿‡ç¨‹ï¼Œå°±ç§°ä¹‹ä¸ºâ€œå…ƒç¼–ç¨‹â€ã€‚</p>

  <p>æˆ‘ä»¬çš„ç›®çš„ï¼Œæ˜¯æ‰¾å‡ºç¨‹åºä¹‹é—´çš„ç›¸ä¼¼æ€§ï¼Œè¿›è¡Œâ€œå…ƒç¼–ç¨‹â€ã€‚è€Œåœ¨C++ä¸­ï¼Œå…ƒç¼–ç¨‹çš„æ‰‹æ®µï¼Œå¯ä»¥æ˜¯å®ï¼Œä¹Ÿå¯ä»¥æ˜¯æ¨¡æ¿ã€‚</p>
</blockquote>

<h4 id="template-specialization">Template Specialization</h4>

<p>æˆ‘ä»¬åº”å½“åŒºåˆ†æ¨¡æ¿ç‰¹åŒ–ä¸æ¨¡æ¿å®ä¾‹åŒ–çš„åŒºåˆ«ï¼Œå…¶å®å®ä¾‹åŒ–ï¼ˆ<code class="language-plaintext highlighter-rouge">template instantiation</code>ä¹Ÿå¯ä»¥è¢«å«åšæ¨¡æ¿å®ä¾‹åŒ–çš„ç‰¹ä¾‹ï¼ˆ<code class="language-plaintext highlighter-rouge">instantiated/generated specialization</code>ï¼‰ï¼‰æ¨¡æ¿ç‰¹åŒ–åˆåˆ†ä¸º<code class="language-plaintext highlighter-rouge">Explicit/full specialization</code>ä¸<code class="language-plaintext highlighter-rouge">Partial template specialization</code>(æ¨¡æ¿åç‰¹åŒ–)ä¸¤ç§ã€‚å¯¹äºæ¨¡æ¿ç‰¹åŒ–ï¼Œé¦–å…ˆæˆ‘ä»¬è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹è§„åˆ™ï¼š</p>

<ol>
  <li>åœ¨å®šä¹‰æ¨¡æ¿ç‰¹ä¾‹ä¹‹å‰åº”å½“æœ‰æ¨¡æ¿é€šä¾‹ï¼ˆ<code class="language-plaintext highlighter-rouge">generic template/primary template</code>ï¼‰åœ¨å…ˆ</li>
  <li>æ¨¡æ¿<strong>åç‰¹åŒ–</strong>ï¼ˆ<code class="language-plaintext highlighter-rouge">partial template specialization</code>ï¼‰åªé€‚ç”¨äº<code class="language-plaintext highlighter-rouge">class template</code>å’Œ<code class="language-plaintext highlighter-rouge">variable template</code>ã€‚</li>
  <li>æ¨¡æ¿ç‰¹åŒ–çš„åŒ¹é…è§„åˆ™éµå¾ªä»¥ä¸‹é¡ºåºï¼š</li>
</ol>

<blockquote>
  <ul>
    <li>
      <p>If only one specialization matches the template arguments, that specialization is used</p>
    </li>
    <li>
      <p>If more than one specialization matches, partial order rules are used to determine which specialization is more specialized. The most specialized specialization is used, if it is unique (if it is not unique, the program cannot be compiled)</p>
    </li>
    <li>
      <p>If no specializations match, the primary template is used</p>
    </li>
  </ul>
</blockquote>

<p>è¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨å…ˆå‰æåˆ°è¿‡çš„<code class="language-plaintext highlighter-rouge">Partial ordering</code>æ–¹æ³•ï¼Œåªä¸è¿‡åœ¨æ¨¡æ¿ç‰¹åŒ–è¿™é‡Œè¢«ä½¿ç”¨å¹¶æ˜ç¡®äº†ã€‚ç®€è€Œè¨€ä¹‹ï¼Œ<strong>ä»ç‰¹ä¾‹åˆ°é€šä¾‹</strong>ï¼Œä»<code class="language-plaintext highlighter-rouge">more specializaed</code>åˆ°<code class="language-plaintext highlighter-rouge">less specialized</code>ã€‚</p>

<h4 id="template-specialization-examples">Template Specialization Examples</h4>

<pre><code class="language-C++">// primary template
template &lt;typename T&gt; class TypeToID
{
public:
    static int const ID = -1;
};
// specialization template
template &lt;&gt; class TypeToID&lt;uint8_t&gt;
{
public:
    static int const ID = 0;
};
</code></pre>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æ¨¡æ¿ç‰¹åŒ–æ—¶ï¼Œå¦‚æœæˆ‘ä»¬ç‰¹åŒ–çš„ç±»å‹ä¸éœ€è¦ä¾èµ–æ¨¡æ¿å‚æ•°<code class="language-plaintext highlighter-rouge">T</code>ï¼Œé‚£æˆ‘ä»¬å°±ä¸éœ€è¦ä¹Ÿä¸èƒ½åœ¨<code class="language-plaintext highlighter-rouge">specialiazed template</code>ä¸­çš„<code class="language-plaintext highlighter-rouge">&lt;&gt;</code>ä½ç½®å†™ä»»ä½•ä¸œè¥¿ï¼Œå› ä¸ºä»–çš„ä½ç½®å·²ç»è¢«å…¶åçš„<code class="language-plaintext highlighter-rouge">int</code>å é¢†äº†ï¼š</p>

<pre><code class="language-C++">// use float specialization
template &lt;&gt; class TypeToID&lt;float&gt;
{
  static int const ID = 0xF10A7;
};
// use void* specialization
template &lt;&gt; class TypeToID&lt;void*&gt;
{
  static int const ID = 0x401d;
};
</code></pre>

<p>ä½†æœ‰äº›æ—¶å€™æˆ‘ä»¬ä¸å¾—ä¸ç»™å…¥ä¸€ä¸ªæ¨¡æ¿å‚æ•°<code class="language-plaintext highlighter-rouge">T</code>æ¥è¿›è¡Œæ¨¡æ¿ç‰¹åŒ–ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦ç‰¹åŒ–æ‰€æœ‰æŒ‡é’ˆç±»å‹ï¼š</p>

<pre><code class="language-C++">template &lt;typename T&gt;                    // å—¯ï¼Œéœ€è¦ä¸€ä¸ªT
class TypeToID&lt;T*&gt;                        // æˆ‘è¦å¯¹æ‰€æœ‰çš„æŒ‡é’ˆç±»å‹ç‰¹åŒ–ï¼Œæ‰€ä»¥è¿™é‡Œå°±å†™T*
{
public:
    typedef T         SameAsT;
    static int const ID = 0x80000000;    // ç”¨æœ€é«˜ä½è¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªæŒ‡é’ˆ
};
</code></pre>

<p>åœ¨è¿›è¡Œæ¨¡æ¿ç‰¹åŒ–æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œç‰¹åŒ–çš„æ¨¡æ¿å¯ä»¥æŠŠæˆ‘ä»¬æä¾›çš„ç±»å‹ä¸­çš„<code class="language-plaintext highlighter-rouge">const</code>æˆ–è€…<code class="language-plaintext highlighter-rouge">*</code>ç»™å»æ‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬ç»™å¦‚ä¸‹çš„æ¨¡æ¿å®šä¹‰åˆ†åˆ«æä¾›<code class="language-plaintext highlighter-rouge">float*</code>ä¸<code class="language-plaintext highlighter-rouge">const int</code>æ—¶ï¼Œå…¶ä¸­å¯¹åº”çš„<code class="language-plaintext highlighter-rouge">T</code>åˆ†åˆ«å˜æˆäº†<code class="language-plaintext highlighter-rouge">float</code>ä¸<code class="language-plaintext highlighter-rouge">int</code>:</p>

<pre><code class="language-C++">// float* -&gt; T:float
template &lt;typename T&gt;
class RemovePointer&lt;T*&gt; {
public:
    typedef T Result;
};

// const int -&gt; T:int
template&lt;typename T&gt;
class RemovePointer&lt;const T&gt; {
public:
    using type = T;
};
</code></pre>

<p>åœ¨ç»§ç»­è¿›è¡Œæˆ‘ä»¬çš„ä¸»é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥å¯¹æ¨¡æ¿ä¸­çš„åç§°æŸ¥æ‰¾é—®é¢˜è¿›è¡Œè§£å†³ï¼Œè¿™ä¼šå¸®åŠ©æˆ‘ä»¬ç†è§£ä¹‹åçš„ä¾‹å­ã€‚</p>

<h4 id="name-resolution">Name Resolution</h4>

<p>åœ¨ä¸€å¼€å§‹ç»™åˆ°çš„æ–‡ç« ä¸­ï¼Œæåˆ°äº†<code class="language-plaintext highlighter-rouge">Name Resolution</code>è¿™ä¸€æ¦‚å¿µï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111231726211.png" alt="image-20211123172604046" style="zoom:50%;" /></p>

<p>è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¨¡æ¿ä¸­çš„åç§°å¯ä»¥è¢«åˆ†ä¸ºä¸¤ä¸ªå¤§ç±»ï¼š<strong>ä¾èµ–æ€§åç§°</strong>ä¸<strong>éä¾èµ–æ€§åç§°</strong>ã€‚è€Œä»–ä»¬è¢«ç¨‹åºè¿›è¡Œ<code class="language-plaintext highlighter-rouge">name lookup</code>çš„æ—¶æœºä¹Ÿä¸ç›¸åŒï¼š<code class="language-plaintext highlighter-rouge">Non-dependent names</code>ä¼šè¢«ç¨‹åºåœ¨æ¨¡æ¿å®šä¹‰çš„æ—¶å€™æŸ¥æ‰¾ï¼Œå¯æ˜¯<code class="language-plaintext highlighter-rouge">dependent names</code>åªæœ‰å½“<strong>æ¨¡æ¿è¢«å®ä¾‹åŒ–</strong>æ—¶æ‰è¢«æŸ¥æ‰¾åˆ°ï¼Œå› ä¸ºä»–ä»¬éƒ½æ˜¯ä¸æ¨¡æ¿å‚æ•°æœ‰å…³çš„ï¼Œä¾èµ–äºæ¨¡æ¿å‚æ•°ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨æ¨¡æ¿è¿™ä¸€èŠ‚å¼€å§‹æ—¶æåˆ°çš„<code class="language-plaintext highlighter-rouge">name lookup</code>è¿‡ç¨‹ä¼šåœ¨æ¨¡æ¿å®šä¹‰å’Œå®ä¾‹åŒ–æ—¶å„åšä¸€æ¬¡ï¼Œåˆ†åˆ«å¤„ç†<code class="language-plaintext highlighter-rouge">Non-dependent names</code>ä¸<code class="language-plaintext highlighter-rouge">dependent names</code>ã€‚è¿™ä¸€æœºåˆ¶è¢«ç§°ä¸º<strong>Two phase name lookup</strong>ã€‚</p>

<blockquote>
  <p>åŸºäºè¿™ç§ç‰¹æ€§ï¼Œå¯¹äºä¸€ä¸ªå¤šæ–‡ä»¶çš„é¡¹ç›®ï¼Œæˆ‘ä»¬å¿…é¡»æŠŠæ¨¡æ¿ç±»æˆ–è€…æ¨¡æ¿å‡½æ•°çš„å£°æ˜ä¸å®ç°æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæ ¹æ®<a href="https://www.cplusplus.com/doc/oldtutorial/templates/">å®˜æ–¹æ–‡æ¡£</a>ï¼š</p>

  <blockquote>
    <p>Because templates are compiled when required, this forces a restriction for multi-file projects: the implementation (definition) of a template class or function must be in the same file as its declaration. That means that we cannot separate the interface in a separate header file, and that we must include both interface and implementation in any file that uses the templates.</p>
  </blockquote>
</blockquote>

<h5 id="why-use-typename">Why use typename?</h5>

<p>æ­£å› ä¸ºè¿™ä¸€<code class="language-plaintext highlighter-rouge">Two phase name lookup</code>çš„ç‰¹æ€§ï¼Œ<code class="language-plaintext highlighter-rouge">typename</code>å…³é”®å­—åœ¨æ¨¡æ¿å®šä¹‰å†…æ´¾ä¸Šäº†ç”¨åœºã€‚</p>

<pre><code class="language-C++">template &lt;typename T&gt; struct X {};

template &lt;typename T&gt; struct Y
{   
    // X[T] is a dependent name on template parameter T
    // which will be lookup during the template instantaition
    // not the template definition period
    typedef X&lt;T&gt; ReboundType;                        
    typedef typename X&lt;T&gt;::MemberType MemberType2;    // è¿™é‡Œçš„typenameæ˜¯åšä»€ä¹ˆçš„ï¼Ÿ
};
</code></pre>

<p>è¿™é‡Œä½¿ç”¨<code class="language-plaintext highlighter-rouge">typename</code>çš„ç›®çš„ç®€è€Œè¨€ä¹‹ï¼Œå°±æ˜¯<strong>C++</strong>æ ‡å‡†è§„å®šï¼Œ<code class="language-plaintext highlighter-rouge">T::type</code>çš„å½¢å¼ä¸ä»…å¯ä»¥æ˜¯ä¸€ä¸ªç±»å‹ï¼Œè¿˜å¯ä»¥æ˜¯<code class="language-plaintext highlighter-rouge">T</code>çš„ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œ<strong>å¦‚æœç¼–è¯‘å™¨èƒ½å¤Ÿåœ¨æ¨¡æ¿å®šä¹‰ï¼ˆè¯¥å½¢å¼å‡ºç°ï¼‰æ—¶å°±æ˜ç¡®çŸ¥é“å®ƒçš„ç±»å‹ï¼Œå°±ä¸éœ€è¦åŠ <code class="language-plaintext highlighter-rouge">typename</code>ï¼›å¦‚æœè¦ç­‰åˆ°äºŒé˜¶æ®µï¼Œå³æ¨¡æ¿å®ä¾‹åŒ–æ—¶æ‰çŸ¥é“å®ƒæ˜¯å¦åˆæ³•ï¼ˆåˆ°åº•æ˜¯ä¸ªå˜é‡è¿˜æ˜¯ä¸ªç±»å‹ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¿…é¡»ä½¿ç”¨<code class="language-plaintext highlighter-rouge">typename</code>æ˜ç¡®æŒ‡å®šè¿™æ˜¯ä¸€ä¸ªç±»å‹ã€‚</strong>æ›´å¤šçš„ä¾‹å­å‚è§åŸæ–‡ç« ã€‚</p>

<h4 id="type-computations">Type Computations</h4>

<p>ä¸<code class="language-plaintext highlighter-rouge">Computations on Types</code>ç›¸å¯¹åº”çš„æ˜¯<code class="language-plaintext highlighter-rouge">Computations on Values</code>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="c1">// computations on values</span>
<span class="k">using</span> <span class="n">S</span> <span class="o">=</span> <span class="kt">int</span><span class="p">;</span> <span class="c1">// computations on types</span>

<span class="kt">int</span> <span class="n">triple</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">s</span><span class="p">;</span> <span class="c1">// computations on values</span>
<span class="k">using</span> <span class="n">cl_ref</span> <span class="o">=</span> <span class="k">const</span> <span class="n">S</span><span class="o">&amp;</span><span class="p">;</span> <span class="c1">// computations on types</span>

<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">foo</span><span class="p">(</span><span class="n">triple</span><span class="p">);</span> <span class="c1">// computations on values</span>
<span class="k">using</span> <span class="n">result</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">remove_reference</span><span class="o">&lt;</span><span class="n">cl_ref</span><span class="o">&gt;::</span><span class="n">type</span><span class="p">;</span> <span class="c1">// computations on types</span>

<span class="kt">bool</span> <span class="n">equals</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// computations on values</span>
<span class="k">constexpr</span> <span class="kt">bool</span> <span class="n">equals</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">result</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span> <span class="c1">// computations on types</span>

<span class="k">if</span> <span class="p">(</span><span class="n">equals</span><span class="p">)</span> <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// computations on values</span>
<span class="k">if</span> <span class="nf">constexpr</span> <span class="p">(</span><span class="n">equals</span><span class="p">)</span> <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// computations on types</span>
</code></pre></div></div>

<p>æˆ‘ä»¬é€šè¿‡å°†<code class="language-plaintext highlighter-rouge">type</code>ä¼ é€’ç»™<em>meta_function</em>å®ç°è¿™ä¸€ç‚¹ã€‚</p>

<blockquote>
  <p>A meta-function is a â€œfunctionâ€ that operates on some <strong>types</strong>/values (parameters) and outputs some <strong>types</strong>/values (return values). Concretely, it is a <strong>struct</strong> that has <strong>public member types/fields</strong> which depend on what the <strong>template types/values</strong> are instantiated with.</p>
</blockquote>

<p>æ¯”å¦‚ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// a value meta-function: identity</span>
<span class="k">template</span><span class="o">&lt;</span><span class="kt">int</span> <span class="n">V</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">identity</span> <span class="p">{</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">V</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// a type meta-function: identity</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">identity</span> <span class="p">{</span>
    <span class="k">using</span> <span class="n">type</span> <span class="o">=</span> <span class="n">T</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>åœ¨ç¬¬ä¸€ä¸ªç»“æ„ä½“ä¸­ä½¿ç”¨<code class="language-plaintext highlighter-rouge">static</code>å…³é”®å­—çš„ä½œç”¨æ˜¯ï¼Œå…è®¸æˆ‘ä»¬åœ¨ä¸å®ä¾‹åŒ–ç»“æ„ä½“ï¼ˆæˆ–è€…ç±»ï¼‰çš„æ—¶å€™ä½¿ç”¨å…¶æˆå‘˜ï¼ˆä»–ä»¬åœ¨å®šä¹‰çš„æ—¶å€™å°±å­˜åœ¨äº†ï¼‰ï¼Œå³ï¼š</p>

  <p>```c++
int val = identity&lt;3&gt;::value;</p>
</blockquote>

<p>é‚£ä¹ˆè¿™ç§<code class="language-plaintext highlighter-rouge">meta-function</code>æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ</p>

<h4 id="type_traits">type_traits</h4>

<p>æˆ‘ä»¬ç»“åˆ<code class="language-plaintext highlighter-rouge">meta-function</code>çš„çŸ¥è¯†ï¼Œä»¥åŠå…ˆå‰æˆ‘ä»¬å¯¹æ¨¡æ¿ç‰¹ä¾‹åŒ–ï¼ˆ<code class="language-plaintext highlighter-rouge">template specialization</code>ï¼‰çš„äº†è§£ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥å¾—çŸ¥<strong>C++</strong>å†…ç½®çš„<code class="language-plaintext highlighter-rouge">type traits</code>åº“æ˜¯åœ¨åšä»€ä¹ˆäº‹æƒ…äº†ï¼Œå¹¶ä¸”ä¸ºä»€ä¹ˆæˆ‘ä»¬ç»å¸¸é‡åˆ°<code class="language-plaintext highlighter-rouge">::type</code>æˆ–è€…<code class="language-plaintext highlighter-rouge">::value</code>çš„å†™æ³•ã€‚è¿™é‡Œåªéœ€è¦ä¸€ä¸ªä¾‹å­ï¼Œå°±å¯ä»¥è¯´æ˜é—®é¢˜ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// primary/generic template</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">is_pointer</span> <span class="p">{</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">bool</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// specializaed template</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">is_pointer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span> <span class="p">{</span>
    <span class="k">static</span> <span class="k">const</span> <span class="kt">bool</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å¦‚æ­¤ä¸€æ¥ï¼Œæ ¹æ®<code class="language-plaintext highlighter-rouge">partial ordering</code>çš„è§„åˆ™ï¼Œå¦‚æœæˆ‘ä»¬ä¼ å…¥ä¸€ä¸ªæŒ‡é’ˆï¼Œé‚£ä¹ˆ<code class="language-plaintext highlighter-rouge">is_pointer&lt;int*&gt;::value</code>åº”å½“ä¸º<code class="language-plaintext highlighter-rouge">true</code>ï¼Œå¦‚æœä¸æ˜¯æŒ‡é’ˆï¼Œåˆ™æ— æ³•åŒ¹é…<code class="language-plaintext highlighter-rouge">specialized template</code>ï¼Œä¼šä½¿ç”¨é€šä¾‹æ¨¡æ¿ï¼Œæœ€ç»ˆè¿”å›<code class="language-plaintext highlighter-rouge">false</code>ã€‚</p>

<h4 id="examples">Examples</h4>

<p>æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚è¿™é‡Œæˆ‘ä»¬æƒ³å†™ä¸€ä¸ªæ ‡å‡†åº“é‡Œ<code class="language-plaintext highlighter-rouge">iterator</code>çš„<code class="language-plaintext highlighter-rouge">distance</code>å‡½æ•°ï¼Œå¤§è‡´çš„ç»“æ„åº”è¯¥æ˜¯è¿™æ ·ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">It</span><span class="p">&gt;</span>
<span class="kt">size_t</span> <span class="nf">my_distance</span><span class="p">(</span><span class="n">It</span> <span class="n">first</span><span class="p">,</span> <span class="n">It</span> <span class="n">last</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// if it_category == random_access_Iterator</span>
    <span class="c1">// then</span>
    <span class="c1">// return last - first</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="kt">size_t</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">first</span> <span class="o">!=</span> <span class="n">last</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">++</span><span class="n">first</span><span class="p">;</span>
            <span class="o">++</span><span class="n">result</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç°åœ¨çš„é—®é¢˜åœ¨äºæˆ‘ä»¬é¦–å…ˆè¦æ‰¾åˆ°ä¸€ä¸ªåŠæ³•èƒ½æ‹¿åˆ°è¿­ä»£å™¨çš„ç±»å‹ã€‚äºæ˜¯æˆ‘ä»¬æƒ³åˆ°äº†æˆ‘ä»¬çš„<code class="language-plaintext highlighter-rouge">meta functions</code>å’Œ<strong>C++</strong>çš„<code class="language-plaintext highlighter-rouge">type traits</code>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">It</span><span class="p">&gt;</span>
<span class="kt">size_t</span> <span class="nf">my_distance</span><span class="p">(</span><span class="n">It</span> <span class="n">first</span><span class="p">,</span> <span class="n">It</span> <span class="n">last</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// notice! typename, lol we just introduced its effect</span>
    <span class="k">using</span> <span class="n">category</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">iterator_traits</span><span class="o">&lt;</span><span class="n">It</span><span class="o">&gt;::</span><span class="n">iterator_category</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">category</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">random_access_iterator_tag</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">last</span> <span class="o">-</span> <span class="n">first</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="kt">size_t</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">first</span> <span class="o">!=</span> <span class="n">last</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">++</span><span class="n">first</span><span class="p">;</span>
            <span class="o">++</span><span class="n">result</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>ä½†æ˜¯ï¼</strong>è¿™ä¸ªä¾‹å­ç›®å‰å¹¶ä¸å®Œç¾ï¼Œä»–æ— æ³•ç¼–è¯‘é€šè¿‡ï¼ŒåŸå› æ­£æ˜¯æˆ‘ä»¬ä¹‹å‰æ€»ç»“çš„-æ²¡æœ‰åˆ©ç”¨<strong>SFINAE</strong>ï¼</p>

<p>åœ¨<strong>C++17</strong>ä¸­ï¼Œå¾ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€åšå¦‚ä¸‹æ”¹å†™ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">It</span><span class="p">&gt;</span>
<span class="kt">size_t</span> <span class="nf">my_distance</span><span class="p">(</span><span class="n">It</span> <span class="n">first</span><span class="p">,</span> <span class="n">It</span> <span class="n">last</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// notice! typename, lol we just introduced its effect</span>
    <span class="k">using</span> <span class="n">category</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">iterator_traits</span><span class="o">&lt;</span><span class="n">It</span><span class="o">&gt;::</span><span class="n">iterator_category</span><span class="p">;</span>
    <span class="k">if</span> <span class="k">constexpr</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">category</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">random_access_iterator_tag</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">last</span> <span class="o">-</span> <span class="n">first</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="kt">size_t</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">first</span> <span class="o">!=</span> <span class="n">last</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">++</span><span class="n">first</span><span class="p">;</span>
            <span class="o">++</span><span class="n">result</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="lambda-expressions">Lambda Expressions</h3>

<p><a href="https://www.cppstories.com/2020/08/lambda-generic.html/">1</a>è¯é¢˜çš„å¼•å…¥æ¥è‡ªäºè¯¥å‡½æ•°ä¸­çš„<code class="language-plaintext highlighter-rouge">predicate</code>ï¼Œæˆ‘ä»¬å°è¯•ç€å°†å®ƒå†™åšä¸€ä¸ªéå›ºå®šæœ€å¤§å€¼çš„ç‰ˆæœ¬ï¼Œå³å°†ä¸‹è¾¹çš„5æ›¿æ¢ä¸ºä¸€ä¸ª<code class="language-plaintext highlighter-rouge">limit</code>å˜é‡ï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111140037577.png" alt="image-20211114003742461" style="zoom:50%;" /></p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111140038721.png" alt="image-20211114003814642" style="zoom:50%;" /></p>

<blockquote>
  <p>call it by using function pointers</p>
</blockquote>

<h4 id="pre-c11functors">Pre-C++11(Functors)</h4>

<p>åœ¨<strong>C++11</strong>ä¹‹å‰ï¼Œæˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹æ–¹æ³•ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// by value</span>
<span class="k">class</span> <span class="nc">GreaterThan</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">GreaterThan</span><span class="p">(</span><span class="kt">int</span> <span class="n">limit</span><span class="p">)</span> <span class="o">:</span> <span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span> <span class="p">{}</span>
    <span class="c1">// note: this should have a const</span>
    <span class="kt">bool</span> <span class="k">operator</span><span class="p">()</span> <span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">val</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">};</span>
<span class="nl">private:</span>
    <span class="kt">int</span> <span class="n">limit</span><span class="p">;</span> <span class="cm">/* the value we captured outside*/</span>
<span class="p">}</span>

<span class="c1">// by reference</span>
<span class="k">class</span> <span class="nc">GreaterThan</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">GreaterThan</span><span class="p">(</span><span class="kt">int</span> <span class="o">&amp;</span><span class="n">limit</span><span class="p">)</span> <span class="o">:</span> <span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span> <span class="p">{}</span><span class="cm">/* pass by reference */</span>
    <span class="c1">// note: this should have a const</span>
    <span class="kt">bool</span> <span class="k">operator</span><span class="p">()</span> <span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">val</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">};</span>
<span class="nl">private:</span>
    <span class="kt">int</span><span class="o">&amp;</span> <span class="n">limit</span><span class="p">;</span> <span class="cm">/* the value we captured outside, by reference*/</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åœ¨<strong>C++11</strong>ä¸­å¼•å…¥äº†<code class="language-plaintext highlighter-rouge">lambda expression</code>:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">func</span> <span class="o">=</span> <span class="p">[</span><span class="n">capture</span><span class="o">-</span><span class="n">clause</span><span class="p">](</span><span class="n">parameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">return</span><span class="o">-</span><span class="n">value</span> <span class="p">{</span>
<span class="c1">// body</span>
<span class="p">};</span>

<span class="c1">// the simplest lambda:</span>
<span class="p">[]{};</span>
</code></pre></div></div>

<blockquote>
  <ul>
    <li><code class="language-plaintext highlighter-rouge">return-value</code> is optional</li>
    <li>can use <code class="language-plaintext highlighter-rouge">=</code> to capture all by value (<strong>not</strong> recommend)</li>
    <li>can use <code class="language-plaintext highlighter-rouge">&amp;</code> to capture all by reference (<strong>not</strong> recommend)</li>
  </ul>
</blockquote>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨<strong>C++11</strong>ä¸­å¼•å‡ºäº†ä¸€ç§è¿”å›å€¼çš„å†™æ³•ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">identifier</span><span class="p">(</span><span class="n">argument</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">return</span> <span class="n">type</span>
</code></pre></div></div>

<p>è¿™ç§å†™æ³•å¸®åŠ©æˆ‘ä»¬å†™å‡ºå¦‚ä¸‹å‡½æ•°ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T1</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">T2</span><span class="p">&gt;</span>
<span class="k">auto</span> <span class="nf">compose</span><span class="p">(</span><span class="n">T1</span> <span class="n">a</span><span class="p">,</span> <span class="n">T2</span> <span class="n">b</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">decltype</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">);</span>
</code></pre></div></div>

<p>è€Œåœ¨<strong>C++14</strong>ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥çœç•¥<code class="language-plaintext highlighter-rouge">-&gt;return type</code>ã€‚</p>

<h4 id="c14">C++14</h4>

<ol>
  <li>
    <p>can use <code class="language-plaintext highlighter-rouge">auto</code> as the parameters to templatize the lambdaâ€“<strong>generic lambda</strong></p>
  </li>
  <li>
    <p>can capture with an initialiserâ€“<code class="language-plaintext highlighter-rouge">z = x + y</code></p>
  </li>
</ol>

<h4 id="c17">C++17</h4>

<ol>
  <li>use <code class="language-plaintext highlighter-rouge">constexpr</code> :</li>
</ol>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">constexpr</span> <span class="k">auto</span> <span class="n">Square</span> <span class="o">=</span> <span class="p">[](</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">n</span> <span class="o">*</span> <span class="n">n</span><span class="p">;</span> <span class="p">};</span>
</code></pre></div></div>

<ol>
  <li>can capture <code class="language-plaintext highlighter-rouge">*this</code></li>
</ol>

<h4 id="c20">C++20</h4>

<p>We can pass a template tail:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">ForwardToTestFunc</span> <span class="o">=</span> <span class="p">[]</span><span class="o">&lt;</span><span class="k">typename</span> <span class="p">...</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;&amp;</span> <span class="p">...</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">TestFunc</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">args</span><span class="p">)...);</span>
<span class="p">};</span>
</code></pre></div></div>

<h4 id="mutable">mutable</h4>

<p>è®©æˆ‘ä»¬æŠŠæ³¨æ„åŠ›ç§»å›åˆ°<strong>C++11</strong>ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œä¸¥æ ¼æ¥è¯´ï¼Œæˆå‘˜å‡½æ•°<code class="language-plaintext highlighter-rouge">operator()</code>çš„é‡è½½åº”å½“è®¾ç½®ä¸€ä¸ª<strong>æŒ‡å‘å¸¸é‡å¯¹è±¡çš„å¸¸é‡æŒ‡é’ˆ</strong>ï¼Œå³å†™ä¸ºï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="k">operator</span><span class="p">()(...)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="c1">// since there is a const,</span>
    <span class="c1">// if captured by reference, we can change the values captured</span>
    <span class="c1">// if captured by value, we cannot change it.</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æ‰€ä»¥å…³é”®å­—<code class="language-plaintext highlighter-rouge">mutable</code>å…è®¸æˆ‘ä»¬æ”¹å˜æ•è·çš„å€¼ã€‚</p>

<h4 id="globals--statics">globals &amp; statics</h4>

<p><code class="language-plaintext highlighter-rouge">lambda</code>è¡¨è¾¾å¼ä»…å…è®¸æ•æ‰å…·æœ‰<code class="language-plaintext highlighter-rouge">automatic storage duration</code>çš„å˜é‡ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½å¤Ÿæ•æ‰<code class="language-plaintext highlighter-rouge">global/static variables</code>:</p>

<h5 id="storage-duration">storage duration</h5>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111142007243.png" alt="image-20211114200707114" style="zoom:50%;" /></p>

<h3 id="stdbind">std::bind</h3>

<p>é™¤äº†<code class="language-plaintext highlighter-rouge">lambda expression</code>ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨å¤´æ–‡ä»¶<code class="language-plaintext highlighter-rouge">&lt;functional&gt;</code>ä¸­çš„<code class="language-plaintext highlighter-rouge">bind</code>æ–¹æ³•æ¥å†™å…ˆå‰æˆ‘ä»¬æ‰€éœ€è¦çš„<code class="language-plaintext highlighter-rouge">predicate</code>å‡½æ•°,æ ¹æ®<a href="https://en.cppreference.com/w/cpp/utility/functional/bind">å®˜æ–¹æ–‡æ¡£</a>ç»™å‡ºçš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥ç»“åˆå ä½ç¬¦<code class="language-plaintext highlighter-rouge">std::placeholders</code>æ¥ä½¿ç”¨è¯¥å‡½æ•°ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="o">::</span><span class="n">placeholders</span><span class="p">;</span>  <span class="c1">// for _1, _2, _3...</span>

<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"1) argument reordering and pass-by-reference: "</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="c1">// (_1 and _2 are from std::placeholders, and represent future</span>
<span class="c1">// arguments that will be passed to f1)</span>
<span class="k">auto</span> <span class="n">f1</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">_2</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="n">_1</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">cref</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">n</span><span class="p">);</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">f1</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1001</span><span class="p">);</span> <span class="c1">// 1 is bound by _1, 2 is bound by _2, 1001 is unused</span>
                <span class="c1">// makes a call to f(2, 42, 1, n, 7)</span>
</code></pre></div></div>

<p>åœ¨è¯¥æ®µç¤ºä¾‹ä»£ç ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">std::cref(n)</code>çš„ä½œç”¨æ˜¯ä¸º<code class="language-plaintext highlighter-rouge">n</code>åˆ›å»ºä¸€ä¸ª<code class="language-plaintext highlighter-rouge">reference_wrapper</code>çš„å¯¹è±¡ï¼Œä¸ä¹‹æœ‰ç›¸åŒä½œç”¨çš„è¿˜æœ‰å‡½æ•°<code class="language-plaintext highlighter-rouge">std::ref(n)</code>ï¼š</p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">std::reference_wrapper</code> is a class template that wraps a reference in a copyable, assignable object. It is frequently used as a mechanism to store references inside standard containers (like <a href="https://en.cppreference.com/w/cpp/container/vector" title="cpp/container/vector">std::vector</a>) which cannot normally hold references.</p>
</blockquote>

<p>æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹è¯­æ³•ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">reference_wrapper</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;&gt;</span> <span class="n">v</span><span class="p">(</span><span class="n">l</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">l</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
</code></pre></div></div>

<p>å¦‚æ­¤ä¸€æ¥ï¼Œ<code class="language-plaintext highlighter-rouge">v</code>å†…æ‰€æœ‰å…ƒç´ å‡æ˜¯<code class="language-plaintext highlighter-rouge">vector l</code>å†…å…ƒç´ çš„å¼•ç”¨ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">bind()</code>å‡½æ•°ä¼šç»™åŸå‡½æ•°åˆ›å»ºä¸€ä¸ª<code class="language-plaintext highlighter-rouge">call wrapper</code>ï¼Œè°ƒç”¨<code class="language-plaintext highlighter-rouge">wrapper</code>å‡½æ•°ç›¸å½“äº<code class="language-plaintext highlighter-rouge">invoke f with some of its arguments bound to args</code>.å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ<code class="language-plaintext highlighter-rouge">bind</code>å‡½æ•°å£°æ˜ä¹Ÿæ˜¯é€šè¿‡<strong>å¯å˜å‡½æ•°å‚æ•°</strong>å®ç°çš„ã€‚</p>

<h3 id="variadic-template">Variadic template</h3>

<h4 id="variadic-arguments">Variadic arguments</h4>

<p><a href="https://eli.thegreenplace.net/2014/variadic-templates-in-c/">1</a>åœ¨<strong>C++11</strong>ä¹‹å‰ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è®©ä¸€ä¸ªå‡½æ•°æ¥å—ä»»æ„å‚æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦ä½¿ç”¨<code class="language-plaintext highlighter-rouge">...</code>çš„è¯­æ³•é…åˆ<code class="language-plaintext highlighter-rouge">va_</code>ç³»åˆ—çš„å®æ¥ä½¿ç”¨ï¼Œ<a href="https://en.cppreference.com/w/cpp/utility/variadic">æ–‡æ¡£</a>ç»™å‡ºäº†ä¸€ä¸ªä¾‹å­ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;iostream&gt;
#include &lt;cstdarg&gt;
</span> 
<span class="kt">void</span> <span class="nf">simple_printf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">fmt</span><span class="p">...)</span> <span class="c1">// C-style "const char* fmt, ..." is also valid</span>
<span class="p">{</span>
    <span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
    <span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
 
    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span> <span class="o">==</span> <span class="sc">'d'</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
            <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span> <span class="o">==</span> <span class="sc">'c'</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// note automatic conversion to integral type</span>
            <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
            <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span> <span class="o">==</span> <span class="sc">'f'</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">double</span> <span class="n">d</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">double</span><span class="p">);</span>
            <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">d</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="o">++</span><span class="n">fmt</span><span class="p">;</span>
    <span class="p">}</span>
 
    <span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">simple_printf</span><span class="p">(</span><span class="s">"dcff"</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="sc">'a'</span><span class="p">,</span> <span class="mf">1.999</span><span class="p">,</span> <span class="mf">42.5</span><span class="p">);</span> 
<span class="p">}</span>
</code></pre></div></div>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111141728044.png" alt="image-20211114172837870" style="zoom:50%;" /></p>

<p>æˆ‘ä»¬é¦–å…ˆå»ºç«‹ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">va_list</code>çš„å¯¹è±¡ç”¨äºå‚¨å­˜ä½™ä¸‹å‡ ä¸ªå®éœ€è¦çš„ä¿¡æ¯ï¼Œä¹‹åè°ƒç”¨<code class="language-plaintext highlighter-rouge">va_start</code>ï¼Œå…è®¸ç¨‹åºè®¿é—®åéšå…·åå‚æ•°<code class="language-plaintext highlighter-rouge">parm_n</code>çš„å¯å˜å‚æ•°ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">va_start</span><span class="p">(</span> <span class="n">std</span><span class="o">::</span><span class="kt">va_list</span> <span class="n">ap</span><span class="p">,</span> <span class="n">parm_n</span> <span class="p">);</span>
</code></pre></div></div>

<p>ä¹‹åæ¯å½“æˆ‘ä»¬è°ƒç”¨ä¸€æ¬¡<code class="language-plaintext highlighter-rouge">va_arg</code>ï¼Œå°±å¯ä»¥è·å–<code class="language-plaintext highlighter-rouge">va_list</code>å†…çš„ä¸‹ä¸€ä¸ªå‚æ•°ï¼›æœ€ç»ˆè°ƒç”¨<code class="language-plaintext highlighter-rouge">va_end</code>ç»ˆæ­¢è¿™ä¸€è¿‡ç¨‹ã€‚</p>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä½¿ç”¨<code class="language-plaintext highlighter-rouge">variadic arguments</code>æ—¶ï¼Œ<code class="language-plaintext highlighter-rouge">...</code>å¿…é¡»è·Ÿéšåœ¨å‚æ•°åˆ—è¡¨ä¹‹åï¼Œè€Œä¸å…è®¸è¢«æ”¾åˆ°å‚æ•°åˆ—è¡¨çš„å‰è¾¹ã€‚ä½†æ˜¯åœ¨<strong>C++</strong>ä¸­ï¼Œè¿™æ ·çš„ä½¿ç”¨æ–¹å¼æ˜¯è¢«å…è®¸çš„ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">printz</span><span class="p">(...)</span>
</code></pre></div></div>

<p>è¿™ç§ä½¿ç”¨æ–¹å¼åœ¨æ¨¡æ¿é‡è½½ä¸­è¢«ä½œä¸º<code class="language-plaintext highlighter-rouge">SFINAE</code>çš„<code class="language-plaintext highlighter-rouge">fallback overload</code>ä½¿ç”¨ï¼Œå› ä¸º<code class="language-plaintext highlighter-rouge">...</code>æœ€ä¸<code class="language-plaintext highlighter-rouge">specialized</code>ï¼Œæ‰€ä»¥åœ¨<code class="language-plaintext highlighter-rouge">overload resolution</code>ä¸­å…·æœ‰æœ€ä½çš„ä¼˜å…ˆçº§ã€‚</p>

<blockquote>
  <p>fallback is a function that does not take any arguments and does not return anything.</p>
</blockquote>

<h4 id="parameter-pack">Parameter pack</h4>

<p>åœ¨ä¸Šä¸€èŠ‚ä¸­æåˆ°çš„<code class="language-plaintext highlighter-rouge">variadic argument</code>ä¸<code class="language-plaintext highlighter-rouge">parameter pack</code>ä¸ä¸€æ ·ï¼š</p>

<blockquote>
  <p>Note: this is different from a function <a href="https://en.cppreference.com/w/cpp/language/parameter_pack">parameter pack</a> expansion, which is indicated by an ellipsis that is a part of a parameter declarator, rather than an ellipsis that appears after all parameter declarations. Both parameter pack expansion and the â€œvariadicâ€ ellipsis may appear in the declaration of a function template, as in the case of <a href="https://en.cppreference.com/w/cpp/types/is_function">std::is_function</a>.</p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">parameter pack</code>æ˜¯æ„æˆ<code class="language-plaintext highlighter-rouge">variadic template</code>çš„åŸºç¡€ï¼š</p>

<blockquote>
  <p>A template with at least one parameter pack is called a <em>variadic template</em>.</p>
</blockquote>

<p>å…±æœ‰ä¸¤ç§å‚æ•°åŒ…ï¼š<strong>æ¨¡æ¿å‚æ•°åŒ…</strong>ä¸<strong>å‡½æ•°å‚æ•°åŒ…</strong>ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">,</span> <span class="k">typename</span><span class="o">...</span> <span class="nc">Args</span><span class="p">&gt;</span> <span class="c1">// a template parameter packet</span>
<span class="kt">void</span> <span class="nf">foo</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="k">const</span> <span class="n">Args</span><span class="o">&amp;</span><span class="p">...</span> <span class="n">rest</span><span class="p">);</span> <span class="c1">// a function parameter packet</span>
</code></pre></div></div>

<p>æˆ‘ä»¬å¦‚ä½•ç†è§£ä¸Šè¾¹çš„è¯­å¥ï¼Ÿå¯ä»¥ä¸¾ä¾‹æ¥æƒ³ï¼Œ<strong>æ¨¡æ¿å‚æ•°åŒ…</strong>ä¸­å°†å„ç§ä¸åŒçš„å¯èƒ½å‡ºç°çš„ç±»å‹ï¼ˆ<code class="language-plaintext highlighter-rouge">int, double, char* ...</code>ï¼‰æ‰“åŒ…ï¼Œä¹‹åæŠŠè¿™ä¸ªåŒ…äº¤ç»™å‡½æ•°ï¼Œå‡½æ•°å¯¹åŒ…<code class="language-plaintext highlighter-rouge">Args</code>åš<strong>åŒ…æ‰©å±•ï¼ˆ<code class="language-plaintext highlighter-rouge">packet expansion</code>ï¼‰</strong>ï¼Œä¼ å…¥çš„<strong>æ¯ä¸€ç§ç±»å‹</strong>éƒ½å¯èƒ½å­˜åœ¨å¤šä¸ªå…ƒç´ ï¼Œæ¯”å¦‚<code class="language-plaintext highlighter-rouge">double a, double b...</code>ï¼Œäºæ˜¯å¯¹æ¯ä¸€ç§ç±»å‹ï¼ˆå³æ¨¡æ¿å‚æ•°åŒ…ä¸­çš„æ¯ä¸€ä¸ªå¯¹åº”å…ƒç´ ï¼‰æ‰“åŒ…ã€ç»„åˆæˆä¸€ä¸ªåä¸º<code class="language-plaintext highlighter-rouge">rest</code>çš„<strong>å‡½æ•°å‚æ•°åŒ…</strong>ã€‚</p>

<blockquote>
  <p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äº<code class="language-plaintext highlighter-rouge">class template</code>ï¼Œå‚æ•°åŒ…åªèƒ½å‡ºç°åœ¨æœ€åä¸€ä¸ªå‚æ•°çš„ä½ç½®ä¸Šã€‚ä½†æ˜¯å¯¹äº<code class="language-plaintext highlighter-rouge">function template</code>ï¼Œå‚æ•°åŒ…å¯ä»¥å‡ºç°åœ¨ä»»æ„ä½ç½®ä¸Šã€‚</p>
</blockquote>

<h4 id="packet-expansion">Packet expansion</h4>

<p>åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæåˆ°äº†åŒ…æ‰©å±•ï¼š<em>patternâ€¦</em>ï¼Œ<strong>æ‰©å±•ä¸€ä¸ªåŒ…å°±æ˜¯å°†ä»–åˆ†è§£ä¸ºæ„æˆçš„å…ƒç´ ï¼Œå¹¶å¯¹æ¯ä¸ªå…ƒç´ åº”ç”¨æ¨¡å¼<code class="language-plaintext highlighter-rouge">pattern</code></strong>:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="o">...</span><span class="nc">Us</span><span class="p">&gt;</span> <span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="n">Us</span><span class="p">...</span> <span class="n">pargs</span><span class="p">)</span> <span class="p">{}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="o">...</span><span class="nc">Ts</span><span class="p">&gt;</span> <span class="kt">void</span> <span class="nf">g</span><span class="p">(</span><span class="n">Ts</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">f</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">...);</span> <span class="c1">// â€œ&amp;args...â€ is a pack expansion</span>
                 <span class="c1">// â€œ&amp;argsâ€ is its pattern</span>
<span class="p">}</span>
<span class="n">g</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s">"a"</span><span class="p">);</span> <span class="c1">// Ts... args expand to int E1, double E2, const char* E3</span>
                <span class="c1">// &amp;args... expands to &amp;E1, &amp;E2, &amp;E3</span>
                <span class="c1">// Us... pargs expand to int* E1, double* E2, const char** E3</span>
</code></pre></div></div>

<p>åŒ…æ‰©å±•å¯ä»¥å‡ºç°åœ¨å‡½æ•°è°ƒç”¨ç¬¦<code class="language-plaintext highlighter-rouge">()</code>å†…éƒ¨ï¼Œæ ¹æ®<a href="https://en.cppreference.com/w/cpp/language/parameter_pack#Pack_expansion">å®˜æ–¹æ–‡æ¡£</a>ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">f</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">...);</span> <span class="c1">// expands to f(&amp;E1, &amp;E2, &amp;E3)</span>
<span class="n">f</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">++</span><span class="n">args</span><span class="p">...);</span> <span class="c1">// expands to f(n, ++E1, ++E2, ++E3);</span>
<span class="n">f</span><span class="p">(</span><span class="o">++</span><span class="n">args</span><span class="p">...,</span> <span class="n">n</span><span class="p">);</span> <span class="c1">// expands to f(++E1, ++E2, ++E3, n);</span>
<span class="n">f</span><span class="p">(</span><span class="k">const_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Args</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">)...);</span>
<span class="c1">// f(const_cast&lt;const E1*&gt;(&amp;X1), const_cast&lt;const E2*&gt;(&amp;X2), const_cast&lt;const E3*&gt;(&amp;X3))</span>
<span class="n">f</span><span class="p">(</span><span class="n">h</span><span class="p">(</span><span class="n">args</span><span class="p">...)</span> <span class="o">+</span> <span class="n">args</span><span class="p">...);</span> <span class="c1">// expands to </span>
<span class="c1">// f(h(E1,E2,E3) + E1, h(E1,E2,E3) + E2, h(E1,E2,E3) + E3)</span>
</code></pre></div></div>

<p>ä¸€ä¸ªåŒ…æ‰©å±•çš„ä¾‹å­å¯å‚è§<em>C++ Primer</em> P621ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä¾‹ä¸­è¿›è¡Œå‡½æ•°è°ƒç”¨æ—¶çš„åŒ…æ‰©å±•ï¼Œå…ˆå°†åŒ…ä¸­ç¬¬ä¸€ä¸ªå‚æ•°å‰¥ç¦»ï¼ˆ<code class="language-plaintext highlighter-rouge">peel off</code>ï¼‰ï¼Œå¯¹åº”äº†<code class="language-plaintext highlighter-rouge">const T &amp;t</code>,ä½™ä¸‹çš„å…ƒç´ æ„æˆäº†æ–°çš„å‚æ•°åŒ…ï¼Œå¹¶é€’å½’è°ƒç”¨ï¼Œç›´åˆ°æˆ‘ä»¬é‡åˆ°äº†<code class="language-plaintext highlighter-rouge">base case</code>ï¼Œå¹¶ä½¿ç”¨å¯¹åº”äº†éå¯å˜å‚æ•°å‡½æ•°æ¨¡æ¿ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// base case function</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="n">ostream</span> <span class="o">&amp;</span><span class="n">print</span><span class="p">(</span><span class="n">ostream</span> <span class="o">&amp;</span><span class="n">os</span><span class="p">,</span> <span class="k">const</span> <span class="n">T</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">t</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">,</span> <span class="k">typename</span><span class="o">...</span> <span class="nc">Args</span><span class="p">&gt;</span>
<span class="c1">// the first packet expansion, using pattern `const Args&amp;`</span>
<span class="n">ostream</span><span class="o">&amp;</span> <span class="n">print</span><span class="p">(</span><span class="n">ostream</span> <span class="o">&amp;</span><span class="n">os</span><span class="p">,</span> <span class="k">const</span> <span class="n">T</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="k">const</span> <span class="n">Args</span><span class="o">&amp;</span><span class="p">...</span> <span class="n">rest</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">t</span> <span class="o">&lt;&lt;</span> <span class="s">", "</span><span class="p">;</span>
    <span class="c1">// the second packet expansion, using pattern `rest`</span>
    <span class="c1">// then peel off the first element in the expansion list to be `const T &amp;t`</span>
    <span class="c1">// recursion with the list with other elements</span>
    <span class="k">return</span> <span class="n">print</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">rest</span><span class="p">...);</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="sizeof"><code class="language-plaintext highlighter-rouge">sizeof...</code></h4>

<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨<code class="language-plaintext highlighter-rouge">sizeof...</code>å¾—åˆ°åŒ…ä¸­å‚æ•°çš„æ•°ç›®ã€‚</p>

<h4 id="performance">Performance</h4>

<p>æ‘˜è‡ªï¼šhttps://eli.thegreenplace.net/2014/variadic-templates-in-c/</p>

<blockquote>
  <p>If youâ€™re concerned with the performance of code that relies on variadic templates, worry not. As thereâ€™s no actual recursion involved, all we have is a sequence of function calls pre-generated at compile-time. This sequence is, in practice, fairly short (variadic calls with more than 5-6 arguments are rare). Since modern compilers are aggressively inlining code, itâ€™s likely to end up being compiled to machine code that has absolutely no function calls. What you end up with, actually, is not unlike loop unrolling.</p>

  <p>Compared to the C-style variadic functions, this is a marked win, because C-style variadic arguments have to be resolved at runtime. The <code class="language-plaintext highlighter-rouge">va_</code> macros are literally manipulating the runtime stack. Therefore, variadic templates are often a performance optimization for variadic functions.</p>
</blockquote>

<h3 id="range">range</h3>

<p>åœ¨<strong>C++20</strong>ä¸­ï¼Œæå‡ºäº†<code class="language-plaintext highlighter-rouge">range</code>çš„æ¦‚å¿µï¼Œå†™äº†ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">range</code>åº“ï¼Œå…¶ä¸­åŒ…å«<code class="language-plaintext highlighter-rouge">range</code>, <code class="language-plaintext highlighter-rouge">view</code>, <code class="language-plaintext highlighter-rouge">range adaptor</code>ç­‰â€¦â€¦ä½†è¿™é‡Œä¸æ‰“ç®—æ·±ç©¶ï¼Œå…·ä½“è¯¦è§å®˜æ–¹æ–‡æ¡£ä»¥åŠ<a href="https://www.zhihu.com/column/p/86809598">è¿™ç¯‡æ–‡ç« </a>ã€‚</p>

<h2 id="object-oriented-programming">Object-Oriented Programming</h2>

<h3 id="const">Const</h3>

<p>å‡ ç§ä¸åŒçš„<code class="language-plaintext highlighter-rouge">const</code>å«ä¹‰ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æŒ‡å‘æ•´å‹å¸¸é‡çš„æŒ‡é’ˆ(å¯ä¿®æ”¹æŒ‡é’ˆæœ¬èº«ï¼Œä¸å¯ä¿®æ”¹æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡)</span>
<span class="k">const</span> <span class="kt">int</span><span class="o">*</span> <span class="n">a</span><span class="p">;</span>
<span class="c1">// or:</span>
<span class="kt">int</span> <span class="k">const</span><span class="o">*</span> <span class="n">a</span><span class="p">;</span>

<span class="c1">// æŒ‡å‘æ•´å½¢çš„å¸¸é‡æŒ‡é’ˆ(ä¸å¯ä¿®æ”¹æŒ‡é’ˆæœ¬èº«ï¼Œå¯ä¿®æ”¹æŒ‡é’ˆæŒ‡å‘çš„å¯¹è±¡)</span>
<span class="kt">int</span><span class="o">*</span> <span class="k">const</span> <span class="n">a</span><span class="p">;</span>

<span class="c1">// æ ¹æ®ã€ŠC++ Primerã€‹ï¼ŒthisæŒ‡é’ˆé»˜è®¤ä¸ºæŒ‡å‘éå¸¸é‡å¯¹è±¡çš„å¸¸é‡æŒ‡é’ˆï¼Œ</span>
<span class="c1">// æ­¤æ“ä½œå°†thisæŒ‡é’ˆè®¾å®šä¸ºæŒ‡å‘å¸¸é‡å¯¹è±¡çš„å¸¸é‡æŒ‡é’ˆ</span>
<span class="kt">void</span> <span class="n">func</span><span class="p">()</span> <span class="k">const</span>
</code></pre></div></div>

<h4 id="why-initialization-list">Why initialization-list?</h4>

<p>åŠ å…¥æˆ‘ä»¬å°†å¯¹è±¡å®šä¹‰ä¸º<code class="language-plaintext highlighter-rouge">const</code>ç±»å‹ï¼Œé‚£ä¹ˆåœ¨å£°æ˜ä¹‹åï¼Œå¯¹è±¡å°±ä¸å¯ä»¥å†æ”¹å˜äº†ï¼Œè¿™æ„å‘³ç€ä¸€èˆ¬çš„æ„é€ å‡½æ•°åˆå§‹åŒ–æ–¹æ³•ä¼šå‡ºç°é—®é¢˜ï¼ˆå…ˆå»ºç«‹å¯¹è±¡ï¼Œå†æŒ¨ä¸ªåˆå§‹åŒ–å…¶å…ƒç´ ï¼‰ã€‚è€Œ<code class="language-plaintext highlighter-rouge">initialization list</code>åœ¨å»ºç«‹å¯¹è±¡çš„åŒæ—¶ç«‹å³åˆå§‹åŒ–å…¶æ‰€æœ‰å…ƒç´ ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">test</span><span class="p">(</span><span class="kt">int</span> <span class="n">num1</span><span class="p">,</span> <span class="kt">double</span> <span class="n">str1</span><span class="p">)</span><span class="o">:</span> <span class="n">num</span><span class="p">(</span><span class="n">num1</span><span class="p">),</span> <span class="n">str</span><span class="p">(</span><span class="n">str</span><span class="p">)</span> <span class="p">{};</span>
</code></pre></div></div>

<h3 id="friend">friend</h3>

<p><strong>ç›¸åŒclassçš„å„ä¸ªobjectsäº’ä¸ºå‹å…ƒ</strong>ï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111181413064.png" alt="img" style="zoom:50%;" /></p>

<h3 id="operators">Operators</h3>

<p>åŸºæœ¬çš„ç”¨ä¾‹ç•¥è¿‡ï¼Œè¿™é‡Œè®°å½•è¯¾ä»¶ä¸­å‡ ç‚¹å…³é”®çš„åŸåˆ™ï¼š</p>

<h4 id="general-rule-of-thumb">General rule of thumb</h4>

<ol>
  <li>Some operators must be implemented as members (
eg. [], (), -&gt;, =) due to C++ semantics.</li>
</ol>

<blockquote>
  <p>å› ä¸ºæˆå‘˜å‡½æ•°éšè—çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸€å®šæ˜¯<code class="language-plaintext highlighter-rouge">this</code>ï¼Œå³å¯¹è±¡çš„åœ°å€ï¼Œè€Œä½¿ç”¨è¿™äº›æ“ä½œç¬¦æ—¶æˆ‘ä»¬æ— æ³•åœ¨åˆ«å¤„æä¾›å¯¹è±¡åœ°å€.</p>
</blockquote>

<ol>
  <li>Some must be implemented as non-members (eg. Â«,
if you are writing class for rhs, not lhs).</li>
</ol>

<blockquote>
  <p>å› ä¸ºç¬¬ä¸€ä¸ªå‚æ•°è¦æ˜¯<code class="language-plaintext highlighter-rouge">ostream&amp; os</code>ï¼Œæ‰€ä»¥å¿…ä¸å¯èƒ½ä¸ºæˆå‘˜å‡½æ•°.</p>
</blockquote>

<ol>
  <li>
    <p>If unary operator (eg. ++), implement as member.</p>
  </li>
  <li>
    <p>If binary operator and treats both operands equally (eg.
both unchanged) implement as non-member (maybe
friend). Examples: +, &lt;.</p>
  </li>
</ol>

<blockquote>
  <p><strong>æ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼š</strong></p>

  <p>Binary operators are typically implemented as non-members to maintain symmetry (for example, when adding a complex number and an integer, if <code class="language-plaintext highlighter-rouge">operator+</code> is a member function of the complex type, then only <code class="language-plaintext highlighter-rouge">complex+integer</code> would compile, and not <code class="language-plaintext highlighter-rouge">integer+complex</code>).</p>
</blockquote>

<p>ä½•ä¸º<code class="language-plaintext highlighter-rouge">symmetric</code>?</p>

<blockquote>
  <p>æ ¹æ®<strong>Wikipedia</strong>ï¼š</p>

  <p>A corresponding property exists for binary relations; a binary relation is said to be <strong>symmetric</strong> if the relation applies <strong>regardless of the order of its operands</strong>.</p>
</blockquote>

<p>å› ä¸ºå®šä¹‰ä¸ºéæˆå‘˜å‡½æ•°ï¼Œæ‰€ä»¥éœ€è¦å‹å…ƒï¼Œä»¥ä¸‹æ˜¯æœ€ä¹ æƒ¯çš„ä¸€ç§é‡è½½äºŒå…ƒè¿ç®—ç¬¦çš„æ–¹å¼ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// friends defined inside class body are inline and are hidden from non-ADL lookup</span>
  <span class="k">friend</span> <span class="n">X</span> <span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="n">X</span> <span class="n">lhs</span><span class="p">,</span>        <span class="c1">// passing lhs by value helps optimize chained a+b+c</span>
                     <span class="k">const</span> <span class="n">X</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="c1">// otherwise, both parameters may be const references</span>
  <span class="p">{</span>
    <span class="n">lhs</span> <span class="o">+=</span> <span class="n">rhs</span><span class="p">;</span> <span class="c1">// reuse compound assignment</span>
    <span class="k">return</span> <span class="n">lhs</span><span class="p">;</span> <span class="c1">// return the result by value (uses move constructor)</span>
  <span class="p">}</span>
</code></pre></div></div>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“æˆ‘ä»¬åœ¨ç±»æ¨¡æ¿ä¸­å®šä¹‰å‹å…ƒå‡½æ•°æ—¶ï¼Œæˆ‘ä»¬<strong>è¿˜éœ€è¦ä¸ºå‹å…ƒå‡½æ•°å•ç‹¬æä¾›ä¸€ä»½æ¨¡æ¿å‚æ•°ï¼Œè€Œä¸èƒ½ç›´æ¥åˆ©ç”¨ç±»æ¨¡æ¿å‚æ•°</strong>â€“å› ä¸ºå‹å…ƒæœ¬èº«å¹¶ä¸å±äºç±»æˆå‘˜çš„ä¸€éƒ¨åˆ†ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">K</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">M</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">H</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">hash</span><span class="o">&lt;</span><span class="n">K</span><span class="p">&gt;</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">foo</span> <span class="p">{</span>
    <span class="c1">// do something</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">K_</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">M_</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">H_</span><span class="p">&gt;</span>
    <span class="k">friend</span> <span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="k">const</span> <span class="n">foo</span><span class="o">&lt;</span><span class="n">K_</span><span class="p">,</span> <span class="n">M_</span><span class="p">,</span> <span class="n">H_</span><span class="o">&gt;&amp;</span> <span class="n">foo_1</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<ol>
  <li>If binary operator and not both equally (changes lhs),
implement as member (allows easy access to lhs private
members). Examples: +=</li>
</ol>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">X</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">+=</span><span class="p">(</span><span class="k">const</span> <span class="n">X</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="c1">// compound assignment (does not need to be a member,</span>
  <span class="p">{</span>                           <span class="c1">// but often is, to modify the private members)</span>
    <span class="cm">/* addition of rhs to *this takes place here */</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span> <span class="c1">// return the result by reference</span>
  <span class="p">}</span>
</code></pre></div></div>

<h4>[]</h4>

<p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦é‡è½½<code class="language-plaintext highlighter-rouge">operator []</code>çš„ä¸¤ç§å½¢å¼ï¼ˆ<code class="language-plaintext highlighter-rouge">const</code>ä¸é<code class="language-plaintext highlighter-rouge">const</code>ï¼‰ï¼Œè¿™æ˜¯ä¸ºäº†è§£å†³å½“æˆ‘ä»¬å®šä¹‰çš„å¯¹è±¡æœ¬èº«å³ä¸º<code class="language-plaintext highlighter-rouge">const</code>ç±»å‹æ—¶å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼š</p>

<p>ç”±äº<code class="language-plaintext highlighter-rouge">this</code>æŒ‡é’ˆé»˜è®¤æ˜¯ä¸€ä¸ªæŒ‡å‘éå¸¸é‡å¯¹è±¡çš„å¸¸é‡æŒ‡é’ˆï¼Œå¦‚æœå¯¹è±¡è¢«å£°æ˜ä¸º<code class="language-plaintext highlighter-rouge">const</code>ï¼Œåˆ™æŒ‡<code class="language-plaintext highlighter-rouge">this</code>ä¸ºæŒ‡å‘å¸¸é‡å¯¹è±¡çš„å¸¸é‡æŒ‡é’ˆï¼Œåªæœ‰åœ¨æˆ‘ä»¬å°†æˆå‘˜å‡½æ•°ååŠ ä¸Š<code class="language-plaintext highlighter-rouge">const</code>ï¼Œæ‰å¯ä»¥ä½¿å¾—å‚æ•°ä¸­å®å‚ç±»å‹ä¸º<code class="language-plaintext highlighter-rouge">const test*</code>ï¼Œå¦åˆ™åŠ¿å¿…<strong>ä¸¢å¤±åº•å±‚<code class="language-plaintext highlighter-rouge">const</code></strong>ã€‚ï¼ˆè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ<code class="language-plaintext highlighter-rouge">const</code>æˆå‘˜å‡½æ•°å†…åªå…è®¸è°ƒç”¨<code class="language-plaintext highlighter-rouge">const</code>æˆå‘˜å‡½æ•°çš„åŸå› ï¼‰ã€‚åŒæ—¶éœ€è¦æ³¨æ„ï¼Œè¯¥å‡½æ•°å¯ä»¥è¿”å›å¼•ç”¨ï¼Œå¼•ç”¨å‰ä¹Ÿåº”å½“æœ‰<code class="language-plaintext highlighter-rouge">const</code>ï¼Œç¡®ä¿ä¸èƒ½æ”¹å˜å¯¹è±¡ï¼š</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;::</span><span class="k">operator</span><span class="p">[](</span><span class="kt">size_t</span> <span class="n">index</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="c1">// do something</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="principle-of-least-astonishment-pola">Principle of Least Astonishment (POLA)</h4>

<p>è¿™é‡Œåªæå‡ ç‚¹ï¼šå½“æˆ‘ä»¬å®ç°äº†<code class="language-plaintext highlighter-rouge">+</code>çš„é‡è½½æ—¶ï¼Œæˆ‘ä»¬æœ€å¥½ä¹Ÿè¦å®ç°ç±»ä¼¼äº<code class="language-plaintext highlighter-rouge">+=</code>çš„é‡è½½ï¼Œç±»æ¨:</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111172313712.png" alt="image-20211117231351569" style="zoom:50%;" /></p>

<p>åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿè¦æ³¨æ„èƒ½å¤Ÿé“¾å¼ä½¿ç”¨é‡è½½è¿ç®—ç¬¦çš„è®¡ç®—ç»“æœï¼ˆé è¿ç®—ç¬¦é‡è½½å‡½æ•°è¿”å›å¯¹è±¡æˆ–è€…å¯¹è±¡çš„å¼•ç”¨æ¥å®ç°ï¼‰:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ostream</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">out</span><span class="p">,</span> <span class="k">const</span> <span class="n">Fraction</span><span class="o">&amp;</span> <span class="n">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">f</span><span class="p">.</span><span class="n">num</span> <span class="o">&lt;&lt;</span> <span class="err">â€œ</span><span class="o">/</span><span class="err">â€</span><span class="o">&lt;&lt;</span> <span class="n">f</span><span class="p">.</span><span class="n">denom</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">os</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="converting-constructor--conversion-operator">Converting constructor &amp; Conversion operator</h4>

<h5 id="converting-constructor">Converting constructor</h5>

<blockquote>
  <p>å¦‚æœæ„é€ å‡½æ•°<strong>å¯ä»¥åªæ¥å—ä¸€ä¸ªå®å‚</strong>ï¼ˆåŒ…æ‹¬å¯¹å…¶ä½™æ‰€æœ‰å½¢å‚æä¾›äº†é»˜è®¤å€¼çš„æƒ…å†µï¼‰ï¼Œåˆ™å®ƒå®é™…ä¸Šå®šä¹‰äº†è½¬æ¢ä¸ºæ­¤ç±»ç±»å‹çš„éšå¼è½¬æ¢æœºåˆ¶ã€‚è¿™ç§æ„é€ å‡½æ•°è¢«ç§°ä¸º<strong>è½¬æ¢æ„é€ å‡½æ•°</strong>ã€‚</p>
</blockquote>

<blockquote>
  <p><em>C++ Primer</em>P264:</p>

  <p>ç¼–è¯‘å™¨<strong>åªä¼šè‡ªåŠ¨æ‰§è¡Œä¸€æ­¥éšå¼è½¬æ¢</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬æ¥å—ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">string</code>ç±»å‹çš„å‚æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸èƒ½ç›´æ¥æŠŠ<code class="language-plaintext highlighter-rouge">char*</code>æ”¾è¿›å»ï¼Œå¦åˆ™è‡ªåŠ¨è½¬æ¢ä¸º<code class="language-plaintext highlighter-rouge">string</code>åï¼Œä¸ä¼šç»§ç»­éšå¼è½¬æ¢äº†.(ä½†æˆ‘ä»¬å¯ä»¥åšæ˜¾å¼è½¬æ¢)</p>
</blockquote>

<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å…³é”®å­—<code class="language-plaintext highlighter-rouge">explicit</code>æ¥æŠ‘åˆ¶æ„é€ å‡½æ•°å®šä¹‰çš„éšå¼è½¬æ¢:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">test_explicit</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="k">explicit</span> <span class="n">test_explicit</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span><span class="o">:</span> <span class="n">data</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{}</span>
    <span class="kt">int</span> <span class="n">combine</span><span class="p">(</span><span class="k">const</span> <span class="n">test_explicit</span><span class="o">&amp;</span> <span class="n">new_value</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">data</span> <span class="o">+</span> <span class="n">new_value</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
    <span class="p">}</span>
<span class="nl">private:</span>
    <span class="kt">int</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// error, try to converting implicitly from int to test_explicit type</span>
<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Combine value: "</span> <span class="o">&lt;&lt;</span> <span class="n">foo_1</span><span class="p">.</span><span class="n">combine</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
</code></pre></div></div>

<p>éœ€è¦å¤šä¸ªå®å‚çš„æ„é€ å‡½æ•°ä¸èƒ½ç”¨äºæ‰§è¡Œéšå¼è½¬æ¢ï¼Œæ‰€ä»¥æ— éœ€å°†å…¶å®šä¹‰ä¸º<code class="language-plaintext highlighter-rouge">explicit</code>çš„ã€‚åŒæ—¶ï¼Œåªèƒ½åœ¨ç±»å†…å£°æ˜æ„é€ å‡½æ•°æ—¶ä½¿ç”¨<code class="language-plaintext highlighter-rouge">explicit</code>å…³é”®å­—ï¼Œåœ¨ç±»å¤–éƒ¨å®šä¹‰æ—¶ä¸åº”é‡å¤ã€‚</p>

<blockquote>
  <p>æ³¨æ„ï¼Œå½“æ‹·è´æ„é€ å‡½æ•°è¢«å£°æ˜ä¸º<code class="language-plaintext highlighter-rouge">explicit</code>æ—¶ï¼Œè¡¨æ˜æ‹·è´æ„é€ å‡½æ•°ä¸èƒ½è¢«éšå¼è°ƒç”¨ï¼Œæ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬å°è¯•ä½¿ç”¨<code class="language-plaintext highlighter-rouge">=</code>è¿›è¡Œæ‹·è´åˆå§‹åŒ–ï¼ˆ<strong>éšå¼è°ƒç”¨äº†æ‹·è´æ„é€ å‡½æ•°</strong>ï¼‰ï¼Œä¹Ÿæ˜¯ä¸è¢«å…è®¸çš„:</p>

  <p>```c++
string null_book = â€œ9999â€;
Sales_data item2 = null_book; //error</p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">explicit</code>å¯ä»¥é¿å…æˆ‘ä»¬å†™å‡ºäºŒä¹‰æ€§çš„ä»£ç ã€‚</p>

<h5 id="conversion-operator">Conversion operator</h5>

<p><code class="language-plaintext highlighter-rouge">explicit</code>å…³é”®å­—é™¤äº†å¯ä»¥ç”¨åœ¨æ„é€ å‡½æ•°ä¹‹å‰å¤–ï¼Œè¿˜å¯ä»¥ç”¨åœ¨ç±»å‹è½¬æ¢è¿ç®—ç¬¦å‰ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">explicit</span> <span class="k">operator</span> <span class="kt">double</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="c1">// do something</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>è¯¥è§„å®šå­˜åœ¨ä¸€ä¸ªä¾‹å¤–ï¼Œ<strong>å¦‚æœè¡¨è¾¾å¼è¢«ç”¨ä½œæ¡ä»¶ï¼Œåˆ™ç¼–è¯‘å™¨ä¼šå°†æ˜¾å¼çš„ç±»å‹è½¬æ¢è‡ªåŠ¨åº”ç”¨äºå®ƒ</strong>ã€‚<code class="language-plaintext highlighter-rouge">operator bool</code>ä¸€èˆ¬å®šä¹‰æˆ<code class="language-plaintext highlighter-rouge">explicit</code>çš„.</p>
</blockquote>

<h3 id="special-member-functions">Special member functions</h3>

<p>è¿™äº›å‡½æ•°ä¼šç”±ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆä¸€ä»½ï¼š</p>

<ul>
  <li>Default construction</li>
  <li>Copy construction</li>
  <li>Copy assignment</li>
  <li>Destruction</li>
</ul>

<h4 id="most-vexing-parse">Most vexing parse</h4>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111180150966.png" alt="image-20211118015039848" style="zoom:50%;" /></p>

<p>æ ¹æ®<em>Wikipedia</em>çš„è§£é‡Šï¼š</p>

<blockquote>
  <p>The <strong>most vexing parse</strong> is a counterintuitive form of syntactic <a href="https://en.wikipedia.org/wiki/Ambiguous_grammar">ambiguity resolution</a> in the <a href="https://en.wikipedia.org/wiki/C%2B%2B">C++</a> programming language. In certain situations, the C++ grammar cannot distinguish between the <a href="https://en.wikipedia.org/wiki/Initialization_(programming)">creation</a> of an object <a href="https://en.wikipedia.org/wiki/Parameter_(computer_programming)">parameter</a> and <a href="https://en.wikipedia.org/wiki/Type_declaration">specification of a functionâ€™s type</a>. In those situations, the compiler is required to interpret the line as a function type specification.</p>
</blockquote>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»–è¢«å½“ä½œä¸€ä¸ªå‡½æ•°æ¥å¤„ç†äº†ã€‚<strong>æ‰€ä»¥ä¸è¦è¿™ä¹ˆå†™ï¼</strong></p>

<h4 id="shallow-copy--deep-copy">shallow copy &amp; deep copy</h4>

<p>ç¼–è¯‘å™¨åœ¨é»˜è®¤æƒ…å†µä¸‹ç”Ÿæˆçš„<code class="language-plaintext highlighter-rouge">copy assignment</code>å°±æ˜¯ä¸€ç§<code class="language-plaintext highlighter-rouge">shallow copy</code>ï¼Œè€Œæˆ‘ä»¬éœ€è¦çš„å¾€å¾€æ˜¯<code class="language-plaintext highlighter-rouge">deep copy</code>ï¼Œ<code class="language-plaintext highlighter-rouge">shallow copy</code>å¸¦æ¥çš„é—®é¢˜å¾ˆæ˜æ˜¾ï¼Œå®ƒå¹¶æ²¡æœ‰å®Œå…¨å¤åˆ¶æ‰€æœ‰çš„æ•°æ®ï¼Œè€Œæ˜¯ç”¨æŒ‡é’ˆæŒ‡å‘äº†æºæ•°æ®å­˜æ”¾çš„ä½ç½®ï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111180155717.png" alt="image-20211118015546603" style="zoom:50%;" /></p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111180156728.png" alt="image-20211118015632623" style="zoom:50%;" /></p>

<h4 id="copy-constructor">Copy constructor</h4>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">StringVector</span><span class="o">::</span><span class="n">StringVector</span><span class="p">(</span><span class="k">const</span> <span class="n">StringVector</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span> <span class="o">:</span>
        <span class="n">_logicalSize</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">_logicalSize</span><span class="p">),</span>
        <span class="n">_allocatedSize</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">_allocatedSize</span><span class="p">)</span> <span class="p">{</span>
            
    <span class="n">_elems</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ValueType</span><span class="p">[</span><span class="n">_allocatedSize</span><span class="p">];</span>
    <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">other</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">begin</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="copy-assignment">Copy assignment</h4>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨<code class="language-plaintext highlighter-rouge">copy assignment</code>ä¸­ï¼Œæˆ‘ä»¬è¦è€ƒè™‘åˆ°<code class="language-plaintext highlighter-rouge">copy</code>çš„å¯¹è±¡ä¸æºå¯¹è±¡æ˜¯åŒä¸€ä¸ªçš„æƒ…å†µï¼ˆ<code class="language-plaintext highlighter-rouge">self-assignment</code>ï¼‰:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">StringVector</span><span class="o">&amp;</span> <span class="n">StringVector</span><span class="o">::</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">StringVector</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="p">[]</span> <span class="n">_elems</span><span class="p">;</span>
        <span class="n">_logicalSize</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">.</span><span class="n">_logicalSize</span><span class="p">;</span>
        <span class="n">_allocatedSize</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">.</span><span class="n">_allocatedSize</span><span class="p">;</span>
        <span class="n">_elems</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ValueType</span><span class="p">[</span><span class="n">_allocatedSize</span><span class="p">];</span>
        <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">other</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">begin</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>ä¸å¯ä»¥ç”¨<code class="language-plaintext highlighter-rouge">*this != rhs</code>ï¼Œå› ä¸ºè¿™éœ€è¦æˆ‘ä»¬é‡è½½<code class="language-plaintext highlighter-rouge">!=</code>æ“ä½œç¬¦.</p>
</blockquote>

<h4 id="delete--default">=delete &amp; =default</h4>

<p>å¦‚æœæˆ‘ä»¬çš„ç±»ä¸éœ€è¦æ‹·è´/ç§»åŠ¨æ“ä½œï¼Œæˆ‘ä»¬éœ€è¦åœ¨<code class="language-plaintext highlighter-rouge">public</code>åŸŸä¸­ä½¿ç”¨<code class="language-plaintext highlighter-rouge">=delete</code>å°†å…¶ç¦ç”¨ï¼ˆä½†<code class="language-plaintext highlighter-rouge">=delete</code>å…³é”®å­—å¹¶éåªé€‚ç”¨äºè¿™å‡ ç§å‡½æ•°ï¼Œè¯¥å…³é”®å­—æ„ä¸ºâ€œå¼ƒç”¨â€ï¼‰ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">test</span><span class="p">(</span><span class="k">const</span> <span class="n">test</span><span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span><span class="k">delete</span><span class="p">;</span>
<span class="n">test</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">test</span><span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span><span class="k">delete</span><span class="p">;</span>
</code></pre></div></div>

<p>å¦‚æœæˆ‘ä»¬éœ€è¦é»˜è®¤çš„è¡Œä¸ºï¼Œå¯ä»¥è¦æ±‚ç¼–è¯‘å™¨æä¾›ç”Ÿæˆé»˜è®¤æ„é€ å‡½æ•°ï¼ˆä¸€èˆ¬æ­¤æ—¶æˆ‘ä»¬è¿˜éœ€è¦å…¶å®ƒç±»å‹çš„æ„é€ å‡½æ•°ï¼‰ï¼Œè¿™å°±å¯ä»¥é¿å…<code class="language-plaintext highlighter-rouge">Most vexing parse</code>çš„å‘ç”Ÿï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">test</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="write-our-own">Write our own?</h4>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111180206534.png" alt="image-20211118020633426" style="zoom:50%;" /></p>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code class="language-plaintext highlighter-rouge">stream</code>å¯¹è±¡å‡ä¸å¯è¢«å¤åˆ¶ï¼Œå› ä¸ºè¿™æ ·çš„æ“ä½œæ²¡æœ‰æ„ä¹‰ï¼Œè€Œåœ¨å®ç°ä¸­ï¼Œä»–ä»¬çš„å¤åˆ¶æ„é€ å‡½æ•°ä¹Ÿéƒ½è¢«å£°æ˜ä¸º<code class="language-plaintext highlighter-rouge">private</code>ã€‚</p>

<h4 id="rule-of-three">Rule Of Three</h4>

<blockquote>
  <p>If you explicitly define (or delete) a copy constructor, copy assignment, or destructor, you should define (or delete) all three.</p>
</blockquote>

<p>å› ä¸ºå½“å®šä¹‰äº†è¿™ä¸‰ç§å‡½æ•°çš„ä»»æ„ä¸€ç§æ—¶ï¼Œå°±è¡¨æ˜ä¼šå‡ºç°<code class="language-plaintext highlighter-rouge">ownership issues</code>.</p>

<h4 id="rules-of-zero">Rules of Zero</h4>

<blockquote>
  <p>If the default operations work, then donâ€™t define your own custom ones.</p>
</blockquote>

<h3 id="delegating-constructor">Delegating Constructor</h3>

<p><strong>C++11</strong>å¼•å…¥äº†<strong>å§”æ‰˜æ„é€ å‡½æ•°</strong>â€“ä½¿ç”¨å®ƒæ‰€å±ç±»çš„å…¶ä»–æ„é€ å‡½æ•°æ‰§è¡Œä»–è‡ªå·±çš„åˆå§‹åŒ–è¿‡ç¨‹ï¼Œæˆ–è€…å°†è‡ªå·±çš„èŒè´£å§”æ‰˜ç»™å…¶ä»–æ„é€ å‡½æ•°ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Sales_data</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">Sales_data</span><span class="p">()</span><span class="o">:</span> <span class="n">Sales_data</span><span class="p">(</span><span class="s">""</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
    <span class="c1">// other constructors</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="inline--constexpr">inline &amp; constexpr</h3>

<p>å†…è”å‡½æ•°ï¼ˆ<code class="language-plaintext highlighter-rouge">inline</code>ï¼‰ï¼Œåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­<strong>å†…è”</strong>åœ°åœ¨è°ƒç”¨ç‚¹å±•å¼€ï¼Œä»è€Œæ¶ˆé™¤å‡½æ•°åœ¨è¿è¡Œæ—¶çš„å¼€é”€ã€‚</p>

<blockquote>
  <p>ä¸€èˆ¬æ¥è¯´ï¼Œå†…è”å‡½æ•°ç”¨äºä¼˜åŒ–è§„æ¨¡è¾ƒå°ï¼Œæµç¨‹ç›´æ¥ï¼Œé¢‘ç¹è°ƒç”¨çš„å‡½æ•°ã€‚<strong>å®šä¹‰åœ¨ç±»å†…éƒ¨çš„å‡½æ•°æ˜¯è‡ªåŠ¨<code class="language-plaintext highlighter-rouge">inline</code>çš„</strong>ã€‚</p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">constexpr</code>å‡½æ•°æ˜¯æŒ‡èƒ½ç”¨äºå¸¸é‡è¡¨è¾¾å¼çš„å‡½æ•°ï¼šå®ƒçš„è¿”å›ç±»å‹ã€æ‰€æœ‰çš„å½¢å‚ç±»å‹éƒ½æ˜¯<strong>å­—é¢å€¼ç±»å‹</strong>ï¼Œè€Œä¸”å‡½æ•°ä½“ä¸­é™¤äº†<code class="language-plaintext highlighter-rouge">using/typedef</code>ç­‰åœ¨<strong>è¿è¡Œæ—¶ä¸æ‰§è¡Œä»»ä½•æ“ä½œ</strong>çš„è¯­å¥å¤–ï¼Œåªèƒ½æœ‰ä¸€æ¡<code class="language-plaintext highlighter-rouge">return</code>è¯­å¥ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">constexpr</span> <span class="kt">int</span> <span class="nf">new_sz</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="mi">42</span><span class="p">;}</span>
<span class="k">constexpr</span> <span class="kt">int</span> <span class="n">foo</span> <span class="o">=</span> <span class="n">new_sz</span><span class="p">();</span> <span class="c1">// foo is a const expression</span>
</code></pre></div></div>

<blockquote>
  <p>ç®—æœ¯ç±»å‹ã€å¼•ç”¨å’ŒæŒ‡é’ˆï¼ˆåˆå§‹å€¼å¿…é¡»ä¸º<code class="language-plaintext highlighter-rouge">nullptr</code>æˆ–è€…<code class="language-plaintext highlighter-rouge">0</code>ï¼Œæˆ–è€…å­˜å‚¨äºæŸä¸ªå›ºå®šåœ°å€çš„å¯¹è±¡â€“ä¸€èˆ¬å®šä¹‰äºå‡½æ•°ä½“ä¹‹å¤–ï¼‰ç±»å‹å‡ä¸ºå­—é¢å€¼ç±»å‹ï¼Œè‡ªå®šä¹‰ç±»ã€IOåº“ã€<code class="language-plaintext highlighter-rouge">string</code>ç±»å‹ä¸æ˜¯å­—é¢å€¼ç±»å‹ï¼Œä¸å¯ä»¥è¢«å®šä¹‰ä¸º<code class="language-plaintext highlighter-rouge">constexpr</code>ã€‚</p>
</blockquote>

<p>æˆ‘ä»¬å…è®¸<code class="language-plaintext highlighter-rouge">constexpr</code>å‡½æ•°çš„è¿”å›å€¼å¹¶éä¸€ä¸ªå¸¸é‡ï¼šå½“ç»™å…¥å‡½æ•°çš„å®å‚æ˜¯å¸¸é‡è¡¨è¾¾å¼æ—¶ï¼Œè¿”å›å€¼ä¹Ÿæ˜¯å¸¸é‡è¡¨è¾¾å¼ï¼Œåä¹‹ä¸ç„¶ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">constexpr</span> <span class="kt">size_t</span> <span class="nf">scale</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">cnt</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">new_sz</span><span class="p">()</span> <span class="o">*</span> <span class="n">cnt</span><span class="p">;}</span>
<span class="c1">// OK</span>
<span class="kt">int</span> <span class="n">arr</span><span class="p">[</span><span class="n">scale</span><span class="p">(</span><span class="mi">2</span><span class="p">)];</span>
<span class="c1">// ERROR</span>
<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">arr</span><span class="p">[</span><span class="n">scale</span><span class="p">(</span><span class="n">i</span><span class="p">)];</span>
</code></pre></div></div>

<p>ç¼–è¯‘å™¨å¯¹<code class="language-plaintext highlighter-rouge">constexpr</code>å‡½æ•°çš„è°ƒç”¨æ›¿æ¢ä¸ºç»“æœå€¼ï¼Œä¸ºäº†èƒ½åœ¨ç¼–è¯‘ä¸­éšæ—¶å±•å¼€ï¼Œ<code class="language-plaintext highlighter-rouge">constexpr</code>å‡½æ•°è¢«éšå¼æŒ‡å®šä¸º<code class="language-plaintext highlighter-rouge">inline</code>å‡½æ•°ã€‚</p>

<blockquote>
  <p>æ­£å› ä¸º<code class="language-plaintext highlighter-rouge">inline</code>ä¸<code class="language-plaintext highlighter-rouge">constexpr</code>å‡½æ•°çš„ç¼–è¯‘å±•å¼€ç‰¹æ€§ï¼Œä»…ä»…æœ‰å‡½æ•°å£°æ˜æ˜¯ä¸å¤Ÿçš„ï¼Œè¿˜éœ€è¦å‡½æ•°çš„å®šä¹‰â€“æ‰€ä»¥ä»–ä»¬çš„<strong>å®šä¹‰é€šå¸¸ç›´æ¥æ”¾åœ¨å¤´æ–‡ä»¶ä¸­</strong>ã€‚</p>
</blockquote>

<h3 id="move-semantics">Move semantics</h3>

<h4 id="emplace_back">emplace_back</h4>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111182220012.png" alt="image-20211118222054939" style="zoom:50%;" /></p>

<p>è¯¥å‡½æ•°çš„å‚æ•°å£°æ˜æ˜¯ç”¨äº†å¯å˜å‚æ•°æ¨¡æ¿ï¼Œå¹¶å¯¹å‚æ•°åŒ…<code class="language-plaintext highlighter-rouge">Args</code>è¿›è¡Œäº†<code class="language-plaintext highlighter-rouge">pattern=Args&amp;&amp;</code>çš„<code class="language-plaintext highlighter-rouge">pack expansion</code>æ“ä½œã€‚ä¸<code class="language-plaintext highlighter-rouge">push_back</code>æ–¹æ³•æ‰€ä¸åŒçš„æ˜¯ï¼Œè¯¥æ–¹æ³•å€ŸåŠ©<strong>å³å€¼å¼•ç”¨</strong>ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦è°ˆçš„ç‰¹æ€§ï¼Œé¿å…äº†å…ˆåˆ›å»ºä¸€ä»½æ•°æ®ï¼Œå†å¤åˆ¶çš„æ“ä½œï¼Œè€Œæ˜¯ç›´æ¥ç»™å®šéœ€è¦çš„æ•°æ®å…ƒç´ å‚æ•°ï¼ŒåŠ å…¥æ•°æ®é˜Ÿåˆ—ä¸­ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">President</span><span class="o">&gt;</span> <span class="n">elections</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"emplace_back:</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
<span class="k">auto</span><span class="o">&amp;</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">elections</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="s">"Nelson Mandela"</span><span class="p">,</span> <span class="s">"South Africa"</span><span class="p">,</span> <span class="mi">1994</span><span class="p">);</span>
<span class="n">assert</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">year</span> <span class="o">==</span> <span class="mi">1994</span> <span class="o">&amp;&amp;</span> <span class="s">"uses a reference to the created object (C++17)"</span><span class="p">);</span>
 
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">President</span><span class="o">&gt;</span> <span class="n">reElections</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">push_back:</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
<span class="n">reElections</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">President</span><span class="p">(</span><span class="s">"Franklin Delano Roosevelt"</span><span class="p">,</span> <span class="s">"the USA"</span><span class="p">,</span> <span class="mi">1936</span><span class="p">));</span>
</code></pre></div></div>

<h4 id="without-copy-elision">Without copy elision</h4>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111182246321.png" alt="image-20211118224658231" style="zoom:50%;" /></p>

<p>åœ¨ä¸Šå›¾æ‰€ç¤ºçš„ä»£ç ä¸­ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä¸è¿›è¡ŒRVOç­‰ä¼˜åŒ–æœºåˆ¶æ—¶ï¼Œ<code class="language-plaintext highlighter-rouge">return</code>è¿™ä¸€æ­¥ä¼šåˆ›å»ºä¸€ä¸ª<code class="language-plaintext highlighter-rouge">temporary object</code>ï¼Œè¿™éœ€è¦æˆ‘ä»¬è°ƒç”¨å¤åˆ¶æ„é€ å‡½æ•°ï¼Œå°†å˜é‡<code class="language-plaintext highlighter-rouge">names</code>å¤åˆ¶åˆ°ä¸´æ—¶å¯¹è±¡ä¸­ã€‚</p>

<h4 id="basic-idea">Basic idea</h4>

<p>æ ¹æ®<a href="http://thbecker.net/articles/rvalue_references/section_02.html">è¿™ç¯‡æ–‡ç« </a>ï¼Œä¸ºäº†æé«˜è¿è¡Œæ•ˆç‡ï¼Œæˆ‘ä»¬å°è¯•ä½¿ç”¨æŸç§æ–¹æ³•é¿å…ä¸€äº›ä¸å¿…è¦çš„æ•°æ®å¤åˆ¶è¿‡ç¨‹ï¼Œæ¯”å¦‚å½“ç»™åˆ°è¿™æ ·ä¸€ä¸ªæ‹·è´èµ‹å€¼å‡½æ•°ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">X</span><span class="o">&amp;</span> <span class="n">X</span><span class="o">::</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">X</span> <span class="k">const</span> <span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// [...]</span>
  <span class="c1">// Make a clone of what rhs.m_pResource refers to.</span>
  <span class="c1">// Destruct the resource that m_pResource refers to. </span>
  <span class="c1">// Attach the clone to m_pResource.</span>
  <span class="c1">// [...]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å¦‚æœè¯´æˆ‘ä»¬ä¼ å…¥çš„æ˜¯å·¦å€¼ï¼Œé‚£ä¹ˆç¨‹åºä»ç„¶ä¼šæŒ‰ç…§ä¹‹å‰çš„é‡è½½å‡½æ•°è¿è¡Œï¼ˆåŒ…å«å¤åˆ¶ç­‰ä¸€ç³»åˆ—æ“ä½œï¼‰ï¼Œæˆ‘ä»¬ä¸èƒ½å·å–å·¦å€¼ä¸­å­˜æ”¾çš„å†…å®¹ï¼Œå› ä¸ºä¹‹åå¯èƒ½è¿˜ä¼šç”¨åˆ°ï¼›ä½†å¦‚æœæˆ‘ä»¬ä¼ å…¥çš„æ˜¯å³å€¼ï¼Œå› ä¸ºå³å€¼è¡¨è¾¾å¼è¡Œå°†é”€æ¯ï¼ŒåŸºäºè¿™ä¸€ç‰¹æ€§ï¼Œæˆ‘ä»¬æƒ³<strong>æŠŠç­‰å¼å³è¾¹çš„å†…å®¹å·è¿‡æ¥ï¼Œæˆ–è€…è¯´æˆ‘ä»¬æƒ³è®©ç­‰å¼å·¦è¾¹çš„å†…å®¹çš„æŒ‡é’ˆæŒ‡å‘ç­‰å¼å³è¾¹çš„å³å€¼çš„å†…å®¹ï¼Œè€Œä¸æ˜¯æŠŠå³å€¼çš„å†…å®¹å¤åˆ¶åˆ°å·¦è¾¹ä¸€ä»½</strong>ã€‚è¿™ç§æ“ä½œï¼ˆæƒ³æ³•ï¼‰è¢«å«åš<code class="language-plaintext highlighter-rouge">move semantics</code>ï¼Œäºæ˜¯æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªæœŸæœ›çš„å‡½æ•°æ¨¡æ¿ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">X</span><span class="o">&amp;</span> <span class="n">X</span><span class="o">::</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="o">&lt;</span><span class="n">mystery</span> <span class="n">type</span><span class="o">&gt;</span> <span class="n">rhs</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// [...]</span>
  <span class="c1">// swap this-&gt;m_pResource and rhs.m_pResource</span>
  <span class="c1">// [...]  </span>
<span class="p">}</span>
</code></pre></div></div>

<p>æˆ‘ä»¬éœ€è¦ä¸€ç§æ–°çš„<code class="language-plaintext highlighter-rouge">mystery type</code>ï¼Œè¡¨ç¤ºä¼ å…¥äº†ä¸€ä¸ªå³å€¼ï¼Œå¹¶ä¸”å¯ä»¥è®©ç¨‹åºåœ¨ç¼–è¯‘é˜¶æ®µè¯†åˆ«å‡ºåˆ°åº•æ˜¯åº”è¯¥ä½¿ç”¨è¿™ä¸ªæ–°çš„é‡è½½æ‹·è´èµ‹å€¼å‡½æ•°è¿˜æ˜¯å…ˆå‰çš„ä¼ å…¥å·¦å€¼å¼•ç”¨çš„é‚£ä¸€ä¸ªã€‚å› ä¸ºæˆ‘ä»¬æ­¤å¤„æƒ³è¦å®ç°çš„ä¹Ÿæ˜¯ä¸€ç§<code class="language-plaintext highlighter-rouge">copy assignment overload</code>ï¼Œæ‰€ä»¥ä¼ å…¥çš„ä¹Ÿè¦æ˜¯ä¸€ç§<strong>å¼•ç”¨</strong>ç±»å‹ï¼Œå¹¶ä¸”ä¼ å…¥çš„è¦æ˜¯ä¸€ä¸ªå³å€¼ï¼Œæ•…<code class="language-plaintext highlighter-rouge">rvalue reference(&amp;&amp;)</code>è¢«å¼•å…¥ä½œä¸º<code class="language-plaintext highlighter-rouge">mystery type</code>ï¼Œæˆ‘ä»¬æœŸæœ›è¯¥ç±»å‹å…·å¤‡å¦‚ä¸‹çš„è¡Œä¸ºç‰¹å¾ï¼š</p>

<blockquote>
  <p>rvalues must prefer the mystery type, while lvalues must prefer the ordinary reference.</p>
</blockquote>

<p>ç¨‹åºå¯¹äºè¿™ä¸¤ç§æˆå‘˜é‡è½½å‡½æ•°çš„é€‰æ‹©é€šè¿‡<code class="language-plaintext highlighter-rouge">overlaod resolution</code>å®ç°ï¼š</p>

<blockquote>
  <p>Rvalue references allow a function to branch at compile time (via overload resolution) on the condition â€œAm I being called on an lvalue or an rvalue?â€</p>
</blockquote>

<p>å®Œæ•´çš„æ¥è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›ç§»åŠ¨èµ‹å€¼å‡½æ•°å…·æœ‰å¦‚ä¸‹çš„åŠŸèƒ½ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">X</span><span class="o">&amp;</span> <span class="n">X</span><span class="o">::</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">X</span><span class="o">&amp;&amp;</span> <span class="n">rhs</span><span class="p">)</span>
<span class="p">{</span>

  <span class="c1">// Perform a cleanup that takes care of at least those parts of the</span>
  <span class="c1">// destructor that have side effects. Be sure to leave the object</span>
  <span class="c1">// in a destructible and assignable state.</span>

  <span class="c1">// Move semantics: exchange content between this and rhs</span>
  
  <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å…ˆæŠŠç­‰å¼å·¦è¾¹çš„å†…å®¹æ¸…ç©ºï¼Œå†æŠŠç­‰å¼å³è¾¹çš„å†…å®¹æ‹¿è¿‡æ¥ï¼Œè¿™ä¹Ÿç¬¦åˆæˆ‘ä»¬å¯¹<strong>èµ‹å€¼</strong>çš„ä½œç”¨å®šä¹‰ã€‚å¹¶ä¸”é€šè¿‡è¿™ä¸ªå‡½æ•°ä¼ªä»£ç å¯ä»¥çœ‹å‡ºï¼Œå½“æˆ‘ä»¬åœ¨ç­‰å¼å³è¾¹ç»™ä¸€ä¸ªå³å€¼ä¹‹åï¼Œå°±æ˜¯å‘Šè¯‰ç¨‹åºæˆ‘ä»¬æ‰“ç®—åš<code class="language-plaintext highlighter-rouge">move semantics</code>äº†ï¼Œå…·ä½“å¦‚ä½•å»<code class="language-plaintext highlighter-rouge">move</code>ï¼Œå¦‚ä½•<code class="language-plaintext highlighter-rouge">cleanup</code>ï¼Œå¦‚ä½•äº¤æ¢æ§åˆ¶æƒï¼ˆ<code class="language-plaintext highlighter-rouge">ownership</code>ï¼‰ï¼Œæ˜¯ç”±æˆ‘ä»¬æ‰€å®šä¹‰çš„è¡Œä¸ºå†³å®šçš„ã€‚</p>

<h4 id="lvalues--rvalues">lvalues &amp; rvalues</h4>

<p>æ ¹æ®<a href="https://en.cppreference.com/w/cpp/language/value_category">å®˜æ–¹æ–‡æ¡£</a>ï¼Œæ¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">Expression</code>éƒ½å…·å¤‡ä¸¤ä¸ªç‹¬ç«‹å±æ€§ï¼š</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">type</code>(e.g. int, double, class, â€¦)</li>
  <li><code class="language-plaintext highlighter-rouge">value category</code></li>
</ol>

<p>å¦‚æœæŒ‰ç…§æ ‡å‡†å®šä¹‰ï¼Œå…±æœ‰ä¸‰ç§åŸºæœ¬çš„<code class="language-plaintext highlighter-rouge">value category</code>: <code class="language-plaintext highlighter-rouge">prvalue</code>, <code class="language-plaintext highlighter-rouge">xvalue</code>, <code class="language-plaintext highlighter-rouge">lvalue</code>ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åšä¸¤ä¸ªç²—ç•¥çš„å®šä¹‰ï¼š<strong>å·¦å€¼</strong>ä¸<strong>å³å€¼</strong>ï¼š</p>

<h5 id="lvalue">lvalue</h5>

<blockquote>
  <p>An <strong>lvalue</strong> is an expression that has a name/identity. In other words, we can find address using address-of operator(&amp;var)</p>
</blockquote>

<h5 id="rvalue">rvalue</h5>

<blockquote>
  <p>An <strong>rvalue</strong> is an expression that does not have a name/identity.</p>

  <ul>
    <li>temporaray values</li>
    <li>cannot find address using address-of operator (&amp;var)</li>
  </ul>
</blockquote>

<p>ä»ç›´è§‚ä¸Šæ¥è¯´ï¼Œå·¦å€¼å¯ä»¥å‡ºç°åœ¨è¡¨è¾¾å¼çš„å·¦ä¾§æˆ–è€…å³ä¾§ï¼Œä½†æ˜¯å³å€¼ä¸€å®šåªèƒ½å‡ºç°åœ¨å³ä¾§ã€‚</p>

<p>å³å€¼å¼•ç”¨ï¼Œåˆ©ç”¨<code class="language-plaintext highlighter-rouge">rvalue</code>çš„ç»“æœï¼Œä½†æœ¬èº«ä¸º<code class="language-plaintext highlighter-rouge">lvalue</code>.</p>

<h5 id="lrvalue-reference">l/rvalue reference</h5>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬åªèƒ½å¤Ÿå°†<strong>å·¦å€¼å¼•ç”¨ç»‘å®šåˆ°å·¦å€¼ï¼Œå³å€¼å¼•ç”¨ç»‘å®šåˆ°å³å€¼</strong>ï¼Œ</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// rvalue reference</span>
<span class="c1">// here, v1 + v2 is a temporary object, which is a rvalue</span>
<span class="k">auto</span><span class="o">&amp;&amp;</span> <span class="n">v4</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">;</span>
</code></pre></div></div>

<p>ä¸€ç§ç‰¹æ®Šæƒ…å†µæ˜¯ï¼šå¯ä»¥å°†<code class="language-plaintext highlighter-rouge">const lvalue reference</code>ç»‘å®šåˆ°<code class="language-plaintext highlighter-rouge">rvalue</code>ä¸Šï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">ptr3</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
</code></pre></div></div>

<p>åŸå› å¦‚ä¸‹ï¼š</p>

<blockquote>
  <p>Normally, a temporary object lasts only until the end of the full expression in which it appears. However, <strong>C++ deliberately specifies that binding a temporary object to a reference <em>to const</em> on the stack lengthens the lifetime of the temporary to the lifetime of the reference itself</strong>, and thus avoids what would otherwise be a common dangling-reference error. In the example above, the temporary returned by f() lives until the closing curly brace. (<strong>Note this only applies to stack-based references. It doesnâ€™t work for references that are members of objects.</strong>)</p>
</blockquote>

<p>ç®€è€Œè¨€ä¹‹ï¼Œä½¿ç”¨<code class="language-plaintext highlighter-rouge">const reference</code>å¯ä»¥å»¶é•¿ä¸´æ—¶å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œä½†è¿™ä»…é™äº<code class="language-plaintext highlighter-rouge">local const reference</code>ï¼Œåœ¨å¦‚ä¸‹è¯­å¥ä¸­ï¼Œæ˜¯ä¸ä¼šäº§ç”Ÿå®é™…æ•ˆåº”çš„ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Sandbox</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">n</span><span class="p">)</span><span class="o">:</span> <span class="n">member</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{};</span>
</code></pre></div></div>

<p>è¿™ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œè¿™é‡Œçš„<code class="language-plaintext highlighter-rouge">const reference</code>å¯¹åº”çš„<code class="language-plaintext highlighter-rouge">scope</code>ä¸ºæ„é€ å‡½æ•°æœ¬èº«ï¼Œå½“æ„é€ å‡½æ•°æ ˆé€€å‡ºåï¼Œè¯¥<code class="language-plaintext highlighter-rouge">reference object</code>ä¹Ÿéšä¹‹æ¶ˆäº¡äº†ã€‚</p>

<p>å…³äº<code class="language-plaintext highlighter-rouge">life time</code>çš„é—®é¢˜ï¼Œä¸<code class="language-plaintext highlighter-rouge">const auto&amp;</code>ä¸€æ ·ï¼Œæ ¹æ®<a href="https://en.cppreference.com/w/cpp/language/reference_initialization#Lifetime_of_a_temporary">å®˜æ–¹æ–‡æ¡£</a>ï¼š</p>

<blockquote>
  <ul>
    <li><strong>Whenever a reference is bound to a temporary object or to a subobject thereof, the lifetime of the temporary object is extended to match the lifetime of the reference!</strong></li>
    <li><strong>Rvalue references can be used to <a href="https://en.cppreference.com/w/cpp/language/reference_initialization#Lifetime_of_a_temporary">extend the lifetimes</a> of temporary objects (note, lvalue references to const can extend the lifetimes of temporary objects too, but they are not modifiable through them)</strong></li>
  </ul>
</blockquote>

<p><strong>å½“æˆ‘ä»¬æŠŠä¸€ä¸ªå¼•ç”¨ç»‘å®šåˆ°ä¸€ä¸ªä¸´æ—¶å¯¹è±¡ä¸Šæ—¶ï¼Œä¸´æ—¶å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸè¢«å»¶é•¿åˆ°å¼•ç”¨çš„ç”Ÿå‘½å‘¨æœŸ</strong>ã€‚</p>

<h5 id="lrvalue-reference--lrvalue">l/rvalue reference &amp; l/rvalue</h5>

<p>å¯¹å‡½æ•°å£°æ˜<code class="language-plaintext highlighter-rouge">test(T&amp;&amp; a)</code>çš„å½¢å¼äº§ç”Ÿäº†ä¸€ç‚¹ç–‘é—®ï¼Œè¿™é‡Œçš„<code class="language-plaintext highlighter-rouge">a</code>æ˜¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">lvalue</code>è€Œä¸æ˜¯<code class="language-plaintext highlighter-rouge">rvalue</code>ã€‚ä¸ºä»€ä¹ˆï¼Ÿ</p>

<p>é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“ï¼Œæ ¹æ®å…ˆå‰çš„ä»‹ç»ï¼Œè¡¨è¾¾å¼å…·å¤‡ä¸¤ä¸ªç‹¬ç«‹çš„ç‰¹æ€§ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">type</code></li>
  <li><code class="language-plaintext highlighter-rouge">value category</code></li>
</ul>

<p>åœ¨è¯¥å‡½æ•°å‚æ•°ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">type</code>ä¸º<code class="language-plaintext highlighter-rouge">rvalue reference</code>ï¼Œè€Œæˆ‘ä»¬è¿™é‡Œæ‰€è¯´çš„<code class="language-plaintext highlighter-rouge">lvalue</code>ï¼Œæ˜¯æŒ‡çš„è¯¥è¡¨è¾¾å¼çš„<code class="language-plaintext highlighter-rouge">value category</code>ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä¸ºä»€ä¹ˆå®ƒçš„<code class="language-plaintext highlighter-rouge">value category</code>ä¸º<code class="language-plaintext highlighter-rouge">lvalue</code>å‘¢ï¼Ÿè¿™æ˜¯å› ä¸º<strong>C++</strong>çš„è¿™æ¡è§„å®šï¼š</p>

<blockquote>
  <p>Things that are declared as rvalue reference can be lvalues or rvalues. The distinguishing criterion is: <em>if it has a name</em>, then it is an lvalue. Otherwise, it is an rvalue.</p>
</blockquote>

<p>è¿™é‡Œçš„<code class="language-plaintext highlighter-rouge">T&amp;&amp; a</code>æ˜¾ç„¶æ˜¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">name variable</code>ï¼Œè€Œä¸æ˜¯ç±»ä¼¼äº<code class="language-plaintext highlighter-rouge">3</code>æˆ–è€…<code class="language-plaintext highlighter-rouge">goo()</code>è¿™ç§çš„<code class="language-plaintext highlighter-rouge">unnamed variable</code>ã€‚ä¸ºä»€ä¹ˆ<strong>C++</strong>è¦åšå‡ºè¿™ç§è§„å®šï¼Œè¯¦è§<a href="http://thbecker.net/articles/rvalue_references/section_05.html">è¿™ç¯‡æ–‡ç« </a>ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">foo</span><span class="p">(</span><span class="n">X</span><span class="o">&amp;&amp;</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">X</span> <span class="n">anotherX</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span> <span class="c1">// calls X(X const &amp; rhs)</span>
<span class="p">}</span>

<span class="n">X</span><span class="o">&amp;&amp;</span> <span class="n">goo</span><span class="p">();</span>
<span class="n">X</span> <span class="n">x</span> <span class="o">=</span> <span class="n">goo</span><span class="p">();</span> <span class="c1">// calls X(X&amp;&amp; rhs) because the thing on the righ side has no name</span>
</code></pre></div></div>

<p>ç®€è€Œè¨€ä¹‹ï¼Œå¦‚æœåœ¨ä»£ç <code class="language-plaintext highlighter-rouge">X anotherX = x</code>ä¸­çš„<code class="language-plaintext highlighter-rouge">x</code>è¢«å½’ç±»ä¸ºä¸€ä¸ª<code class="language-plaintext highlighter-rouge">rvalue</code>ï¼Œé‚£ä¹ˆè¿™æ„å‘³ç€æ­¤å¼ä¹‹åï¼Œç­‰å¼å³ä¾§ä½œä¸ºä¸€ä¸ªå³å€¼ï¼Œåº”è¯¥æ˜¯æ¶ˆäº¡äº†ï¼š</p>

<blockquote>
  <ol>
    <li>An object that is an <strong>l-value</strong> is <strong>NOT</strong> disposable, so you can
copy from, but definitely <strong>cannot</strong> move from.</li>
    <li>An object that is an <strong>r-value</strong> is disposable, so you <strong>can</strong> either
copy or move from.</li>
  </ol>
</blockquote>

<p>ä½†æ˜¯åœ¨è¿™é‡Œæ˜¾ç„¶æˆ‘ä»¬ä»ç„¶å¯ä»¥é€šè¿‡<code class="language-plaintext highlighter-rouge">&amp;x</code>è·å–å…³äº<code class="language-plaintext highlighter-rouge">x</code>çš„ä¿¡æ¯ï¼Œ<code class="language-plaintext highlighter-rouge">x</code>æœ¬èº«åº”è¯¥è¢«è§†ä¸ºä¸€ä¸ª<code class="language-plaintext highlighter-rouge">lvalue</code>ã€‚</p>

<p>è€Œå½“æˆ‘ä»¬è¯•å›¾ç»™å‡½æ•°<code class="language-plaintext highlighter-rouge">foo(X&amp;&amp; x)</code>ä¼ é€’å‚æ•°çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿè¦ä¿è¯ä¼ å…¥çš„å‚æ•°æœ¬èº«æ˜¯ä¸€ä¸ªå³å€¼(è¿™é‡Œä¹Ÿæ˜¯è¯´çš„å‚æ•°çš„<code class="language-plaintext highlighter-rouge">value category</code>)ï¼Œå› ä¸ºæˆ‘ä»¬åªå…è®¸å°†<strong>å³å€¼ç»‘å®šåˆ°å³å€¼å¼•ç”¨ä¸Š</strong>ã€‚è¿™ä¹Ÿæ˜¯<code class="language-plaintext highlighter-rouge">std::move()</code>ä¼šæ´¾ä¸Šç”¨åœºçš„åœ°æ–¹:</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111202240703.png" alt="image-20211120224058588" style="zoom:50%;" /></p>

<h4 id="move-constructor--move-assignment">Move Constructor &amp; Move assignment</h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">StringVector</span><span class="p">(</span><span class="n">StringVector</span><span class="o">&amp;&amp;</span> <span class="n">other</span><span class="p">);</span>
<span class="n">StringVector</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">StringVector</span><span class="o">&amp;&amp;</span> <span class="n">rhs</span><span class="p">);</span>
</code></pre></div></div>

<p>åœ¨å†™è¿™ä¸¤ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œå³ä¹‹å‰è°ˆåˆ°çš„å‡½æ•°å‚æ•°ä¸­çš„<code class="language-plaintext highlighter-rouge">StringVector&amp;&amp; other</code>çš„<code class="language-plaintext highlighter-rouge">value category</code>å…¶å®æ˜¯<code class="language-plaintext highlighter-rouge">lvalue</code>ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å†™å‡ºå¦‚ä¸‹çš„ä»£ç ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Axess</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">Axess</span><span class="o">&amp;&amp;</span> <span class="n">rhs</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">students</span> <span class="o">=</span> <span class="n">rhs</span><span class="p">.</span><span class="n">students</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æˆ‘ä»¬è¿˜æ˜¯æŠŠæ•°æ®copyäº†ä¸€ä»½â€¦â€¦</p>

<p>å¦‚ä½•é¿å…è¿™ä¸ªé—®é¢˜ï¼Ÿæˆ‘ä»¬æƒ³å¦‚æœå¯ä»¥æŠŠè¿™ä¸ª<strong>å·¦å€¼å¼ºåˆ¶è½¬åŒ–ä¸ºå³å€¼</strong>å°±å¥½äº†ï¼Œä¹‹å‰ä¸æ˜¯è¯´å¯¹ä¸€ä¸ªå³å€¼å¯ä»¥çªƒå–ä»–çš„å†…å®¹å—ï¼Ÿä¸ºäº†<code class="language-plaintext highlighter-rouge">force move semantics</code>ï¼Œæˆ‘ä»¬å¼•å…¥æ–¹æ³•<code class="language-plaintext highlighter-rouge">std::move()</code>ã€‚</p>

<h4 id="move">move()</h4>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111191736625.png" alt="image-20211119173654522" style="zoom:50%;" /></p>

<p>é¦–å…ˆä¸€ä¸ªç–‘æƒ‘å°±æ˜¯ï¼Œæ—¢ç„¶å³å€¼å¼•ç”¨åªèƒ½è¢«ç»‘å®šåˆ°å³å€¼ä¸Šï¼Œé‚£ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥å°†å·¦å€¼<code class="language-plaintext highlighter-rouge">rhs</code>ä¼ å…¥åˆ°å£°æ˜ä¸º<code class="language-plaintext highlighter-rouge">move(T&amp;&amp; t)</code>çš„å‚æ•°ä¸­å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºè¿™é‡Œçš„<code class="language-plaintext highlighter-rouge">T&amp;&amp; t</code>å¹¶é<code class="language-plaintext highlighter-rouge">rvalue reference</code>ï¼Œè€Œæ˜¯ä¸€ç§<strong>forwarding references(universal references)</strong>ã€‚ï¼ˆä¸‹è¾¹ä¼šä»‹ç»ï¼‰</p>

<p>ä½¿ç”¨<code class="language-plaintext highlighter-rouge">move</code>å‡½æ•°å¯ä»¥å¸®åŠ©æˆ‘ä»¬å¼ºåˆ¶æ‰§è¡Œ<code class="language-plaintext highlighter-rouge">move semantics</code>(<code class="language-plaintext highlighter-rouge">Forcing Move Semantics</code>)ï¼Œå®ƒå°†å‚æ•°è½¬åŒ–ä¸ºä¸€ä¸ª<code class="language-plaintext highlighter-rouge">rvalue reference</code>(<code class="language-plaintext highlighter-rouge">type</code>)çš„<code class="language-plaintext highlighter-rouge">ravlue</code>(<code class="language-plaintext highlighter-rouge">value category</code>)ã€‚</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111191801959.png" alt="image-20211119180156845" style="zoom:50%;" /></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">&gt;</span> 
<span class="k">typename</span> <span class="n">remove_reference</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">&amp;&amp;</span>
<span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="k">noexcept</span>
<span class="p">{</span>
  <span class="k">typedef</span> <span class="k">typename</span> <span class="n">remove_reference</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">&amp;&amp;</span> <span class="n">RvalRef</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">RvalRef</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span> 
</code></pre></div></div>

<p>é€šè¿‡è§‚å¯Ÿ<code class="language-plaintext highlighter-rouge">move</code>çš„å®ç°ï¼Œæˆ‘ä»¬å‘ç°å†™ä½œ<code class="language-plaintext highlighter-rouge">static_cast&lt;X&amp;&amp;&gt;(x)</code>ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½†<code class="language-plaintext highlighter-rouge">std::move</code>æ›´å¥½ï¼ˆ<code class="language-plaintext highlighter-rouge">more expressive</code>ï¼‰.</p>

<blockquote>
  <p>å¦‚æœè¿™é‡Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">static_cast</code>ï¼Œè€Œé<code class="language-plaintext highlighter-rouge">std::move</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦ä½œé‡è½½å·²åˆ†åˆ«é€‚åº”ä¼ å…¥çš„<code class="language-plaintext highlighter-rouge">X</code>ç»è¿‡æ¨æ–­åå˜ä¸º<code class="language-plaintext highlighter-rouge">X&amp;</code>ï¼ˆåŸæœ¬çš„<code class="language-plaintext highlighter-rouge">X</code>ä¸º<code class="language-plaintext highlighter-rouge">lvalue</code>ï¼‰ï¼Œä»¥åŠä¿æŒ<code class="language-plaintext highlighter-rouge">X</code>ï¼ˆåŸæœ¬çš„<code class="language-plaintext highlighter-rouge">X</code>ä¸º<code class="language-plaintext highlighter-rouge">rvalue</code>ï¼‰çš„ä¸¤ç§æƒ…å†µã€‚è€Œåœ¨åŸå‡½æ•°<code class="language-plaintext highlighter-rouge">std:move</code>ä¸­ä½¿ç”¨<code class="language-plaintext highlighter-rouge">remove_reference</code>çš„åŸå› å°±æ˜¯é¿å…å› å¯¹<code class="language-plaintext highlighter-rouge">static_cast&lt;X&amp;&amp;&gt;</code>ä¸­çš„<code class="language-plaintext highlighter-rouge">unversal referneces</code>è¿›è¡Œ<code class="language-plaintext highlighter-rouge">reference-collapsing</code>ä»è€Œæœ€ç»ˆè¿”å›ä¸€ä¸ªå·¦å€¼å¼•ç”¨ã€‚</p>
</blockquote>

<p><strong>é—®é¢˜æ¥äº†ï¼Œä¸ºä»€ä¹ˆè½¬åŒ–æˆä¸€ä¸ªå³å€¼å¼•ç”¨çš„<code class="language-plaintext highlighter-rouge">type</code>æˆ‘ä»¬å°±å¯ä»¥è½¬ç§»å¯¹è±¡æ§åˆ¶æƒäº†å‘¢ï¼Ÿ</strong></p>

<p>æ ¹æ®<em>C++ Primer</em>ï¼Œä½¿ç”¨<code class="language-plaintext highlighter-rouge">std::move(rr1)</code>æ„å‘³ç€æ‰¿è¯ºï¼šé™¤äº†å¯¹<code class="language-plaintext highlighter-rouge">rr1</code>è¿›è¡Œ<strong>èµ‹å€¼æˆ–è€…é”€æ¯å¤–ï¼Œä¸å†ä½¿ç”¨å®ƒ</strong>ã€‚è¿™ä¸ä¹Ÿæ­£æ˜¯æˆ‘ä»¬ä¸€å¼€å§‹çš„åˆè¡·å—ï¼Ÿâ€œå½“æˆ‘ä»¬å¯¹å‡½æ•°ä¼ å…¥ä¸€ä¸ªå³å€¼ä½œä¸ºå‚æ•°çš„æ—¶å€™ï¼Œå› ä¸ºå®ƒè¡Œå°†é”€æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬è®¡åˆ’çªƒå–å®ƒçš„å€¼ï¼ŒæŠŠæˆ‘ä»¬çš„æŒ‡é’ˆæŒ‡å‘ä»–å­˜å‚¨çš„å†…å®¹æ‰€åœ¨çš„ä½ç½®ã€‚â€</p>

<h4 id="universal-references">Universal References</h4>

<p>æ ¹æ®<a href="https://isocpp.org/blog/2012/11/universal-references-in-c11-scott-meyers">è¿™ç¯‡æ–‡ç« </a>ï¼Œå¦‚æœä¸€ä¸ªç±»å‹ä¸º<code class="language-plaintext highlighter-rouge">T&amp;&amp;</code>çš„å˜é‡æˆ–è€…å‚æ•°ï¼Œå…¶ä¸­<code class="language-plaintext highlighter-rouge">T</code>ä¸º<code class="language-plaintext highlighter-rouge">deduced type</code>ï¼Œé‚£ä¹ˆæ­¤æ—¶è¯¥å‚æ•°æˆ–è€…å˜é‡å³ä¸º<code class="language-plaintext highlighter-rouge">universal reference</code>. <code class="language-plaintext highlighter-rouge">universal reference</code><strong>åˆ°åº•æ˜¯å·¦å€¼å¼•ç”¨è¿˜æ˜¯å³å€¼å¼•ç”¨å®Œå…¨å–å†³äºæˆ‘ä»¬å¦‚ä½•åˆå§‹åŒ–å®ƒï¼Œä¹Ÿå°±æ˜¯è¯´æ—¢å¯ä»¥ç»‘å®šåˆ°å·¦å€¼ä¸Šï¼Œä¹Ÿå¯ä»¥ç»‘å®šåˆ°å³å€¼ä¸Š</strong>ï¼š</p>

<blockquote>
  <ul>
    <li>If the expression initializing a universal reference is an lvalue, the universal reference becomes an lvalue reference.</li>
    <li>If the expression initializing the universal reference is an rvalue, the universal reference becomes an rvalue reference.</li>
  </ul>
</blockquote>

<p>è€Œæ ¹æ®å®˜æ–¹æ–‡æ¡£ï¼Œ<code class="language-plaintext highlighter-rouge">universal reference</code>ä¸»è¦åº”ç”¨äºè¿™ä¸¤ä¸ªåœ°æ–¹ï¼š</p>

<blockquote>
  <p>Forwarding references are a special kind of references that preserve the value category of a function argument, making it possible to <em>forward</em> it by means of <a href="https://en.cppreference.com/w/cpp/utility/forward">std::forward</a>. Forwarding references are either:</p>

  <ol>
    <li><strong>function parameter of a function template</strong> declared as rvalue reference to cv-unqualified <a href="https://en.cppreference.com/w/cpp/language/template_parameters#Type_template_parameter">type template parameter</a> of that same function template.</li>
    <li><strong>auto&amp;&amp;</strong> except when deduced from a brace-enclosed initializer list:</li>
  </ol>
</blockquote>

<blockquote>
  <p><strong>cv-unqualified</strong>:</p>

  <p>A type is â€œcv-unqualifiedâ€ if it doesnâ€™t have any cv-qualifiers. A cv-qualifer is either <code class="language-plaintext highlighter-rouge">const</code> or <code class="language-plaintext highlighter-rouge">volatile</code></p>
</blockquote>

<p>å…¶å®åœ¨<code class="language-plaintext highlighter-rouge">auto&amp;&amp;</code>çš„è¿™ç§æƒ…å†µä¸­ï¼Œä¸<code class="language-plaintext highlighter-rouge">function template parameters</code>çš„æƒ…å†µåŸºæœ¬å®Œå…¨ç›¸åŒï¼Œä¹Ÿæ˜¯åœ¨åš<code class="language-plaintext highlighter-rouge">type deduction</code>è€Œå·²ã€‚æ¯”å¦‚åœ¨è¿™ä¸ªä¾‹å­å½“ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">auto&amp;&amp;</code>å°±æ˜¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">lvalue reference</code>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">;</span>
<span class="p">...</span>
<span class="k">auto</span><span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</code></pre></div></div>

<p>å› ä¸º<code class="language-plaintext highlighter-rouge">v[0]</code>æœ¬èº«è¿”å›çš„æ˜¯ä¸€ä¸ªå·¦å€¼å¼•ç”¨ï¼Œè€Œæ‰€æœ‰çš„å·¦å€¼å¼•ç”¨ï¼ˆ<code class="language-plaintext highlighter-rouge">type</code>ï¼‰å¿…å®šéƒ½æ˜¯å·¦å€¼(<code class="language-plaintext highlighter-rouge">value category</code>)ã€‚</p>

<h5 id="notice-where-type-decution-takes-place">Notice! Where type decution takes place?</h5>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code class="language-plaintext highlighter-rouge">universal reference</code>åªèƒ½å­˜åœ¨äº<code class="language-plaintext highlighter-rouge">type deduction</code><strong>ç›´æ¥å‡ºç°</strong>çš„åœ°æ–¹ï¼Œä»€ä¹ˆå«ç›´æ¥å‡ºç°ï¼Ÿå¹¶ä¸”åªæœ‰å½“å¼•ç”¨å£°æ˜ä¸º<code class="language-plaintext highlighter-rouge">T&amp;&amp;</code>çš„å½¢å¼æ—¶æ‰å¯ä»¥ï¼Œä¹Ÿå°±æ˜¯è¯´ä»¥ä¸‹çš„ä¾‹å­å…¨éƒ¨ä¸º<code class="language-plaintext highlighter-rouge">rvalue reference</code>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;&amp;</span> <span class="n">param</span><span class="p">);</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;&amp;</span> <span class="n">param</span><span class="p">);</span>
</code></pre></div></div>

<p>ç‰¹åˆ«çš„æ˜¯ï¼Œåœ¨<em>Scott Meyers</em>çš„<a href="https://isocpp.org/blog/2012/11/universal-references-in-c11-scott-meyers">æ–‡ç« </a>ä¸­ï¼Œæœ‰è¿™ä¹ˆä¸€ä¸ªä¾‹å­ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span> <span class="k">class</span> <span class="nc">Allocator</span> <span class="o">=</span> <span class="n">allocator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">vector</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="p">...</span>
    <span class="kt">void</span> <span class="n">push_back</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;&amp;</span> <span class="n">x</span><span class="p">);</span>       <span class="c1">// fully specified parameter type â‡’ no type deduction;</span>
    <span class="p">...</span>                          <span class="c1">// &amp;&amp; â‰¡ rvalue reference</span>
<span class="p">};</span>
</code></pre></div></div>

<p>è¿™å°±æ˜¯<code class="language-plaintext highlighter-rouge">vector</code>çš„<code class="language-plaintext highlighter-rouge">push_back</code>æ–¹æ³•ï¼Œåœ¨è¿™é‡Œ<code class="language-plaintext highlighter-rouge">T&amp;&amp;</code>æ˜¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">rvalue reference</code>è€Œé<code class="language-plaintext highlighter-rouge">universal reference</code>ï¼Œå› ä¸ºç±»å‹æ¨æ–­å¹¶æ²¡æœ‰å‘ç”Ÿåœ¨<code class="language-plaintext highlighter-rouge">push_back</code>å‡½æ•°çš„å£°æ˜å¤„ï¼Œ<code class="language-plaintext highlighter-rouge">vector&lt;T&gt;</code>ä¾èµ–äº<code class="language-plaintext highlighter-rouge">T</code>ï¼ˆ<code class="language-plaintext highlighter-rouge">dependent name</code><a href="https://en.cppreference.com/w/cpp/language/dependent_name">1</a>ï¼‰ã€‚åªè¦<code class="language-plaintext highlighter-rouge">vector</code>çš„ç±»å‹è¢«ç¡®å®šï¼Œ<code class="language-plaintext highlighter-rouge">push_back</code>æ–¹æ³•ä¾¿ä¸å†éœ€è¦<code class="language-plaintext highlighter-rouge">type deduction</code>äº†ã€‚æ‰€ä»¥<code class="language-plaintext highlighter-rouge">universal reference</code>åªä¼šå‡ºç°åœ¨<code class="language-plaintext highlighter-rouge">type deduction</code>çš„ä½ç½®ä¸Šã€‚æ‰€ä»¥åœ¨<code class="language-plaintext highlighter-rouge">emplace_back</code>çš„å£°æ˜é‡Œï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span> <span class="k">class</span> <span class="nc">Allocator</span> <span class="o">=</span> <span class="n">allocator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">vector</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="p">...</span>
    <span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span><span class="o">...</span> <span class="nc">Args</span><span class="p">&gt;</span>
    <span class="kt">void</span> <span class="n">emplace_back</span><span class="p">(</span><span class="n">Args</span><span class="o">&amp;&amp;</span><span class="p">...</span> <span class="n">args</span><span class="p">);</span> <span class="c1">// deduced parameter types â‡’ type deduction;</span>
    <span class="p">...</span>                                <span class="c1">// &amp;&amp; â‰¡ universal references</span>
<span class="p">};</span>
</code></pre></div></div>

<p>è¿™é‡Œçš„<code class="language-plaintext highlighter-rouge">&amp;&amp;</code>å°±æ˜¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">universal reference</code>äº†ã€‚äºæ˜¯æˆ‘ä»¬çŸ¥é“ï¼Œ<code class="language-plaintext highlighter-rouge">move()</code>é‡Œçš„<code class="language-plaintext highlighter-rouge">&amp;&amp;</code>ç¡®å®æ˜¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">universal reference</code>ã€‚</p>

<h5 id="reference-to-reference">reference to reference</h5>

<p>é€šå¸¸æ„ä¹‰ä¸Šï¼Œä»¥ä¸‹è¯­å¥æ˜¯ä¸åˆæ³•çš„ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Widget</span> <span class="n">w1</span><span class="p">;</span>
<span class="n">Widget</span><span class="o">&amp;</span> <span class="o">&amp;</span> <span class="n">w2</span> <span class="o">=</span> <span class="n">w1</span><span class="p">;</span>
</code></pre></div></div>

<p>ä½†æ˜¯æˆ‘ä»¬æ— æ³•åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­é¿å…å‡ºç°å¦‚ä¸Šæ‰€ç¤ºçš„æƒ…å†µï¼šä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ<strong>C++</strong>æå‡ºäº†<code class="language-plaintext highlighter-rouge">reference-collapsing</code>æ³•åˆ™ã€‚</p>

<h5 id="reference-collapsing">reference-collapsing</h5>

<p><strong>å½“æˆ‘ä»¬å¯¹<code class="language-plaintext highlighter-rouge">universal reference</code>ç±»å‹çš„æ¨¡æ¿å‚æ•°åšç±»å‹æ¨æ–­æ—¶</strong>ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;&amp;</span> <span class="n">param</span><span class="p">);</span>

<span class="n">f</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</code></pre></div></div>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code class="language-plaintext highlighter-rouge">lvalue</code> <code class="language-plaintext highlighter-rouge">T</code>(<code class="language-plaintext highlighter-rouge">value category</code>)ä¼šè¢«æ¨æ–­ä¸º<code class="language-plaintext highlighter-rouge">T&amp;</code>ï¼ˆ<code class="language-plaintext highlighter-rouge">type</code>ï¼‰ï¼Œè€Œ<code class="language-plaintext highlighter-rouge">rvalue</code> <code class="language-plaintext highlighter-rouge">T(</code>value category<code class="language-plaintext highlighter-rouge">)</code>åˆ™è¢«æ¨æ–­ä¸º<code class="language-plaintext highlighter-rouge">T</code>ï¼ˆ<code class="language-plaintext highlighter-rouge">type</code>ï¼‰ã€‚è¿™æ„å‘³ç€ï¼Œæˆ‘ä»¬ä¸€å®šä¼šé‡åˆ°<code class="language-plaintext highlighter-rouge">&amp; &amp;&amp;</code>çš„ç±»ä¼¼æƒ…å†µï¼Œç”±äºè¿™çœ‹èµ·æ¥ä¸å¤ªåˆç†ï¼Œ<strong>C++</strong>æ˜¯ç”¨äº†<strong>å¼•ç”¨æŠ˜å </strong>ï¼ˆ<code class="language-plaintext highlighter-rouge">reference-collapsing</code>ï¼‰çš„æ–¹æ³•è§£å†³è¿™ä¸€é—®é¢˜ï¼š</p>

<blockquote>
  <ul>
    <li>An rvalue reference to an rvalue reference becomes (â€œcollapses intoâ€) an rvalue reference.</li>
    <li>All other references to references (i.e., all combinations involving an lvalue reference) collapse into an lvalue reference.</li>
  </ul>
</blockquote>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“<strong>ä¸€ä¸ªå˜é‡çš„ç±»å‹æœ¬èº«å°±æ˜¯å¼•ç”¨æ—¶ï¼Œæƒ…å†µæœ‰æ‰€ä¸åŒï¼šå˜é‡ç±»å‹ï¼ˆ<code class="language-plaintext highlighter-rouge">type</code>ï¼‰çš„å¼•ç”¨éƒ¨åˆ†ä¼šè¢«ç›´æ¥å¿½è§†</strong>ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
<span class="kt">int</span><span class="o">&amp;&amp;</span> <span class="n">r1</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>                   <span class="c1">// r1â€™s type is int&amp;&amp;</span>
<span class="kt">int</span><span class="o">&amp;</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>                     <span class="c1">// r2â€™s type is int&amp;</span>

<span class="n">f</span><span class="p">(</span><span class="n">r1</span><span class="p">);</span>
<span class="n">f</span><span class="p">(</span><span class="n">r2</span><span class="p">);</span>
</code></pre></div></div>

<p>æ‰€ä»¥ä½•æ—¶ä¼šå‘ç”Ÿå¼•ç”¨æŠ˜å å‘¢ï¼Ÿé™¤äº†æ¨¡æ¿å®ä¾‹åŒ–ï¼ˆ<code class="language-plaintext highlighter-rouge">template instantiation</code>ï¼‰ä»¥å¤–ï¼Œå½“ç„¶è¿˜åŒ…æ‹¬<code class="language-plaintext highlighter-rouge">auto</code>ï¼Œä»¥åŠ<code class="language-plaintext highlighter-rouge">typedef</code>å’Œ<code class="language-plaintext highlighter-rouge">decltype</code>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// typedef:</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">Widget</span> <span class="p">{</span>
    <span class="k">typedef</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">LvalueRefType</span><span class="p">;</span>
<span class="p">};</span>
<span class="c1">// use</span>
<span class="n">Widget</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&amp;&gt;</span> <span class="n">w</span><span class="p">;</span>
</code></pre></div></div>

<h4 id="perfect-forwarding">Perfect Forwarding</h4>

<p>ä»€ä¹ˆæ˜¯<code class="language-plaintext highlighter-rouge">perfect forwarding</code>?é€šä¿—çš„è®²ï¼Œå°±æ˜¯å¦‚æœæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå‡½æ•°å°†ä¸€ä¸ªå‚æ•°è½¬å‘ç»™å¦ä¸€ä¸ªå‡½æ•°å¤„ç†ï¼Œåœ¨ä¼ é€’çš„è¿‡ç¨‹ä¸­ï¼Œå‚æ•°å§‹ç»ˆèƒ½å¤Ÿä¿æŒå…ˆå‰çš„ç‰¹å¾ï¼Œæ¯”å¦‚å³å€¼å§‹ç»ˆæœªä¸ºå³å€¼ï¼Œå·¦å€¼å§‹ç»ˆä¸ºå·¦å€¼ã€‚<a href="https://stackoverflow.com/questions/3582001/what-are-the-main-purposes-of-using-stdforward-and-which-problems-it-solves">è¿™é‡Œ</a>è¯¦ç»†è®¨è®ºäº†è¿™ä¸€ä¸»é¢˜ã€‚ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦<code class="language-plaintext highlighter-rouge">perfect forwarding</code>ï¼Ÿå› ä¸ºä½œä¸ºè®¾è®¡è€…ï¼Œæˆ‘ä»¬å¿…é¡»è€ƒè™‘åˆ°å¤šç§ç”¨æˆ·è¾“å…¥çš„å¯èƒ½æ€§-ç»™å…¥å·¦å€¼ã€ç»™å…¥å³å€¼ï¼ˆæ¯”å¦‚ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">temporaray object</code>ï¼‰ã€ç»™å¦‚çš„æ•°æ®å¸¦æœ‰<code class="language-plaintext highlighter-rouge">const</code>ç­‰ç­‰ï¼Œè€Œæ‰€æœ‰çš„è¿™äº›è¾“å…¥æˆ‘ä»¬å¸Œæœ›åœ¨ç»è¿‡<code class="language-plaintext highlighter-rouge">factory function</code>ä¹‹åèƒ½å¤Ÿä¸<code class="language-plaintext highlighter-rouge">factory function</code>ä¸å­˜åœ¨çš„æƒ…å†µå®Œå…¨ä¸€æ ·ã€‚</p>

<p>ä¸¾ä¸ªä¾‹å­ï¼Œä»¥å¦‚ä¸‹çš„ä»£ç ä¸ºä¾‹ï¼Œæˆ‘ä»¬å°è¯•è¦å°†å‚æ•°<code class="language-plaintext highlighter-rouge">arg</code>é€šè¿‡<code class="language-plaintext highlighter-rouge">factory function</code>ä¼ é€’ç»™<code class="language-plaintext highlighter-rouge">T</code>çš„æ„é€ å‡½æ•°ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">Arg</span><span class="p">&gt;</span> 
<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">factory</span><span class="p">(</span><span class="n">Arg</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span> 
  <span class="k">return</span> <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">T</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
<span class="p">}</span> 

<span class="c1">// amother example</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">A</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">B</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">C</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="n">A</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span> <span class="n">B</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">,</span> <span class="n">C</span><span class="o">&amp;</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">E</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªå¯è¡Œæ–¹æ¡ˆï¼Œä¸»è¦ä¾é ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">std::forward()</code></li>
  <li><code class="language-plaintext highlighter-rouge">reference-collapsing</code></li>
</ol>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// perfect forwarding</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">Arg</span><span class="p">&gt;</span> 
<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">factory</span><span class="p">(</span><span class="n">Arg</span><span class="o">&amp;&amp;</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span> 
  <span class="k">return</span> <span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">T</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Arg</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arg</span><span class="p">)));</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">std::forward()</code>çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// forward:</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">S</span><span class="p">&gt;</span>
<span class="n">S</span><span class="o">&amp;&amp;</span> <span class="n">forward</span><span class="p">(</span><span class="k">typename</span> <span class="n">remove_reference</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="k">noexcept</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&amp;&amp;&gt;</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="p">}</span> 
</code></pre></div></div>

<p>ä¸ºä»€ä¹ˆè¿™ç§æ–¹å¼å¯ä»¥å®ç°å®Œç¾è½¬å‘ï¼Ÿæˆ‘ä»¬å¯ä»¥å°è¯•å‘ä¸Šè¿°ä»£ç ä¸­åˆ†åˆ«ä¼ é€’å·¦å€¼ä¸å³å€¼ä»¥<a href="http://thbecker.net/articles/rvalue_references/section_08.html#footnote_1">éªŒè¯ç»“æœ</a>ã€‚åœ¨<em>Scott Meyer</em>çš„ä¸€ä¸ª<strong>talk</strong>ä¸­ï¼Œå¾ˆå½¢è±¡çš„å†™å‡ºäº†å®é™…ä¸Š<code class="language-plaintext highlighter-rouge">std::forward()</code>çš„ä½œç”¨æœºç†ï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111202140959.png" style="zoom:50%;" /></p>

<h4 id="noexcept">noexcept</h4>

<p>åœ¨å‡½æ•°å£°æ˜ååŠ <code class="language-plaintext highlighter-rouge">noexcept</code>æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ</p>

<p>æ ¹æ®<a href="https://www.cnblogs.com/RioTian/p/15115387.html">è¿™ç¯‡æ–‡ç« </a>ï¼Œé¦–å…ˆï¼Œå®ƒä¼šè¿›è¡Œç¼–è¯‘å™¨ä¼˜åŒ–ï¼š</p>

<blockquote>
  <p>å› ä¸ºåœ¨è°ƒç”¨ noexcept å‡½æ•°æ—¶ä¸éœ€è¦è®°å½• exception handlerï¼Œæ‰€ä»¥ç¼–è¯‘å™¨å¯ä»¥ç”Ÿæˆæ›´é«˜æ•ˆçš„äºŒè¿›åˆ¶ç ï¼ˆç¼–è¯‘å™¨æ˜¯å¦ä¼˜åŒ–ä¸ä¸€å®šï¼Œä½†ç†è®ºä¸Š noexcept ç»™äº†ç¼–è¯‘å™¨æ›´å¤šä¼˜åŒ–çš„æœºä¼šï¼‰ã€‚å¦å¤–ç¼–è¯‘å™¨åœ¨ç¼–è¯‘ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">noexcept(false)</code> çš„å‡½æ•°æ—¶å¯èƒ½ä¼šç”Ÿæˆå¾ˆå¤šå†—ä½™çš„ä»£ç ï¼Œè¿™äº›ä»£ç è™½ç„¶åªåœ¨å‡ºé”™çš„æ—¶å€™æ‰§è¡Œï¼Œä½†è¿˜æ˜¯ä¼šå¯¹ Instruction Cache é€ æˆå½±å“ï¼Œè¿›è€Œå½±å“ç¨‹åºæ•´ä½“çš„æ€§èƒ½</p>
</blockquote>

<p>å…¶æ¬¡ï¼Œå½“æˆ‘ä»¬è¯•å›¾ä½¿ç”¨å³å€¼å¼•ç”¨ä¼˜åŒ–ä»£ç æ—¶ï¼Œå¦‚æœåœ¨ç§»åŠ¨æ„é€ å‡½æ•°å’Œç§»åŠ¨èµ‹å€¼å‡½æ•°å<strong>ä¸æ·»åŠ </strong><code class="language-plaintext highlighter-rouge">noexcept</code>æ ‡è¯†ç¬¦ï¼Œåˆ™ç¼–è¯‘å™¨ä¸ä¼šè¿›è¡Œ<code class="language-plaintext highlighter-rouge">move semantics</code>çš„æ“ä½œï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111202337531.png" alt="image-20211120233753420" style="zoom:50%;" /></p>

<h4 id="rule-of-five">Rule Of Five</h4>

<blockquote>
  <p>If you explicitly define (or delete) a copy constructor, copy assignment, move constructor, move assignment, or destructor, you should define (or delete) all five.</p>

  <p>The fact that you defined one of these means one of your members has ownership issues that need to be resolved.</p>
</blockquote>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè‡ª<strong>C++11</strong>èµ·ï¼Œå¦‚æœæ²¡æœ‰ç”¨æˆ·å®šä¹‰çš„å¤åˆ¶æ„é€ å‡½æ•°ã€å¤åˆ¶èµ‹å€¼è¿ç®—ç¬¦ã€ææ„å‡½æ•°ï¼Œå¹¶ä¸”ç”Ÿæˆçš„ç§»åŠ¨æ„é€ å‡½æ•°ï¼ˆç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ï¼‰æœ‰æ•ˆï¼Œåˆ™ç¼–è¯‘å™¨ä¼šéšå¼ç”Ÿæˆç§»åŠ¨æ„é€ å‡½æ•°ï¼ˆç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ï¼‰ã€‚</p>

<h3 id="copy-elision--rvo">Copy elision &amp; RVO</h3>

<p><code class="language-plaintext highlighter-rouge">copy elision</code>ï¼Œä¹Ÿå«<strong>å¤åˆ¶çœç•¥</strong>ï¼Œå¤åˆ¶çœç•¥å¸¸å‡ºç°<strong>æˆ‘ä»¬ä½¿ç”¨ä¸´æ—¶å¯¹è±¡åˆå§‹åŒ–ä¸€ä¸ªæ–°å¯¹è±¡æ—¶</strong>ï¼š</p>

<p>å…±æœ‰ä¸¤ç§ç¯å¢ƒï¼Œåˆ†åˆ«ä¸ºï¼š</p>

<ul>
  <li>åœ¨ â€œreturnâ€ è¯­å¥ä¸­ï¼Œå½“æ“ä½œæ•°ä¸ºä¸å‡½æ•°è¿”å›ç±»å‹ä¸ºåŒä¸€ç±»ç±»å‹</li>
  <li>åœ¨å˜é‡çš„åˆå§‹åŒ–ä¸­ï¼Œå½“åˆå§‹åŒ–è¡¨è¾¾å¼ä¸ºä¸å˜é‡ç±»å‹ä¸ºåŒä¸€ç±»ç±»å‹</li>
</ul>

<p>åŒæ—¶ï¼Œå¯ä»¥åŸºæœ¬åˆ†ä¸ºä¸¤ç§åº”ç”¨åœºæ™¯ï¼š</p>

<ol>
  <li>ä¸€ä¸ªå‡½æ•°ä»¥å€¼ä¼ é€’å‚æ•°ï¼Œå½“è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬é€‰æ‹©ä¼ å…¥ä¸€ä¸ªä¸´æ—¶å¯¹è±¡ä½œä¸ºå‚æ•°ï¼š</li>
</ol>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">foo</span><span class="p">(</span><span class="n">MyClass</span> <span class="n">param</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// do something</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// pass a temporary object to initialize the param</span>
    <span class="n">foo</span><span class="p">(</span><span class="n">MyClass</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä½•ä¸ºå¤åˆ¶çœç•¥ï¼Ÿè¿™é‡Œï¼Œç¨‹åºåŸæœ¬éœ€è¦è°ƒç”¨ç§»åŠ¨æ„é€ å‡½æ•°ï¼ŒæŠŠä¸´æ—¶å¯¹è±¡<code class="language-plaintext highlighter-rouge">MyClass()</code>ç§»åŠ¨åˆ°<code class="language-plaintext highlighter-rouge">param</code>ä¸­ï¼Œè€Œç”±äº<code class="language-plaintext highlighter-rouge">copy elision</code>æœºåˆ¶çš„å­˜åœ¨ï¼Œè¿™é‡Œå°±å¯ä»¥ç›´æ¥æŠŠç”Ÿæˆçš„<code class="language-plaintext highlighter-rouge">temporary object</code>ä¼ å…¥å‡½æ•°ï¼Œè€Œä¸éœ€è¦å¤šä½™çš„ç§»åŠ¨ï¼ˆæˆ–è€…å¤åˆ¶ï¼‰äº†ã€‚</p>

<ol>
  <li>è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œæ˜¯å‡½æ•°è¿”å›ä¸€ä¸ªä¸´æ—¶å¯¹è±¡ï¼Œè¿™é‡Œ<strong>C++</strong>å¼•å‡ºäº†é‡è¦çš„ç¼–è¯‘å™¨ä¼˜åŒ–æ–¹æ³•ï¼š<strong>RVO</strong>.</li>
</ol>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code class="language-plaintext highlighter-rouge">copy elision</code>å³ä½¿åœ¨å¤åˆ¶/ç§»åŠ¨æ“ä½œå­˜åœ¨<code class="language-plaintext highlighter-rouge">side effects</code>æ—¶ä»ç„¶é€‚ç”¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ ¹æ®<em>Wikipedia</em>ä¸Šçš„è¿™ä¸ªä¾‹å­ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="nc">C</span> <span class="p">{</span>
  <span class="n">C</span><span class="p">()</span> <span class="p">{}</span>
  <span class="n">C</span><span class="p">(</span><span class="k">const</span> <span class="n">C</span><span class="o">&amp;</span><span class="p">)</span> <span class="p">{</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"A copy was made.</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span> <span class="p">}</span>
<span class="p">};</span>
 
<span class="n">C</span> <span class="nf">f</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">C</span><span class="p">();</span>
<span class="p">}</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Hello World!</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
  <span class="n">C</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">f</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªä¸´æ—¶å¯¹è±¡ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨ä¼šè¿›è¡Œ<code class="language-plaintext highlighter-rouge">copy elision</code>ï¼Œè¿™é‡Œè¢«å«åš<code class="language-plaintext highlighter-rouge">Return Value Optimization(RVO)</code>ã€‚æ ¹æ®ç¼–è¯‘å™¨çš„ä¸åŒè®¾ç½®ï¼Œå®ƒå¯ä»¥é€‰æ‹©ä¼˜åŒ–æ‰ä¸€æ¬¡å°†<code class="language-plaintext highlighter-rouge">f()</code>å†…ç”Ÿæˆçš„ä¸´æ—¶å¯¹è±¡èµ‹å€¼ç»™è¿”å›å€¼çš„æ“ä½œï¼Œè¿˜å¯ä»¥é€‰æ‹©ä¼˜åŒ–æ‰ä¸€æ¬¡å°†<code class="language-plaintext highlighter-rouge">f()</code>è¿”å›å€¼èµ‹å€¼ç»™<code class="language-plaintext highlighter-rouge">C obj</code>çš„æ“ä½œï¼Œæ•…ä»¥ä¸‹æ‰€æœ‰è¾“å‡ºç»“æœéƒ½æ˜¯åˆç†çš„ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Hello</span> <span class="n">World</span><span class="o">!</span>
<span class="n">A</span> <span class="n">copy</span> <span class="n">was</span> <span class="n">made</span><span class="p">.</span>
<span class="n">A</span> <span class="n">copy</span> <span class="n">was</span> <span class="n">made</span><span class="p">.</span>
</code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Hello</span> <span class="n">World</span><span class="o">!</span>
<span class="n">A</span> <span class="n">copy</span> <span class="n">was</span> <span class="n">made</span><span class="p">.</span>
</code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Hello</span> <span class="n">World</span><span class="o">!</span>
</code></pre></div></div>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ä¾‹å­ä¸­<code class="language-plaintext highlighter-rouge">C</code>çš„å¤åˆ¶æ„é€ å‡½æ•°å¿…é¡»æ˜¯å¸¦<code class="language-plaintext highlighter-rouge">const</code>çš„å‚æ•°ï¼Œå› ä¸ºå³å€¼å¯ä»¥ç»‘å®šåˆ°<code class="language-plaintext highlighter-rouge">const</code>çš„å·¦å€¼å¼•ç”¨ï¼Œå¦‚æœæ²¡æœ‰<code class="language-plaintext highlighter-rouge">const</code>ï¼Œåˆ™ä¼šæŠ¥é”™ã€‚</p>

<p>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œåœ¨<strong>C++17</strong>ä¹‹å‰ï¼Œ<strong>ä½¿ç”¨ä¸´æ—¶å¯¹è±¡ï¼ˆä¸€ä¸ª<code class="language-plaintext highlighter-rouge">prvalue</code>ï¼‰åˆå§‹åŒ–å¦ä¸€ä¸ªå¯¹è±¡æ—¶çš„<code class="language-plaintext highlighter-rouge">copy elision</code>ä¼˜åŒ–ä¸æ˜¯å¼ºåˆ¶æ€§çš„</strong>ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ç¼–è¯‘å™¨ä¸­ä½¿ç”¨åŠ ä¸Š<em><code class="language-plaintext highlighter-rouge">-fno-elide-constructors</code></em>æ¥å…³é—­è¿™ä¸€é€‰é¡¹ã€‚è€Œæ­£å› ä¸ºè¯¥ä¼˜åŒ–æ­¤æ—¶å¹¶éå¼ºåˆ¶ï¼Œç¼–è¯‘å™¨è¦æ±‚å³ä½¿ä¼˜åŒ–å‘ç”Ÿï¼Œå¤åˆ¶æ„é€ å‡½æ•°/ç§»åŠ¨æ„é€ å‡½æ•°ä¹Ÿè¦å­˜åœ¨ï¼ˆæ˜¾å¼æˆ–è€…éšå¼ï¼ˆç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆï¼‰ï¼‰ï¼Œå¦‚æœæˆ‘ä»¬ç»™è¿™äº›å‡½æ•°åŠ ä¸Šä¸€ä¸ª<code class="language-plaintext highlighter-rouge">=delete</code>ï¼Œåˆ™ä¸èƒ½é€šè¿‡ç¼–è¯‘ã€‚</p>

<p>ä½†è‡ª<strong>C++17</strong>èµ·ï¼Œè¿™ç§è¡Œä¸ºè¢«æè¿°ä¸º<code class="language-plaintext highlighter-rouge">passing Unmaterialized objects</code>ï¼Œå®ƒå˜æˆäº†ç¼–è¯‘å™¨<strong>å¼ºåˆ¶ä¼˜åŒ–</strong>çš„ä¸€ç§è¡Œä¸ºï¼Œå³ä½¿æ­¤æ—¶å¤åˆ¶æ„é€ å‡½æ•°/ç§»åŠ¨æ„é€ å‡½æ•°ä¸å¯é€‰ï¼Œç¨‹åºä»å¯æ­£å¸¸ç¼–è¯‘è¿è¡Œã€‚</p>

<p>ä¸€ç§ç‰¹æ®Šæƒ…å†µæ˜¯<code class="language-plaintext highlighter-rouge">Named Return Value Optimization(NRVO)</code>ï¼Œæ­¤æ—¶æˆ‘ä»¬è¿”å›çš„æ˜¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">lvalue</code>ï¼Œä¸€ä¸ªå…·åå¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªä¸´æ—¶å¯¹è±¡ï¼ˆ<code class="language-plaintext highlighter-rouge">prvalue</code>ï¼‰ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">MyClass</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">MyClass</span> <span class="n">obj</span><span class="p">;</span>
    <span class="c1">// do something</span>
    <span class="k">return</span> <span class="n">obj</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// amother case: as a parameter</span>
<span class="n">MyClass</span> <span class="nf">bar</span><span class="p">(</span><span class="n">MyClass</span> <span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// do something</span>
    <span class="k">return</span> <span class="n">obj</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><strong>NRVO</strong>ç›®å‰ä»è¢«åˆ—ä¸º<strong>å¯é€‰ä¼˜åŒ–</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœå¼€å¯<strong>NRVO</strong>ï¼Œæˆ‘ä»¬ä»éœ€ä¿è¯å­˜åœ¨åˆé€‚çš„å¤åˆ¶æ„é€ å‡½æ•°/ç§»åŠ¨æ„é€ å‡½æ•°ã€‚</p>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä¸Šè¾¹çš„ä»£ç ä¸­ï¼Œç¨‹åºåœ¨å°†å‡½æ•°å†…çš„å±€éƒ¨å˜é‡ä¼ é€’ç»™è¿”å›å€¼æ—¶ï¼Œä¼šå…ˆå°è¯•è°ƒç”¨<code class="language-plaintext highlighter-rouge">move constructor</code>è€Œé<code class="language-plaintext highlighter-rouge">copy constructor</code>ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>

<p>æ ¹æ®<a href="https://en.cppreference.com/w/cpp/language/return#Notes">å®˜æ–¹æ–‡æ¡£</a>ï¼Œåœ¨<code class="language-plaintext highlighter-rouge">overload resolution</code>çš„è¿‡ç¨‹ä¸­ï¼Œå¯¹äºä¸€ä¸ªä½äºè¿”å›å€¼ä½ç½®ä¸Šçš„è¡¨è¾¾å¼ï¼Œå¦‚æœå…·æœ‰<code class="language-plaintext highlighter-rouge">Automatic Storage Duration</code>ï¼Œé‚£ä¹ˆé¦–å…ˆä¼šå°è¯•ä½¿ç”¨<code class="language-plaintext highlighter-rouge">move constructor</code>ï¼Œå¦‚æœå¤±è´¥ï¼Œå†ä½¿ç”¨<code class="language-plaintext highlighter-rouge">copy constructor</code>:</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111211414317.png" alt="image-20211121141428179" style="zoom:50%;" /></p>

<h3 id="polymorphism">Polymorphism</h3>

<p>åœ¨å…ˆå‰å­¦ä¹ çš„<strong>CS 106L</strong>è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿæåˆ°äº†<em>å¤šæ€</em>è¿™ä¸€æ¦‚å¿µï¼Œ<code class="language-plaintext highlighter-rouge">templates</code>ä¸<code class="language-plaintext highlighter-rouge">Derived classes</code>éƒ½æ˜¯å¤šæ€ï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111232142717.png" alt="image-20211123214207558" style="zoom:50%;" /></p>

<p>åœ¨<em>CS 106X</em>çš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¯¦ç»†è®¨è®ºäº†å…³äºä»æ´¾ç”Ÿç±»åˆ°åŸºç±»çš„éšå¼è½¬æ¢è¿‡ç¨‹ã€‚åœ¨è¿™ä¸€èŠ‚ä¸­æˆ‘ä»¬å³å°†æåˆ°åŠ¨æ€ç»‘å®šï¼ˆ<code class="language-plaintext highlighter-rouge">Dynamic Binding</code>ï¼‰ï¼Œä»¥åŠè®¸å¤šå…¶ä»–çš„ç»§æ‰¿ï¼ˆ<code class="language-plaintext highlighter-rouge">Inheritance</code>ï¼‰çš„æ³¨æ„äº‹é¡¹ã€‚</p>

<h4 id="inheritance">Inheritance</h4>

<p>åœ¨æˆ‘ä»¬ä½¿ç”¨ç»§æ‰¿è¯­æ³•ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">A</span> <span class="o">:</span> <span class="k">public</span> <span class="n">B</span> <span class="p">{</span>

<span class="p">}</span>
</code></pre></div></div>

<p>æ—¶ï¼Œ<code class="language-plaintext highlighter-rouge">B</code>æ‰€åœ¨çš„ä½ç½®è¢«ç§°ä¸º<strong>æ´¾ç”Ÿç±»åˆ—è¡¨</strong>ã€‚</p>

<blockquote>
  <p>å…³é”®å­—<code class="language-plaintext highlighter-rouge">virtual</code>åªèƒ½ä½¿ç”¨åœ¨ç±»å†…ã€‚</p>
</blockquote>

<h5 id="static">static</h5>

<p>å¦‚æœåŸºç±»ä¸­å­˜åœ¨é™æ€æˆå‘˜ï¼Œåˆ™æ— è®ºä»åŸºç±»æ´¾ç”Ÿå‡ºå¤šå°‘å­ç±»ï¼Œé™æ€æˆå‘˜åªå­˜åœ¨<strong>å”¯ä¸€çš„å®ä¾‹</strong>ã€‚å¦‚æœè¯¥æˆå‘˜ä¸º<code class="language-plaintext highlighter-rouge">private</code>ï¼Œåˆ™paiâ€†shegnâ€†leiæ— æƒè®¿é—®ï¼›å¦‚æœè¯¥æˆå‘˜è¢«è®¾ç½®ä¸ºå…è®¸è®¿é—®ï¼Œåˆ™æ´¾ç”Ÿç±»ä¸åŸºç±»å‡å¯è®¿é—®ã€‚å…³äº<strong>static</strong>å…³é”®å­—åœ¨é¢å‘å¯¹è±¡æ—¶çš„ä½¿ç”¨ï¼Œä½œå¦‚ä¸‹è¡¥å……ï¼š</p>

<ol>
  <li>ç±»çš„é™æ€æˆå‘˜ç‹¬ç«‹äºä»»ä½•å¯¹è±¡ä¹‹å¤–ï¼Œå¯¹è±¡ä¸­ä¸åŒ…å«ä»»ä½•ä¸é™æ€æˆå‘˜æœ‰å…³çš„æ•°æ®ã€‚</li>
  <li>ç±»å†…é™æ€æˆå‘˜ä¸èƒ½å£°æ˜æˆ<strong>const</strong>çš„ã€‚</li>
  <li>æˆå‘˜å‡½æ•°ä¸éœ€è¦ä½œç”¨åŸŸè¿ç®—ç¬¦å³å¯è®¿é—®é™æ€æˆå‘˜ã€‚</li>
  <li>ä¸€èˆ¬æ¥è®²ï¼Œæˆ‘ä»¬åªèƒ½<strong>åœ¨ç±»å†…å£°æ˜é™æ€æˆå‘˜ï¼Œç±»å¤–åˆå§‹åŒ–ã€å®šä¹‰é™æ€æˆå‘˜</strong>ï¼Œå”¯ä¸€çš„ä¾‹å¤–æ˜¯å­—é¢å€¼å¸¸é‡ï¼š<code class="language-plaintext highlighter-rouge">static constexpr int period = 30;</code>ã€‚</li>
  <li>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨é™æ€æ•°æ®æˆå‘˜ä½œä¸ºæˆå‘˜å‡½æ•°çš„é»˜è®¤å®å‚ï¼Œä½†éé™æ€æˆå‘˜ä¸è¡Œï¼Œå› ä¸ºä»–ä»¬çš„å€¼æ˜¯å¯¹è±¡çš„ä¸€éƒ¨åˆ†ã€‚</li>
</ol>

<blockquote>
  <p>è™šå‡½æ•°ä¹Ÿå¯ä»¥æ‹¥æœ‰é»˜è®¤å®å‚ï¼Œä½†æ˜¯è™šå‡½æ•°çš„é»˜è®¤å®å‚<strong>ç”±æœ¬æ¬¡è°ƒç”¨çš„é™æ€ç±»å‹å†³å®š</strong>ã€‚æ‰€ä»¥ï¼Œè™šå‡½æ•°çš„é»˜è®¤å®å‚åœ¨åŸºç±»å’Œæ´¾ç”Ÿç±»ä¸­æœ€å¥½ä¸€è‡´ã€‚</p>
</blockquote>

<h5 id="final--override">final &amp; override</h5>

<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">final</code>é˜»æ­¢ä¸€ä¸ªç±»è¢«ç»§æ‰¿ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">A</span> <span class="k">final</span> <span class="p">{</span><span class="cm">/* */</span><span class="p">}</span>
</code></pre></div></div>

<p>è¿˜å¯ä»¥ä½¿ç”¨å®ƒæ¥é˜»æ­¢ä¸€ä¸ªå‡½æ•°è¢«åç»­è¦†ç›–ï¼ˆæ”¾åœ¨å‡½æ•°å£°æ˜æœ€åï¼Œå‡½æ•°ä½“ä¹‹å‰ï¼‰ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">foo</span><span class="p">()</span> <span class="k">const</span> <span class="k">final</span><span class="p">;</span>
</code></pre></div></div>

<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å…³é”®å­—<code class="language-plaintext highlighter-rouge">override</code>è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ´¾ç”Ÿç±»ä¸­çš„è™šå‡½æ•°ï¼Œæ¥æ–¹ä¾¿ç¼–è¯‘å™¨æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦ç»™é”™äº†å‚æ•°åˆ—è¡¨ï¼ˆæ‰¾ä¸åˆ°å¯¹åº”çš„åŸºç±»ä¸­çš„å‡½æ•°ï¼‰ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">foo</span><span class="p">()</span> <span class="k">const</span> <span class="k">override</span><span class="p">;</span>
</code></pre></div></div>

<h5 id="accessible">Accessibleï¼Ÿ</h5>

<p>é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“ï¼Œåœ¨ä½¿ç”¨äº†ç»§æ‰¿ä¹‹åï¼Œä¸€ä¸ªç±»å¯ä»¥æœ‰ä¸‰ç§ä¸åŒçš„ç”¨æˆ·ï¼š</p>

<ul>
  <li>æ™®é€šç”¨æˆ·</li>
  <li>ç±»çš„å®ç°è€…</li>
  <li>æ´¾ç”Ÿç±»</li>
</ul>

<p>æ´¾ç”Ÿç±»å¯ä»¥è®¿é—®åŸºç±»çš„<code class="language-plaintext highlighter-rouge">protected</code>æˆå‘˜ï¼Œä½†æ˜¯æ™®é€šç”¨æˆ·ä¸è¡Œã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ´¾ç”Ÿç±»çš„æˆå‘˜ä»¥åŠå‹å…ƒåªèƒ½é€šè¿‡æ´¾ç”Ÿç±»å¯¹è±¡è®¿é—®åŸºç±»çš„å—ä¿æŠ¤æˆå‘˜ï¼Œå³<strong>ä»–ä»¬åªèƒ½è®¿é—®æ´¾ç”Ÿç±»å¯¹è±¡ä¸­çš„åŸºç±»éƒ¨åˆ†çš„å—ä¿æŠ¤æˆå‘˜ï¼Œå¯¹åŸºç±»ä¸­çš„å—ä¿æŠ¤æˆå‘˜æ²¡æœ‰è®¿é—®ç‰¹æƒï¼š</strong> å‚è§<em>C++ Primer</em> P543.</p>

<p>åœ¨ç¨‹åºä¸­ï¼Œå­˜åœ¨ä¸¤ä¸ªè®¿é—®è¯´æ˜ç¬¦ï¼Œåˆ†åˆ«ä½äºç±»çš„å®ç°ä¸­ä»¥åŠç»§æ‰¿çš„æ¥å£å¤„ã€‚å…¶ä¸­ï¼Œ<strong>æ´¾ç”Ÿç±»çš„æˆå‘˜ä»¥åŠå‹å…ƒèƒ½å¦è®¿é—®åŸºç±»çš„æˆå‘˜åªä¸åŸºç±»ä¸­çš„è®¿é—®è¯´æ˜ç¬¦æœ‰å…³ã€‚</strong> è€Œä½äºç»§æ‰¿æ¥å£å¤„çš„è®¿é—®è¯´æ˜ç¬¦å¯ä»¥æ§åˆ¶æ™®é€šç”¨æˆ·ï¼Œå³<strong>æ´¾ç”Ÿç±»ç”¨æˆ·</strong>çš„è®¿é—®æƒé™ï¼šä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨<em>CS 106X</em>ä¸­æ‰€æåˆ°çš„ï¼šç»§æ‰¿å…³ç³»åœ¨<strong>ç±»å¤–éƒ¨</strong>æ˜¯å¦å¯è§â€”-å¦‚æœæ­¤æ—¶æˆ‘ä»¬ä½¿ç”¨äº†<strong>épublic</strong>è®¿é—®è¯´æ˜ç¬¦ï¼Œé‚£ä¹ˆæ´¾ç”Ÿç±»ç”¨æˆ·æ— æ³•è·å–åŸºç±»å†…å®¹ã€‚</p>

<blockquote>
  <p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬å°†<strong>ç»§æ‰¿è‡ªæ´¾ç”Ÿç±»çš„æ–°ç±»ï¼Œä¹Ÿè§†ä¸ºä¸€ç§æ™®é€šç”¨æˆ·</strong>ï¼ˆå³åŸºç±»çš„æ™®é€šç”¨æˆ·ï¼‰ã€‚</p>
</blockquote>

<blockquote>
  <p>åŒæ—¶ï¼Œå¦‚æœæˆ‘ä»¬æ˜¯ä»¥<code class="language-plaintext highlighter-rouge">private</code>æˆ–è€…<code class="language-plaintext highlighter-rouge">protected</code>çš„æ–¹å¼ç»§æ‰¿çš„åŸºç±»ï¼Œåˆ™<strong>ç”¨æˆ·ä»£ç </strong>ä¸èƒ½ä½¿ç”¨æ´¾ç”Ÿç±»åˆ°åŸºç±»çš„è½¬æ¢ã€‚è¿™æ­£æ˜¯å› ä¸ºæ´¾ç”Ÿç±»ç”¨æˆ·æ— æ³•è®¿é—®çš„ç¼˜æ•…ã€‚åªæ˜¯åœ¨è¿™é‡Œï¼Œ<strong>ç”¨æˆ·ä»£ç </strong>ä¸<strong>æ´¾ç”Ÿç±»çš„æ´¾ç”Ÿç±»</strong>æœ‰äº†å¾…é‡çš„å·®åˆ«ï¼Œæˆ‘ä»¬ä½¿ç”¨<strong>å…¬æœ‰æˆ–è€…å—ä¿æŠ¤</strong>æ–¹å¼ç»§æ‰¿åŸºç±»æ—¶ï¼Œ<strong>æ´¾ç”Ÿç±»çš„æ´¾ç”Ÿç±»æˆå‘˜å’Œå‹å…ƒ</strong>å¯ä»¥è®¿é—®æ´¾ç”Ÿç±»åˆ°åŸºç±»çš„è½¬æ¢ï¼Œåªæœ‰ä½¿ç”¨<strong>ç§æœ‰</strong>æ–¹å¼ç»§æ‰¿æ—¶ä¸å¯ä»¥ä½¿ç”¨è¯¥è½¬æ¢ã€‚</p>
</blockquote>

<h5 id="virtual-dtor">virtual dtor</h5>

<p>åŸºç±»é€šå¸¸åº”å½“å®šä¹‰ä¸€ä¸ªè™šææ„å‡½æ•°ï¼Œå¦‚æœæˆ‘ä»¬ä¸è¿™æ ·åšï¼Œåˆ™deleteä¸€ä¸ªæŒ‡å‘æ´¾ç”Ÿç±»å¯¹è±¡åŸºç±»æŒ‡é’ˆå°†äº§ç”Ÿä¸ºå®šä¹‰çš„è¡Œä¸ºã€‚Whyï¼Ÿè¿™æ­£æ˜¯å› ä¸º<strong>åŠ¨æ€ç»‘å®š</strong>æ‰€è‡´ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå› ä¸ºåŸºç±»å§‹ç»ˆéœ€è¦ä¸€ä¸ªè™šææ„å‡½æ•°ï¼Œä½†æ˜¯è¯¥ææ„å‡½æ•°å¯èƒ½ä¸ºç©ºï¼Œ<em>Rule Of Three</em>æ­¤æ—¶å¹¶ä¸é€‚ç”¨ã€‚ï¼ˆ<em>C++ Primer</em> P552ï¼‰</p>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ç»§æ‰¿å…³ç³»ä¸­çš„ææ„å‡½æ•°çš„è°ƒç”¨é¡ºåºä¸æ„é€ å‡½æ•°ç›¸åï¼š<strong>æ„é€ å‡½æ•°æ˜¯å…ˆè°ƒç”¨åŸºç±»æ„é€ å‡½æ•°ï¼Œå†è°ƒç”¨æ´¾ç”Ÿç±»æ„é€ å‡½æ•°ï¼›äºŒææ„å‡½æ•°æ˜¯å…ˆææ„æ´¾ç”Ÿç±»ï¼Œå†ææ„åŸºç±»ã€‚</strong></p>

<h5 id="dynamic-binding">Dynamic Binding</h5>

<p>ä»€ä¹ˆæ˜¯åŠ¨æ€ç»‘å®šï¼Ÿé€šä¿—åœ°è¯´ï¼Œå½“æˆ‘ä»¬åœ¨ç»§æ‰¿å…³ç³»ä¸­ï¼Œä½¿ç”¨ä¸€ä¸ª<strong>åŸºç±»çš„å¼•ç”¨æˆ–è€…æŒ‡é’ˆï¼Œè°ƒç”¨ä¸€ä¸ªè™šå‡½æ•°æ—¶ï¼Œå°†ä¼šå‘ç”ŸåŠ¨æ€ç»‘å®šã€‚</strong> ä¸ºä»€ä¹ˆå«åŠ¨æ€ç»‘å®šï¼Ÿå› ä¸ºåœ¨ç¼–è¯‘æ—¶ï¼Œç¨‹åºå¹¶ä¸æ¸…æ¥šåˆ°åº•æ˜¯éœ€è¦åŸºç±»çš„ç‰ˆæœ¬è¿˜æ˜¯éœ€è¦æ´¾ç”Ÿç±»çš„ç‰ˆæœ¬ï¼Œ<strong>åªæœ‰å½“è¿è¡Œæ—¶æ‰èƒ½å†³å®š</strong>ï¼Œ æ‰€ä»¥è¢«å«åšåŠ¨æ€ç»‘å®šã€‚ä»è€Œï¼Œä¸<code class="language-plaintext highlighter-rouge">Dynamic Binding</code>ç›¸å¯¹åº”çš„å°±æ˜¯<strong>é™æ€ç»‘å®š</strong>ï¼Œä¹Ÿå³åœ¨ç¼–è¯‘æ—¶å³å¯ç¡®å®šçš„ç»‘å®šå…³ç³»â€”-æˆå‘˜å‡½æ•°å¦‚æœæ²¡æœ‰è¢«å£°æ˜ä¸ºè™šå‡½æ•°ï¼Œåˆ™è§£æè¿‡ç¨‹å‘ç”Ÿåœ¨ç¼–è¯‘æ—¶ï¼Œå¦‚æœæˆ‘ä»¬å‚çœ‹é™æ€ç»‘å®šçš„æ±‡ç¼–ä»£ç ï¼Œä¼šå‘ç°ä»–åªæ˜¯ç®€å•çš„<em>call+address</em>çš„å½¢å¼ã€‚æ ¹æ®<em>C++ Primer</em>ï¼š</p>

<blockquote>
  <p>è¡¨è¾¾å¼çš„<strong>é™æ€ç±»å‹</strong>åœ¨ç¼–è¯‘æ—¶å·²çŸ¥ï¼Œå®ƒæ˜¯å˜é‡å£°æ˜æ—¶çš„ç±»å‹æˆ–è€…è¡¨è¾¾å¼ç”Ÿæˆçš„ç±»å‹ï¼›è€Œ<strong>åŠ¨æ€ç±»å‹</strong>åˆ™æ˜¯<strong>å˜é‡æˆ–è¡¨è¾¾å¼è¡¨ç¤ºçš„å†…å­˜ä¸­çš„å¯¹è±¡ç±»å‹</strong>ã€‚åŸºç±»çš„æŒ‡é’ˆæˆ–è€…å¼•ç”¨çš„é™æ€ç±»å‹ä¸åŠ¨æ€ç±»å‹å¯èƒ½ä¸ä¸€æ ·ã€‚</p>
</blockquote>

<p>æˆ‘ä»¬é€šè¿‡ä¸¤ä¸ªä¾‹å­ä½“ä¼šä¸Šé¢çš„å†…å®¹ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ptr is a reference here</span>
<span class="kt">double</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">.</span><span class="n">net_price</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
</code></pre></div></div>

<p>åœ¨è¿™é‡Œï¼Œå› ä¸º<code class="language-plaintext highlighter-rouge">ptr</code>æ˜¯ä¸€ä¸ªåŸºç±»çš„æŒ‡é’ˆï¼Œæ‰€ä»¥å®ƒå¯èƒ½å­˜åœ¨é™æ€ç±»å‹ä¸åŠ¨æ€ç±»å‹ä¸åŒçš„æƒ…å†µã€‚åŒæ ·åœ°ï¼Œå€Ÿç”±æ­¤è§„å®šï¼Œæˆ‘ä»¬ç†è§£äº†ä¸ºä»€ä¹ˆåœ¨<em>CS 106X</em>ä¸­å­˜åœ¨å¦‚ä¸‹çš„æƒ…å†µï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202110312240802.png" alt="IMG_0220" style="zoom:50%" /></p>

<p>æŒ‡é’ˆ<code class="language-plaintext highlighter-rouge">var1</code>çš„é™æ€ç±»å‹ä¸º<code class="language-plaintext highlighter-rouge">Snow</code>ï¼Œä½†æ˜¯åŠ¨æ€ç±»å‹ä¸º<code class="language-plaintext highlighter-rouge">Sleet</code>ï¼ˆå†…å­˜ä¸­çš„å¯¹è±¡ç±»å‹ï¼‰ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¯¹äºè¡¨è¾¾å¼<code class="language-plaintext highlighter-rouge">var1-&gt;method2</code>ï¼Œç¼–è¯‘æ—¶æ£€æŸ¥<code class="language-plaintext highlighter-rouge">Snow</code>ä¸­æ˜¯å¦æœ‰<code class="language-plaintext highlighter-rouge">method2</code>ï¼Œè¿è¡Œæ—¶æ£€æŸ¥<code class="language-plaintext highlighter-rouge">Sleet</code>ä¸­æ˜¯å¦æœ‰<code class="language-plaintext highlighter-rouge">method2</code>çš„åŸå› ã€‚</p>

<blockquote>
  <p>å¯¹äºå¯¹è±¡ï¼ˆå³éå¼•ç”¨æˆ–è€…æŒ‡é’ˆï¼‰æ¥è¯´ï¼Œæ˜¯ä¸å­˜åœ¨ä»€ä¹ˆç±»å‹è½¬æ¢ä¸åŠ¨æ€ç±»å‹çš„ã€‚</p>
</blockquote>

<p>åŒç†ï¼Œæˆ‘ä»¬å¯ä»¥ä½“ä¼šåˆ°è¿™å¥è¯çš„ç†ç”±ï¼š</p>

<blockquote>
  <p>å¯¹äº<code class="language-plaintext highlighter-rouge">virtual</code>å…³é”®å­—ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ï¼šå¦‚æœæƒ³ç»§æ‰¿æŸä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä¸åŠ è¯¥å…³é”®å­—ï¼Œç¨‹åºå¯ä»¥æ­£å¸¸ç¼–è¯‘ï¼Œæ–°çš„ç»§æ‰¿å‡½æ•°ä¹Ÿå¯ä»¥ç¼–è¯‘é€šè¿‡ï¼Œä½†è¿™ä¼šå¯¼è‡´ç¨‹åºåœ¨è¿è¡Œæ—¶ä¸çŸ¥é“å»è°ƒç”¨æ–°çš„ç»§æ‰¿å‡½æ•°ï¼ˆç¼ºå°‘äº†<strong>åŠ¨æ€ç»‘å®š</strong>çš„è¿‡ç¨‹ï¼‰ã€‚</p>
</blockquote>

<p>å…³äºç±»å‹è½¬æ¢ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ³¨æ„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ´¾ç”Ÿç±»å¯¹è±¡ä¸ºä¸€ä¸ªåŸºç±»å¯¹è±¡æ„é€ æˆ–è€…èµ‹å€¼ï¼Œæ­¤æ—¶åªä¼šå¯¹æ´¾ç”Ÿç±»å¯¹è±¡ä¸­çš„åŸºç±»éƒ¨åˆ†å¤„ç†ï¼Œå…¶ä½™éƒ¨åˆ†è¢«åˆ‡å‰²æ‰ï¼ˆ<code class="language-plaintext highlighter-rouge">sliced down</code>ï¼‰ã€‚</p>

<h5 id="vptr--vtbl">vptr &amp; vtbl</h5>

<p>å€™æ·è€å¸ˆçš„è¿™å¼ å›¾å¾ˆæ¸…æ™°çš„è¯´æ˜äº†é—®é¢˜ï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/IMG_0219.PNG" alt="IMG_0219" style="zoom: 25%;" /></p>

<p>åªè¦æˆ‘ä»¬åœ¨ç±»ä¸­åŒ…å«äº†è™šå‡½æ•°ï¼Œåœ¨å“ªå­˜çš„å¯¹è±¡æ¨¡å‹ä¸­å°±ä¼šæœ‰ä¸”å§‹ç»ˆä»…æœ‰ä¸€ä¸ª<strong>è™šæŒ‡é’ˆ</strong>ï¼ˆ<code class="language-plaintext highlighter-rouge">virtual pointer</code>ï¼‰ï¼Œè€Œè§‚å¯Ÿè™šæŒ‡é’ˆæ‰€åœ¨çš„å†…å­˜å¯ä»¥çœ‹åˆ°ï¼Œ<strong>æ´¾ç”Ÿç±»ä¸­åŒ…å«æœ‰æ¯ä¸ªåŸºç±»çš„å­å¯¹è±¡ï¼Œä¹Ÿå³æ´¾ç”Ÿç±»ä¸­å«æœ‰åŸºç±»çš„éƒ¨åˆ†ï¼</strong>ã€‚ï¼ˆæ‰€ä»¥ï¼Œæ¯å½“å«æœ‰è™šå‡½æ•°æ—¶ï¼Œç±»å¯¹è±¡å®é™…å ç”¨çš„å†…å­˜å°±è¦æ¯”æ‰€æœ‰ç±»æˆå‘˜çš„å¤§å°å¤§<code class="language-plaintext highlighter-rouge">4</code>ï¼Œå› ä¸ºå¤šäº†ä¸€ä¸ªè™šæŒ‡é’ˆ.ï¼‰</p>

<p>è¿™ä¸ªè™šæŒ‡é’ˆæŒ‡å‘<strong>è™šè¡¨</strong>ï¼ˆ<code class="language-plaintext highlighter-rouge">virtual table</code>ï¼‰ï¼Œè™šè¡¨ä¸­å­˜æ”¾çš„æ˜¯æ‰€æœ‰æŒ‡å‘è¯¥ç±»å¯¹è±¡å†…éƒ¨è™šå‡½æ•°çš„æŒ‡é’ˆã€‚å½“æˆ‘ä»¬ä½¿ç”¨æŒ‡é’ˆ<code class="language-plaintext highlighter-rouge">p</code>å»è°ƒç”¨ç±»å¯¹è±¡æ—¶ï¼ŒåŠ¨æ€ç»‘å®šå†³å®šäº†<code class="language-plaintext highlighter-rouge">p</code>æŒ‡é’ˆæŒ‡å‘çš„ä½ç½®ï¼ˆæŒ‡å‘å“ªä¸€ä¸ªç±»å¯¹è±¡çš„å†…å­˜ä½ç½®ï¼‰ï¼Œé‚£è¿™ä¸ª<code class="language-plaintext highlighter-rouge">p</code>æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/IMG_0221.PNG" alt="IMG_0221" style="zoom: 25%;" /></p>

<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬é¦–å…ˆä½¿ç”¨ä¸€ä¸ªæ´¾ç”Ÿç±»å¯¹è±¡è°ƒç”¨åŸºç±»çš„æ–¹æ³•ï¼Œè€Œåœ¨è¯¥åŸºç±»æ–¹æ³•å†…ï¼Œå­˜åœ¨ä¸€ä¸ªè™šå‡½æ•°ï¼Œå› ä¸ºæŒ‡é’ˆ<code class="language-plaintext highlighter-rouge">p</code>å…¶å®å°±æ˜¯è°ƒç”¨æˆå‘˜å‡½æ•°çš„å¯¹è±¡çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„<code class="language-plaintext highlighter-rouge">this</code>æŒ‡é’ˆï¼Œèµ°åˆ°è™šå‡½æ•°çš„ä½ç½®åï¼Œç¨‹åºä¼šæ ¹æ®ä¼ å…¥çš„æŒ‡é’ˆçš„åœ°å€ï¼Œæ‰¾åˆ°æ´¾ç”Ÿç±»ï¼Œå¹¶æ‰§è¡Œå¯¹åº”çš„è™šå‡½æ•°ï¼Œè€Œè¿™ä¸€è¿‡ç¨‹åœ¨å†…éƒ¨å°±æ˜¯ç»ç”±<code class="language-plaintext highlighter-rouge">vptr</code>ä¸<code class="language-plaintext highlighter-rouge">vtbl</code>å®ç°çš„ï¼ä»è€Œï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†è¿™ä¸€è°ƒç”¨è¿‡ç¨‹ä½¿ç”¨Cè¯­è¨€è¡¨è¾¾å‡ºæ¥ï¼Œå³å¦‚å›¾æ‰€ç¤ºçš„å½¢å¼ï¼Œé¦–å…ˆä»è™šæŒ‡é’ˆå®šä½è™šè¡¨ï¼Œå†åˆ©ç”¨å½¢æˆçš„å‡½æ•°æŒ‡é’ˆè°ƒç”¨ä¼ å…¥çš„å¯¹è±¡ã€‚</p>

<h2 id="raii--smart-pointers">RAII &amp; Smart Pointers</h2>

<h3 id="raii">RAII</h3>

<p><code class="language-plaintext highlighter-rouge">RAII</code>æ˜¯<strong>C++</strong>çš„ä¸€ç§é‡è¦æœºåˆ¶ã€‚ä»€ä¹ˆæ˜¯<code class="language-plaintext highlighter-rouge">RAII</code>ï¼Ÿä¸­æ–‡ç¿»è¯‘ä¸ºèµ„æºè·å–å³åˆå§‹åŒ–â€“ä½¿ç”¨å±€éƒ¨å¯¹è±¡æ¥ç®¡ç†èµ„æºçš„æŠ€æœ¯ã€‚ä»–è¿˜æœ‰å‡ ä¸ªåå­—ï¼Œæ¯”å¦‚<strong>SBRM</strong>ï¼ˆ<code class="language-plaintext highlighter-rouge">Scope Based Resource Management</code>ï¼‰ï¼Œ<strong>CADRE</strong>ï¼ˆ<code class="language-plaintext highlighter-rouge">Constructor Acquires, Destructor Releases</code>ï¼‰ã€‚è¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿæ ¹æ®ä¸‹å›¾æ‰€ç¤ºçš„ä¾‹å­ï¼š</p>

<p><img src="/home/shaopu/.config/Typora/typora-user-images/image-20211126162823928.png" alt="image-20211126162823928" style="zoom:50%;" /></p>

<p>å¦‚æœæˆ‘ä»¬åˆ©ç”¨ä¸¤æ¡å•ç‹¬çš„è¯­å¥åˆ†é…å†…å­˜å’Œé‡Šæ”¾å†…å­˜ï¼Œå¦‚æœä»£ç ä¸­é—´å‡ºç°äº†å¼‚å¸¸ï¼Œé‚£ä¹ˆå†…å­˜æ— æ³•è¢«åˆç†é‡Šæ”¾ï¼Œä¾¿ä¼šäº§ç”Ÿå†…å­˜æ³„æ¼ã€‚ä½†å¦‚æœæˆ‘ä»¬åˆ©ç”¨ä¸€ä¸ªå±€éƒ¨å¯¹è±¡æ¥ç®¡ç†å’Œåˆ†é…å†…å­˜ï¼Œé‚£ä¹ˆå½“å±€éƒ¨å¯¹è±¡<code class="language-plaintext highlighter-rouge">out of scope</code>æ—¶ï¼Œä¾¿ä¼šè‡ªåŠ¨è°ƒç”¨ä»–çš„ææ„å‡½æ•°æ¥é‡Šæ”¾å†…å­˜ï¼Œè¿›è€Œé¿å…äº†å†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚</p>

<p>ä»è€Œï¼Œå€ŸåŠ©äº<strong>RAII</strong>æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥å°†åˆ†é…å†…å­˜çš„ä»»åŠ¡äº¤ç»™æ„é€ å‡½æ•°ï¼Œé‡Šæ”¾å†…å­˜çš„ä»»åŠ¡äº¤ç»™ææ„å‡½æ•°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼š</p>

<blockquote>
  <p>There should never be a â€half-validâ€ state of the object. Object immediately useable after its creation.</p>

  <p>The destructor is always called (even with exceptions), so the resource is always freed.</p>
</blockquote>

<p><strong>RAII</strong>æœºåˆ¶åœ¨å¤šå¤„éƒ½æœ‰ä½“ç°ï¼ŒåŒ…æ‹¬æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„<code class="language-plaintext highlighter-rouge">new</code>ä¸<code class="language-plaintext highlighter-rouge">delete</code>è¿‡ç¨‹ï¼Œä»¥åŠï¼š</p>

<ul>
  <li>æ–‡ä»¶çš„æ‰“å¼€ä¸å…³é—­-<strong>C++</strong>å†…éƒ¨ä¸ºæˆ‘ä»¬æä¾›äº†å…·å¤‡<strong>RAII</strong>æœºåˆ¶çš„æ–‡ä»¶å¤„ç†æ“ä½œï¼š</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// DO NOT WRITE IN THIS WAY:</span>
<span class="p">{</span>
    <span class="n">ifstream</span> <span class="n">input</span><span class="p">();</span>
    <span class="n">input</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="s">"test.txt"</span><span class="p">);</span>
    <span class="c1">// do something</span>
    <span class="n">input</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// with RAII provided</span>
<span class="p">{</span>
    <span class="n">ifstream</span> <span class="n">input</span><span class="p">(</span><span class="s">"test.txt"</span><span class="p">);</span>
    <span class="c1">// do something</span>
    <span class="c1">// no need to close the file anymore!</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>multithreading</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// NO NO NO</span>
<span class="kt">void</span> <span class="nf">cleanDatabase</span> <span class="p">(</span><span class="n">mutex</span><span class="o">&amp;</span> <span class="n">databaseLock</span><span class="p">,</span> <span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">database</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">databaseLock</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
    <span class="c1">// other threads will not modify database</span>
    <span class="c1">// modify the database</span>
    <span class="c1">// if exception thrown, mutex never unlocked!</span>
    <span class="n">databaseLock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// use RAII-"lock_guard" instead</span>
<span class="kt">void</span> <span class="nf">cleanDatabase</span> <span class="p">(</span><span class="n">mutex</span><span class="o">&amp;</span> <span class="n">databaseLock</span><span class="p">,</span> <span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;&amp;</span> <span class="n">database</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">mutex</span><span class="o">&gt;</span><span class="p">(</span><span class="n">databaseLock</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">class</span> <span class="nc">lock_guard</span> <span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">lock_guard</span><span class="p">(</span><span class="n">mutex</span><span class="o">&amp;</span> <span class="n">lock</span><span class="p">)</span> <span class="o">:</span> <span class="n">acquired_lock</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">acquired_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="o">~</span><span class="n">lock_guard</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">acquired_lock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
    <span class="p">}</span>
<span class="nl">private:</span>
    <span class="n">mutex</span><span class="o">&amp;</span> <span class="n">acquired_lock</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æ­£æ˜¯åŸºäº<strong>RAII</strong>çš„è¿™ç§æƒ³æ³•ï¼Œ<strong>C++</strong>å¼•å…¥äº†æ™ºèƒ½æŒ‡é’ˆï¼ˆ<code class="language-plaintext highlighter-rouge">Smart Pointers</code>ï¼‰.åœ¨ä»‹ç»æ™ºèƒ½æŒ‡é’ˆä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹<code class="language-plaintext highlighter-rouge">new</code>ä¸<code class="language-plaintext highlighter-rouge">delete</code>å…³é”®å­—æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p>

<h3 id="new--delete">new &amp; delete</h3>

<p>å½“æˆ‘ä»¬å†™å‡ºå¦‚ä¸‹çš„ä»£ç æ—¶ï¼Œç¨‹åºå®é™…ä¸Šåœ¨åšä»€ä¹ˆï¼Ÿ</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Complex</span><span class="o">*</span> <span class="n">pc</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Complex</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="n">String</span><span class="o">*</span> <span class="n">str</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">String</span><span class="p">(</span><span class="s">"Hello"</span><span class="p">);</span>
</code></pre></div></div>

<h4 id="new">new</h4>

<p><strong>å…ˆåˆ†é…å†…å­˜ï¼Œå†è°ƒç”¨æ„é€ å‡½æ•°</strong>ï¼š</p>

<ul>
  <li><strong>åˆ†é…å†…å­˜</strong>-&gt;ä½¿ç”¨<code class="language-plaintext highlighter-rouge">operator new</code>çš„å†…ç½®å‡½æ•°</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">String</span><span class="o">*</span> <span class="n">str</span><span class="p">;</span>
<span class="kt">void</span><span class="o">*</span> <span class="n">mem</span> <span class="o">=</span> <span class="k">operator</span> <span class="nf">new</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">String</span><span class="p">));</span>
</code></pre></div></div>

<p>åœ¨è¿™ä¸€æ­¥ï¼Œå‡½æ•°<code class="language-plaintext highlighter-rouge">operator new</code>ä¸­ä¼šè°ƒç”¨<code class="language-plaintext highlighter-rouge">malloc()</code>ä»¥åˆ†é…å†…å­˜ã€‚</p>

<ul>
  <li><strong>è½¬å‹</strong>-&gt;ä½¿ç”¨<code class="language-plaintext highlighter-rouge">static_cast</code></li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">str</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">String</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li><strong>ä½¿ç”¨æ„é€ å‡½æ•°</strong></li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">str</span><span class="o">-&gt;</span><span class="n">String</span><span class="o">::</span><span class="n">String</span><span class="p">(</span><span class="s">"Hello"</span><span class="p">);</span>
</code></pre></div></div>

<p>è¿™é‡Œæ˜ç¡®ä¸¤ä¸ªç‚¹ï¼š</p>

<ol>
  <li>åˆ†é…å†…å­˜ï¼Œåˆ†é…çš„æ˜¯è°çš„å†…å­˜ï¼Ÿéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸€æ­¥åˆ†é…çš„å¹¶ä¸æ˜¯æˆ‘ä»¬ä¼ å…¥çš„<code class="language-plaintext highlighter-rouge">Hello</code>å­—ç¬¦ä¸²çš„å†…å­˜ï¼Œè€Œæ˜¯ç±»ï¼Œä¹Ÿå°±æ˜¯<strong>å¯¹è±¡</strong>æœ¬èº«çš„å†…å­˜ã€‚</li>
  <li>ä½¿ç”¨æ„é€ å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿä¼šåˆ†é…å†…å­˜ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åˆ†é…çš„æ˜¯æ‰€ä¼ å…¥çš„å¯¹è±¡ï¼Œå³Cå¼å­—ç¬¦ä¸²çš„å†…å­˜</li>
</ol>

<p>æ‰€ä»¥æœ€ç»ˆï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°è¿™æ ·çš„å†…å­˜åˆ†å¸ƒï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111211913964.png" alt="image-20211121191351876" style="zoom:50%;" /></p>

<p><code class="language-plaintext highlighter-rouge">ps</code>æ˜¯æŒ‡å‘ç±»å¯¹è±¡çš„æŒ‡é’ˆï¼Œè€Œæ¯ä¸ªç±»å¯¹è±¡ä¸­æœ‰ä¸€ä¸ªç§æœ‰æˆå‘˜æŒ‡é’ˆç”¨æ¥è¡¨ç¤ºä¼ å…¥çš„å­—ç¬¦ä¸²ï¼ˆä¸€ä¸ª<code class="language-plaintext highlighter-rouge">char</code>æ•°ç»„ï¼‰çš„å¤´æŒ‡é’ˆï¼ŒæŒ‡å‘å¦ä¸€å—å†…å­˜ç©ºé—´ã€‚</p>

<p>å½“ç„¶ï¼Œç”±äºæ„é€ å‡½æ•°çš„è¡Œä¸ºæ˜¯ç”±æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ï¼Œå¦‚æœæˆ‘ä»¬è®¾è®¡çš„æ˜¯<code class="language-plaintext highlighter-rouge">Complex</code>å¯¹è±¡ï¼Œæƒ…å†µæœ‰æ‰€ä¸åŒï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Complex</span><span class="o">*</span> <span class="n">pc</span><span class="p">;</span>
<span class="n">pc</span><span class="o">-&gt;</span><span class="n">Complex</span><span class="o">::</span><span class="n">Complex</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</code></pre></div></div>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111211921334.png" alt="image-20211121192101241" style="zoom:50%;" /></p>

<p>å¦‚æœæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªæ‹¬å·åŒ…å›´çš„åˆå§‹åŒ–å™¨ï¼Œå°±å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">auto</code>ï¼Œä½†ä»…å½“æ‹¬å·ä¸­æœ‰å•ä¸€åˆå§‹åŒ–å™¨æ—¶æ‰å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">auto</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span> <span class="c1">// OK</span>
<span class="k">auto</span> <span class="n">p2</span> <span class="o">=</span> <span class="k">new</span> <span class="k">auto</span><span class="p">{</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="p">,</span><span class="n">c</span><span class="p">};</span> <span class="c1">// error</span>
</code></pre></div></div>

<p>æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">new</code>åˆ†é…ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">const</code>å¯¹è±¡ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">pc1</span> <span class="o">=</span> <span class="k">new</span> <span class="k">const</span> <span class="nf">int</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
</code></pre></div></div>

<h4 id="delete">delete</h4>

<blockquote>
  <p>Calling a destructor releases the resources owned by the object, but it does not release the memory allocated to the object itself.</p>
</blockquote>

<p>å¯ä»¥é¢„æƒ³åˆ°ï¼Œ<code class="language-plaintext highlighter-rouge">delete</code>éœ€è¦å…·å¤‡ä¸<code class="language-plaintext highlighter-rouge">new</code>ç›¸åçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œæ‰€ä»¥æˆ‘ä»¬<strong>é¦–å…ˆè¦è°ƒç”¨ææ„å‡½æ•°ï¼Œå†é‡Šæ”¾å¯¹è±¡å†…å­˜</strong>ã€‚</p>

<blockquote>
  <p>è°ƒç”¨ææ„å‡½æ•°æ—¶ï¼Œå‡½æ•°çš„è¡Œä¸ºä¹Ÿæ˜¯ç”±æˆ‘ä»¬å®šä¹‰çš„ï¼Œä»–å¯èƒ½ä¼šé‡Šæ”¾ä¹‹å‰åœ¨ä½¿ç”¨<code class="language-plaintext highlighter-rouge">new</code>æ—¶ä¸ºç±»æˆå‘˜åˆ†é…çš„å†…å­˜ï¼Œå½“ç„¶ï¼Œä¹Ÿæœ‰å¯èƒ½å•¥éƒ½ä¸éœ€è¦å®ƒå¹².</p>
</blockquote>

<p>æ¯”å¦‚å¯¹äºå…ˆå‰çš„<code class="language-plaintext highlighter-rouge">String</code>å¯¹è±¡ï¼š</p>

<ul>
  <li><strong>è°ƒç”¨ææ„å‡½æ•°</strong></li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">String</span><span class="o">::~</span><span class="n">String</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
</code></pre></div></div>

<p>è€Œåœ¨ææ„å‡½æ•°å†…éƒ¨ï¼Œæˆ‘ä»¬å®šä¹‰äº†å¦‚ä½•é‡Šæ”¾ç»™å…¥çš„å­—ç¬¦ä¸²ï¼ˆ<code class="language-plaintext highlighter-rouge">char</code>æ•°ç»„ï¼‰çš„å†…å­˜ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">~</span><span class="n">String</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="p">[]</span> <span class="n">m_data</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><strong>é‡Šæ”¾å¯¹è±¡å†…å­˜-&gt;ä½¿ç”¨å†…ç½®çš„<code class="language-plaintext highlighter-rouge">operator delete</code>å‡½æ•°</strong></li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">operator</span> <span class="nf">delete</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>
</code></pre></div></div>

<p>åœ¨è¿™ä¸€æ­¥ï¼Œå‡½æ•°<code class="language-plaintext highlighter-rouge">operator delete</code>å†…éƒ¨ä¼šä½¿ç”¨<code class="language-plaintext highlighter-rouge">free(str)</code>é‡Šæ”¾å¯¹è±¡å†…å­˜ã€‚</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111212016675.png" alt="image-20211121201615585" style="zoom:50%;" /></p>

<p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç¨‹åºä¼šé¦–å…ˆè°ƒç”¨ææ„å‡½æ•°é‡Šæ”¾æ‰<code class="language-plaintext highlighter-rouge">Hello</code>çš„å†…å­˜å—ï¼Œä¹‹åä½¿ç”¨<code class="language-plaintext highlighter-rouge">operator delete</code>ä¹Ÿå³<code class="language-plaintext highlighter-rouge">free(str)</code>é‡Šæ”¾æŒ‡é’ˆ<code class="language-plaintext highlighter-rouge">ps</code>æŒ‡å‘çš„ï¼Œä¹Ÿå³æˆ‘ä»¬ä½¿ç”¨<code class="language-plaintext highlighter-rouge">new</code>æ—¶<code class="language-plaintext highlighter-rouge">malloc</code>ç»™å¯¹è±¡åˆ†é…çš„å†…å­˜å—ã€‚æˆ‘ä»¬å‘ç°è¿™é‡Œçš„æ‰§è¡Œè¿‡ç¨‹ç¡®ç¡®å®å®æ˜¯å’Œ<code class="language-plaintext highlighter-rouge">new</code>æ—¶åè¿‡æ¥çš„ã€‚</p>

<blockquote>
  <p>å¦‚ä¸Šæ‰€è¿°ï¼Œç¨‹åºä¹Ÿæœ‰å¯èƒ½åœ¨è°ƒç”¨ææ„å‡½æ•°æ—¶å•¥ä¹Ÿä¸åšï¼Œæ¯”å¦‚å½“æˆ‘ä»¬é¢å¯¹<code class="language-plaintext highlighter-rouge">Complex</code>å¯¹è±¡ï¼š</p>

  <p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111212020355.png" alt="image-20211121202015271" style="zoom:50%;" /></p>

  <p>å› ä¸ºæˆ‘ä»¬æ²¡æœ‰åœ¨ç±»å†…åŠ¨æ€åˆ†é…å†…å­˜ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ä½¿ç”¨<code class="language-plaintext highlighter-rouge">operator delete</code>é‡Šæ”¾å¯¹è±¡å†…å­˜ï¼Œå³<code class="language-plaintext highlighter-rouge">pc</code>æŒ‡å‘çš„å†…å­˜å—å³å¯ã€‚</p>
</blockquote>

<h4 id="array-new--array-delete">array new &amp; array delete?</h4>

<p>ä¸ºä»€ä¹ˆæˆ‘ä»¬è¯´<code class="language-plaintext highlighter-rouge">array new</code>ä¸€å®šè¦æ­é…<code class="language-plaintext highlighter-rouge">array delete</code>ï¼Ÿé¦–å…ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹åŠ¨æ€åˆ†é…æ‰€å¾—çš„å†…å­˜ï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111212102856.png" alt="image-20211121210236744" style="zoom:50%;" /></p>

<p>åœ¨ä½¿ç”¨<code class="language-plaintext highlighter-rouge">new</code>è¿›è¡Œå†…å­˜åˆ†é…æ—¶ï¼Œæˆ‘ä»¬è§‚å¯Ÿåˆ°é™¤äº†åˆ†é…ç»™å¯¹è±¡çš„å†…å­˜å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦<code class="language-plaintext highlighter-rouge">Debugger Header</code>(åœ¨è°ƒè¯•æ¨¡å¼ä¸‹)ï¼Œ<code class="language-plaintext highlighter-rouge">cookie</code>ï¼ˆç”¨æ¥è¡¨ç¤ºæ€»å…±åˆ†é…ç»™ç”¨æˆ·çš„å†…å­˜å—å¤§å°ï¼Œå¹¶ä½¿ç”¨æœ€åä¸€ä¸ª<code class="language-plaintext highlighter-rouge">byte</code>è®°å½•ç¨‹åºæ˜¯åœ¨è·å¾—å†…å­˜è¿˜æ˜¯é‡Šæ”¾å†…å­˜ï¼‰ï¼Œç”¨äº<strong><a href="https://zhuanlan.zhihu.com/p/30007037">å†…å­˜å¯¹é½</a></strong>ï¼ˆåœ¨<em>VC</em>ä¸­è¦æ±‚æ•´å—ä¸º16çš„å€æ•°ï¼‰çš„<code class="language-plaintext highlighter-rouge">pad</code>ï¼Œè¿˜æœ‰è®°å½•å‚¨å­˜çš„<code class="language-plaintext highlighter-rouge">object</code>æ•°é‡çš„ä¸€ä¸ªæ•´æ•°ã€‚</p>

<p>é‚£ä¹ˆä¸ºä»€ä¹ˆè¿™ç§æƒ…å†µä¸‹å°±è¦ä½¿ç”¨å¯¹åº”çš„<code class="language-plaintext highlighter-rouge">array delete</code>å‘¢ï¼Ÿå› ä¸ºå¦‚æœæˆ‘ä»¬å†™ä½œ<code class="language-plaintext highlighter-rouge">delete p</code>ï¼Œé‚£ä¹ˆåœ¨<code class="language-plaintext highlighter-rouge">delete</code>çš„å®é™…æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œææ„å‡½æ•°åªèƒ½è¢«å”¤èµ·ä¸€æ¬¡ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬<strong>æ— æ³•å®Œå…¨é‡Šæ”¾ä¹‹å‰åœ¨ç±»å†…ä¸ºæ•°æ®åˆ†é…çš„å†…å­˜ï¼Œè¿›è€Œå‘ç”Ÿå†…å­˜æ³„æ¼</strong>ã€‚è€Œä½¿ç”¨<code class="language-plaintext highlighter-rouge">delete[] p</code>ï¼Œåˆ™å¯ä»¥åˆ©ç”¨å†…å­˜å—å†…å­˜å‚¨çš„<code class="language-plaintext highlighter-rouge">object</code>æ•°é‡çš„æ•°æ®ï¼Œå®Œæ•´çš„é‡Šæ”¾å†…å­˜ï¼š</p>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/202111212115390.png" alt="image-20211121211533286" style="zoom:50%;" /></p>

<h4 id="overload-operator-newoperator-delete">overload operator new/operator delete</h4>

<p><code class="language-plaintext highlighter-rouge">new</code>ä¸<code class="language-plaintext highlighter-rouge">delete</code>æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè¡Œä¸ºæ— æ³•é‡è½½ï¼Œä½†å…¶ä¸­è°ƒç”¨çš„<code class="language-plaintext highlighter-rouge">operator new(operator new[])</code>ä¸<code class="language-plaintext highlighter-rouge">operator delete(operator delete[])</code>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥è¢«é‡è½½ã€‚</p>

<p>è¿™ä¸¤ä¸ªå‡½æ•°çš„é‡è½½å¯ä»¥ä½œä¸ºå…¨å±€é‡è½½ï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨<code class="language-plaintext highlighter-rouge">class</code>å†…éƒ¨è¿›è¡Œé‡è½½ã€‚åœ¨<code class="language-plaintext highlighter-rouge">name lookup</code>é‚£ä¸€èŠ‚æˆ‘ä»¬æåˆ°è¿‡ï¼Œå¦‚æœ<code class="language-plaintext highlighter-rouge">::</code>å·¦ä¾§æ²¡æœ‰ä¸œè¥¿ï¼Œé‚£ä¹ˆé»˜è®¤åœ¨<code class="language-plaintext highlighter-rouge">globalscope</code>æˆ–è€…ç”±<code class="language-plaintext highlighter-rouge">using</code>å¼•å…¥çš„å‘½åç©ºé—´ä¸­å¯»æ‰¾åç§°ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©è¿™ä¸€ç‚¹æ¥å»åŒºåˆ†åˆ°åº•æ˜¯ä½¿ç”¨ç±»ä¸­çš„é‡è½½<code class="language-plaintext highlighter-rouge">operator new</code>è¿˜æ˜¯å…¨å±€çš„<code class="language-plaintext highlighter-rouge">operator new</code>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// look for members, if no member, use global one</span>
<span class="n">Foo</span><span class="o">*</span> <span class="n">pf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Foo</span><span class="p">;</span>
<span class="c1">// force to use the global one</span>
<span class="n">Foo</span><span class="o">*</span> <span class="n">pf</span> <span class="o">=</span> <span class="o">::</span><span class="k">new</span> <span class="n">Foo</span><span class="p">;</span>
<span class="c1">// delete åŒç†</span>
</code></pre></div></div>

<p><img src="https://shaopu-blog.oss-cn-beijing.aliyuncs.com/img/IMG_0238.PNG" alt="IMG_0238" style="zoom: 25%;" /></p>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå³ä½¿æˆ‘ä»¬åœ¨æ­¤æ—¶çš„æ„é€ å‡½æ•°ä¸­æŠ›å‡ºå¼‚å¸¸åæ²¡æœ‰è°ƒç”¨<code class="language-plaintext highlighter-rouge">operator delete</code>é‡Šæ”¾å†…å­˜ï¼Œç¨‹åºä¹Ÿä¸ä¼šå› æ­¤æŠ¥é”™ï¼Œå› ä¸ºè¿™è¡¨æ˜æˆ‘ä»¬æ”¾å¼ƒå¤„ç†ctoræŠ›å‡ºçš„å¼‚å¸¸ã€‚åœ¨æ ‡å‡†åº“çš„<code class="language-plaintext highlighter-rouge">basic_string</code>ä»£ç ä¸­ï¼Œå³é‡è½½äº†<code class="language-plaintext highlighter-rouge">operator new</code>ä¸<code class="language-plaintext highlighter-rouge">operator delete</code>ç”¨äºæ‰©å……<code class="language-plaintext highlighter-rouge">string</code>çš„å†…å­˜ç”³è¯·é‡.</p>

<h3 id="smart-pointers">Smart Pointers</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">shared_ptr</code></li>
  <li><code class="language-plaintext highlighter-rouge">unique_ptr</code></li>
  <li><code class="language-plaintext highlighter-rouge">weak_ptr</code></li>
</ul>

<p>è¿™ä¸‰ç§ç±»å‹éƒ½å®šä¹‰åœ¨<code class="language-plaintext highlighter-rouge">&lt;memory&gt;</code>å¤´æ–‡ä»¶ä¸­ã€‚</p>

<h4 id="shared_ptr">shared_ptr</h4>

<p>æˆ‘ä»¬å¯ä»¥æ£€æµ‹æ™ºèƒ½æŒ‡é’ˆæ˜¯å¦ä¸ºç©ºï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">p1</span> <span class="o">&amp;&amp;</span> <span class="n">p1</span><span class="o">-&gt;</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// do something</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æœ€å®‰å…¨çš„åˆ†é…å’Œä½¿ç”¨åŠ¨æ€å†…å­˜çš„æ–¹æ³•æ˜¯è°ƒç”¨<code class="language-plaintext highlighter-rouge">make_shared</code>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// we can use auto here</span>
<span class="k">auto</span> <span class="n">p</span> <span class="o">=</span> <span class="n">make_shared</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="sc">'9'</span><span class="p">);</span>
</code></pre></div></div>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè°ƒç”¨<code class="language-plaintext highlighter-rouge">make_shared</code>æ—¶ä¼ é€’çš„å‚æ•°å¿…é¡»ä¸ç±»å‹çš„æŸä¸ªæ„é€ å‡½æ•°ç›¸åŒ¹é….</p>

<h5 id="reference_counting">reference_counting</h5>

<p><code class="language-plaintext highlighter-rouge">shared_ptr</code>çš„ä¸€å¤§ç‰¹å¾æ˜¯å…è®¸å¤šä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼Œä¸ºäº†æ“ä½œè¿™ä¸€ç‰¹æ€§ï¼Œæ¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">shared_ptr</code>éƒ½æœ‰ä¸€ä¸ªå…³è”çš„è®¡æ•°å™¨ï¼Œå³<strong>å¼•ç”¨è®¡æ•°</strong>ï¼ˆ<code class="language-plaintext highlighter-rouge">reference counting</code>ï¼‰åŠŸèƒ½ã€‚å½“æˆ‘ä»¬è¿›è¡Œæ‹·è´æˆ–è€…èµ‹å€¼æ“ä½œæ—¶ï¼Œè®¡æ•°å™¨éƒ½ä¼šä½œç›¸åº”çš„å˜åŒ–ï¼š</p>

<ul>
  <li>åˆ›å»ºä¸€ä¸ª<code class="language-plaintext highlighter-rouge">shared_ptr</code>å¯¹è±¡ï¼Œè®¡æ•°å™¨ä¸º1ï¼›</li>
  <li>å°†å¯¹è±¡<code class="language-plaintext highlighter-rouge">q</code>èµ‹å€¼ç»™<code class="language-plaintext highlighter-rouge">p</code>ï¼ˆ<code class="language-plaintext highlighter-rouge">p=q</code>ï¼‰ï¼Œåˆ™ç›¸åº”åœ°ï¼Œ<code class="language-plaintext highlighter-rouge">p</code>çš„è®¡æ•°å™¨<code class="language-plaintext highlighter-rouge">-1</code>ï¼Œ<code class="language-plaintext highlighter-rouge">q</code>çš„è®¡æ•°å™¨<code class="language-plaintext highlighter-rouge">+1</code>ï¼›</li>
  <li>å½“æˆ‘ä»¬ä½¿ç”¨<code class="language-plaintext highlighter-rouge">q</code>åˆå§‹åŒ–<code class="language-plaintext highlighter-rouge">p</code>æ—¶ï¼ˆ<code class="language-plaintext highlighter-rouge">p(q)</code>ï¼‰ï¼Œ<code class="language-plaintext highlighter-rouge">q</code>çš„è®¡æ•°å™¨<code class="language-plaintext highlighter-rouge">+1</code>ï¼Œå¹¶ä¼ é€’ç»™<code class="language-plaintext highlighter-rouge">p</code>ï¼›</li>
  <li><strong>å½“æŒ‡å‘æŸå¯¹è±¡çš„ä»»æ„ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">shared_ptr</code>è®¡æ•°å™¨ä¸º0æ—¶ï¼Œé”€æ¯å¯¹è±¡</strong>ï¼›</li>
</ul>

<blockquote>
  <p>åŸºäºä»¥ä¸Šç‰¹æ€§ï¼Œåœ¨ä¿è¯<code class="language-plaintext highlighter-rouge">shared_ptr</code>æ— ç”¨ä¹‹åä¸å†ä¿ç•™å°±å¾ˆé‡è¦äº†ï¼Œå¦åˆ™ä¼šæµªè´¹å†…å­˜ï¼Œæ³¨æ„<strong>å¦‚æœå°†<code class="language-plaintext highlighter-rouge">shared_ptr</code>å­˜æ”¾åœ¨ä¸€ä¸ªå®¹å™¨ä¸­ï¼Œéšåé‡æ’äº†å®¹å™¨ï¼Œä»è€Œä¸å†éœ€è¦æŸäº›å…ƒç´ ï¼Œåˆ™åº”å½“ç”¨<code class="language-plaintext highlighter-rouge">erase</code>æ–¹æ³•åˆ é™¤é‚£äº›å…ƒç´ </strong></p>
</blockquote>

<h5 id="notice">NOTICE!</h5>

<ul>
  <li>æ¥å—æŒ‡é’ˆå‚æ•°çš„æ™ºèƒ½æŒ‡é’ˆæ„é€ å‡½æ•°æ˜¯<code class="language-plaintext highlighter-rouge">explicit</code>çš„ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä¸èƒ½å°†ä¸€ä¸ªå†…ç½®æŒ‡é’ˆå½¢å¼éšå¼è½¬åŒ–ä¸ºæ™ºèƒ½æŒ‡é’ˆï¼Œ<strong>å¿…é¡»ä½¿ç”¨ç›´æ¥åˆå§‹åŒ–</strong>ï¼š</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">int</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="c1">// error</span>
<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">p2</span><span class="p">(</span><span class="k">new</span> <span class="nf">int</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span> <span class="c1">// OK</span>

<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">clone</span><span class="p">(</span><span class="kt">int</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="kt">int</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="c1">// error</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><strong>ä¸è¦æ··åˆä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆå’Œæ™®é€šæŒ‡é’ˆ</strong></li>
</ul>

<p>å¦‚ä½•ç†è§£è¿™å¥è¯ï¼Ÿåœ¨<em>C++ Primer</em>ä¸­ç»™å‡ºäº†æ¸…æ™°çš„è§£é‡Šï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// a function</span>
<span class="kt">void</span> <span class="nf">process</span><span class="p">(</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// do something</span>
<span class="p">}</span> <span class="c1">// then the temp p will be destroied (go out of scope)</span>
</code></pre></div></div>

<p>æˆ‘ä»¬æ­£ç¡®çš„åšæ³•åº”å½“æ˜¯ä¼ é€’ä¸€ä¸ªéä¸´æ—¶å¯¹è±¡çš„<code class="language-plaintext highlighter-rouge">shared_ptr</code>ç»™è¯¥å‡½æ•°ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">ptr</span><span class="p">(</span><span class="k">new</span> <span class="nf">int</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
<span class="n">process</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
</code></pre></div></div>

<p>ä½†éœ€è¦æ³¨æ„ï¼Œæˆ‘ä»¬ä¸èƒ½ç»™è¯¥å‡½æ•°ä¼ é€’ä¸€ä¸ªæ™®é€šæŒ‡é’ˆï¼å› ä¸ºæ— æ³•éšå¼è½¬æ¢ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">int</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="n">process</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
</code></pre></div></div>

<p>å¹¶ä¸”ï¼Œæˆ‘ä»¬ä¸åº”è¯¥ç»™å‡½æ•°ä¼ å…¥ä¸€ä¸ªä¸´æ—¶å¯¹è±¡çš„<code class="language-plaintext highlighter-rouge">shared_ptr</code>ï¼Œè¿™æ ·åšä¼šå¯¼è‡´å‡½æ•°ç»“æŸåï¼Œå¯¹åº”çš„å†…å­˜è¢«é‡Šæ”¾ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">int</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="n">process</span><span class="p">(</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">ptr</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span> <span class="c1">// oop, x is a dangling pointer</span>
</code></pre></div></div>

<ul>
  <li><strong>ä¸è¦ä½¿ç”¨<code class="language-plaintext highlighter-rouge">get</code>åˆå§‹åŒ–å¦ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆæˆ–è€…ä¸ºæ™ºèƒ½æŒ‡é’ˆèµ‹å€¼</strong></li>
</ul>

<p>å› ä¸ºè¿™æ ·åšæˆ‘ä»¬<strong>ä¼šåˆ›å»ºä¸¤ä¸ªç‹¬ç«‹çš„æŒ‡å‘åŒä¸€å—å†…å­˜åŒºåŸŸçš„<code class="language-plaintext highlighter-rouge">shared_ptr</code></strong>:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">p</span><span class="p">(</span><span class="k">new</span> <span class="nf">int</span><span class="p">(</span><span class="mi">42</span><span class="p">));</span>
<span class="kt">int</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
<span class="c1">// undefined:</span>
<span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
</code></pre></div></div>

<p>åŒæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¿è¯è‡ªå·±ä¸ä¼šé‡Šæ”¾<code class="language-plaintext highlighter-rouge">q</code>æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ï¼Œå¦åˆ™åç»­æ— æ³•å†å¯¹åŸæœ¬çš„æ™ºèƒ½æŒ‡é’ˆæ“ä½œã€‚</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">reset</code></li>
</ul>

<p><code class="language-plaintext highlighter-rouge">reset</code>ä¼šæ›´æ–°è®¡æ•°å™¨ï¼Œå¦‚æœéœ€è¦ä¼šé‡Šæ”¾å¯¹è±¡ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">int</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span>
<span class="n">p</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="nf">int</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
</code></pre></div></div>

<h4 id="unique_ptr">unique_ptr</h4>

<p>ä¸<code class="language-plaintext highlighter-rouge">shared_ptr</code>æ‰€ä¸åŒçš„æ˜¯ï¼Œ<code class="language-plaintext highlighter-rouge">unique_ptr</code>åªå…è®¸ä¸€ä¸ªè¯¥ç±»å‹æŒ‡é’ˆæŒ‡å‘æŸä¸ªå¯¹è±¡ã€‚æ­£å› ä¸ºæ­¤ï¼Œå…¶<strong>ä¸æ”¯æŒæ™®é€šçš„æ‹·è´æˆ–è€…èµ‹å€¼æ“ä½œï¼Œæˆ‘ä»¬åªèƒ½å°†å…¶ç›´æ¥åˆå§‹åŒ–</strong>ã€‚</p>

<p>ä½†æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">reset</code>æˆ–è€…<code class="language-plaintext highlighter-rouge">release</code>æ“ä½œè½¬ç§»æŒ‡é’ˆæ§åˆ¶æƒï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">p2</span><span class="p">(</span><span class="n">p1</span><span class="p">.</span><span class="n">release</span><span class="p">());</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">release</code>è¿”å›å½“å‰çš„<code class="language-plaintext highlighter-rouge">unique_ptr</code>ä¿å­˜çš„æŒ‡é’ˆå¹¶å°†å…¶ç½®ç©ºï¼Œå¹¶å°†<code class="language-plaintext highlighter-rouge">p1</code>çš„æ§åˆ¶æƒè½¬ç§»ç»™<code class="language-plaintext highlighter-rouge">p2</code>.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">p3</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="n">p2</span><span class="p">.</span><span class="n">release</span><span class="p">());</span>
</code></pre></div></div>

<p>ä¸Šè¿°ä»£ç ä¸ä»…å°†<code class="language-plaintext highlighter-rouge">p2</code>çš„æ§åˆ¶æƒè½¬ç§»ç»™<code class="language-plaintext highlighter-rouge">p3</code>ï¼ŒåŒæ—¶å°†<code class="language-plaintext highlighter-rouge">p3</code>åŸæœ¬æŒ‡å‘çš„å†…å­˜æ¸…ç©ºã€‚</p>

<blockquote>
  <p>exception:</p>

  <p>ä¸èƒ½æ‹·è´<code class="language-plaintext highlighter-rouge">unique_ptr</code>çš„è§„åˆ™æœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œæˆ‘ä»¬å¯ä»¥æ‹·è´æˆ–è€…èµ‹å€¼ä¸€ä¸ªè¡Œå°†é”€æ¯çš„<code class="language-plaintext highlighter-rouge">unique_ptr</code>ï¼Œå³ä½œä¸ºå‡½æ•°çš„è¿”å›å€¼å¤„ç†ï¼Œè§<em>C++ Primer</em> P418. ä¸ªäººçŒœæµ‹æ˜¯å› ä¸ºç¼–è¯‘å™¨çš„<em>RVO</em>ä¸<em>NRVO</em>æœºåˆ¶å¯¼è‡´å…è®¸æˆ‘ä»¬è¿™ä¹ˆåšã€‚</p>
</blockquote>

<p>æ ‡å‡†åº“ä¹Ÿæä¾›ç»™æˆ‘ä»¬ç®¡ç†<code class="language-plaintext highlighter-rouge">new</code>åˆ†é…æ•°ç»„çš„<code class="language-plaintext highlighter-rouge">unique_ptr</code>ç‰ˆæœ¬ï¼Œæˆ‘ä»¬éœ€è¦åœ¨åŸå…ˆçš„åŸºç¡€ä¸ŠåŠ ä¸€ä¸ªæ–¹æ‹¬å·ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">[]</span><span class="o">&gt;</span> <span class="n">up</span><span class="p">(</span><span class="k">new</span> <span class="nf">int</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
<span class="n">up</span><span class="p">.</span><span class="n">release</span><span class="p">();</span> <span class="c1">// use delete[]</span>
</code></pre></div></div>

<blockquote>
  <p>æ­¤æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹æ ‡è¿ç®—ç¬¦ï¼Œä½†æ˜¯ä¸æ”¯æŒæˆå‘˜è®¿é—®è¿ç®—ç¬¦ã€‚</p>
</blockquote>

<h4 id="weak_ptr">weak_ptr</h4>

<p>è¿™é‡Œä¸äºˆè®¨è®ºã€‚</p>

<h2 id="function-pointers">Function Pointers</h2>

<p>è¿™é‡Œæ¥è®¨è®ºä¸€ä¸‹å‡½æ•°æŒ‡é’ˆï¼Œå¹¶å¯¹å…³é”®å­—<code class="language-plaintext highlighter-rouge">typedef</code>ä¸<code class="language-plaintext highlighter-rouge">decltype</code>çš„ç”¨æ³•åŠ ä»¥ç†Ÿæ‚‰ã€‚å…³äºå‡½æ•°æŒ‡é’ˆï¼Œ<a href="https://blog.csdn.net/Hipercomer/article/details/8616707?spm=1001.2101.3001.6650.1&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EOPENSEARCH%7Edefault-1.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EOPENSEARCH%7Edefault-1.no_search_link">è¿™é‡Œ</a>æœ‰ä¸€ç¯‡å¾ˆæ¸…æ™°çš„ç³»åˆ—ã€‚</p>

<h3 id="function">Function</h3>

<h4 id="function-pointer-declaration">Function pointer declaration</h4>

<p>ä¸€ä¸ªå‡½æ•°ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">bool</span> <span class="nf">foo</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span><span class="p">,</span> <span class="n">cosnt</span> <span class="n">string</span><span class="o">&amp;</span><span class="p">);</span>
</code></pre></div></div>

<p>å‡½æ•°æŒ‡é’ˆâ€“ä¸€ä¸ªæŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">bool</span> <span class="p">(</span><span class="o">*</span><span class="n">pf</span><span class="p">)(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span><span class="p">);</span>
</code></pre></div></div>

<blockquote>
  <p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç¬¬ä¸€ä¸ªæ‹¬å·æ˜¯å¿…é¡»çš„ï¼Œå¦åˆ™æˆ‘ä»¬ç›¸å½“äº<strong>å£°æ˜äº†ä¸€ä¸ªå‡½æ•°ï¼Œå…¶è¿”å›å€¼ä¸º<code class="language-plaintext highlighter-rouge">bool*</code></strong>:</p>

  <p>```c++
bool *pf(const string&amp;, const string&amp;);</p>
</blockquote>

<p>é‚£ä¹ˆæˆ‘ä»¬å¦‚ä½•ç†è§£å‡½æ•°æŒ‡é’ˆçš„å½¢å¼ï¼Ÿé¦–å…ˆï¼Œå­˜åœ¨<code class="language-plaintext highlighter-rouge">*</code>è¯´æ˜<code class="language-plaintext highlighter-rouge">pf</code>æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå…¶æ¬¡å®ƒæŒ‡å‘çš„æ˜¯ä¸€ä¸ªè¿”å›ç±»å‹ä¸º<code class="language-plaintext highlighter-rouge">bool</code>çš„ï¼Œå‚æ•°ç±»å‹ä¸ºä¸¤ä¸ª<code class="language-plaintext highlighter-rouge">const string</code>å¼•ç”¨çš„å‡½æ•°ã€‚</p>

<h4 id="use-function-pointers">Use function pointers</h4>

<p>åœ¨ä½¿ç”¨å‡½æ•°æŒ‡é’ˆæ—¶ï¼Œ<code class="language-plaintext highlighter-rouge">&amp;</code>ä¸<code class="language-plaintext highlighter-rouge">*</code>å·å¾€å¾€æ˜¯å¯é€‰çš„ï¼Œç¼–è¯‘å™¨ä¼šå¸®åŠ©æˆ‘ä»¬è‡ªåŠ¨è½¬æ¢ï¼Œä½†ä¸ºäº†æ»¡è¶³æŒ‡é’ˆè°ƒç”¨çš„<em>ä¸€è‡´æ€§</em>ï¼Œæˆ‘ä»¬ä¹ æƒ¯äºåŠ ä¸Šè¿™ä¸¤ä¸ªç¬¦å·ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pf</span> <span class="o">=</span> <span class="n">foo</span><span class="p">;</span>
<span class="n">pf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">foo</span><span class="p">;</span> <span class="c1">// the same</span>

<span class="n">pf</span><span class="p">(</span><span class="s">"1"</span><span class="p">,</span> <span class="s">"2"</span><span class="p">);</span>
<span class="p">(</span><span class="o">*</span><span class="n">pf</span><span class="p">)(</span><span class="s">"1"</span><span class="p">,</span> <span class="s">"2"</span><span class="p">);</span> <span class="c1">// the same</span>
</code></pre></div></div>

<h5 id="as-parameters">As parameters</h5>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">useBigger</span><span class="p">(</span><span class="kt">bool</span> <span class="n">pf</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="p">));</span>
<span class="kt">void</span> <span class="nf">useBigger</span><span class="p">(</span><span class="kt">bool</span> <span class="p">(</span><span class="o">*</span><span class="n">pf</span><span class="p">)(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="p">));</span> <span class="c1">// the same</span>
</code></pre></div></div>

<h5 id="as-return-values">As return values</h5>

<p>æˆ‘ä»¬å…ˆæ¥æ€è€ƒï¼Œå¦‚æœè¦è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œé‚£åº”è¯¥å†™ä½œä»€ä¹ˆå½¢å¼ï¼Ÿâ€“&gt;ä¸ºäº†ç¡®å®šå‡½æ•°çš„ç±»å‹ï¼Œæˆ‘ä»¬éœ€è¦ï¼š</p>

<ul>
  <li>å‡½æ•°è¿”å›ç±»å‹</li>
  <li>å‡½æ•°å‚æ•°ç±»å‹</li>
  <li>å‡½æ•°å‚æ•°ä¸ªæ•°</li>
</ul>

<p>äºæ˜¯æˆ‘ä»¬å¯ä»¥æœ‰å¦‚ä¸‹ä»£ç ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="n">F</span> <span class="o">=</span> <span class="kt">int</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="n">F</span> <span class="nf">f</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
</code></pre></div></div>

<p>ä¸Šè¿°ä»£ç è¡¨ç¤ºå‡½æ•°<code class="language-plaintext highlighter-rouge">f</code>è¿”å›çš„æ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹ï¼Œè¯¥å‡½æ•°ç±»å‹å…·å¤‡<code class="language-plaintext highlighter-rouge">int</code>ç±»å‹çš„è¿”å›å€¼ä»¥åŠ<code class="language-plaintext highlighter-rouge">int*, int</code>çš„å‚æ•°ç±»å‹ã€‚</p>

<p>é‚£ä¹ˆå¦‚æœæˆ‘ä»¬æƒ³è¦ä¸€ä¸ªå‡½æ•°è¿”å›ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œè¯¥å¦‚ä½•è¡¨ç¤ºå‘¢ï¼Ÿæ ¹æ®æˆ‘ä»¬å®šä¹‰å‡½æ•°æŒ‡é’ˆæ ¼å¼çš„ç»éªŒï¼Œåº”å½“è¿™ä¹ˆå†™ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
</code></pre></div></div>

<p>æ‰€ä»¥ï¼Œå¦‚æœç°åœ¨æˆ‘ä»¬è¦ç›´æ¥å£°æ˜ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°<strong>è¿”å›ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ</strong>ï¼Œå½¢å¼æ˜¯è¿™æ ·ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">foo</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span> <span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
</code></pre></div></div>

<p>ä»å†…è€Œå¤–çš„åˆ†æï¼Œå› ä¸º<code class="language-plaintext highlighter-rouge">foo</code>æœ‰ä¸€ä¸ªå½¢å‚åˆ—è¡¨ï¼Œæ‰€ä»¥<code class="language-plaintext highlighter-rouge">foo</code>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå‰è¾¹æœ‰<code class="language-plaintext highlighter-rouge">*</code>æ‰€ä»¥è¿”å›ä¸€ä¸ªæŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆå…·å¤‡å‡½æ•°çš„å½¢å¼ï¼šè¿”å›ç±»å‹ä¸º<code class="language-plaintext highlighter-rouge">int</code>ï¼Œæ¥å—å‚æ•°ä¸º<code class="language-plaintext highlighter-rouge">int*, int</code>ï¼Œæ‰€ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆã€‚æ•…å‡½æ•°<code class="language-plaintext highlighter-rouge">foo</code>è¿”å›ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆã€‚</p>

<p>å½“ç„¶ï¼Œæ ¹æ®<strong>C++11</strong>æä¾›çš„è¯­æ³•ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è¿™æ ·å†™ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="nf">f1</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">-&gt;</span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">int</span><span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="array">Array</h3>

<h4 id="decalaration">Decalaration</h4>

<p>åœ¨å£°æ˜æ•°ç»„æ—¶ï¼Œæˆ‘ä»¬ä¸€å®šè¦åŒºåˆ†æ•°ç»„æŒ‡é’ˆå’ŒæŒ‡é’ˆæ•°ç»„çš„åŒºåˆ«ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="o">*</span><span class="n">p1</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span> <span class="c1">//p1 is an array, which has 10 pointers that pointing to int.</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">p1</span><span class="p">)[</span><span class="mi">10</span><span class="p">];</span> <span class="c1">// p1 is a pointer, pointing to an array which has 10 ints.</span>
</code></pre></div></div>

<p>æ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³å£°æ˜ä¸€ä¸ªè¿”å›æ•°ç»„æŒ‡é’ˆçš„å‡½æ•°ï¼Œè¯¥æ€ä¹ˆåšï¼Ÿæœ‰äº†ä¹‹å‰è¿”å›å‡½æ•°æŒ‡é’ˆçš„ç»éªŒï¼Œè¿™é‡Œä¹Ÿå°±ä¸éš¾ç†è§£äº†ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">))[</span><span class="mi">10</span><span class="p">];</span>
</code></pre></div></div>

<p>è¯¥å‡½æ•°è¿”å›ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªå«æœ‰åä¸ªæ•´æ•°çš„æ•°ç»„ã€‚</p>

<blockquote>
  <p>è¿™é‡Œå¤–è¾¹çš„æ‹¬å·å¿…é¡»å­˜åœ¨ï¼Œç†ç”±å’Œä¹‹å‰ä¸€æ ·ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°†ç›´æ¥è¿”å›ä¸€ä¸ªæœ‰åä¸ªæ•´å½¢æŒ‡é’ˆçš„æ•°ç»„ã€‚</p>
</blockquote>

<p>åŒæ ·åœ°ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨<strong>å°¾ç½®è¿”å›ç±»å‹</strong>ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">func</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)[</span><span class="mi">10</span><span class="p">];</span>
</code></pre></div></div>

<p>å‡½æ•°æŒ‡é’ˆæ•°ç»„çš„å®šä¹‰æ–¹å¼ï¼Œä¹Ÿå¾ˆå¥½ç†è§£äº†ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="n">pf</span><span class="p">[</span><span class="mi">10</span><span class="p">])(</span><span class="kt">int</span><span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
</code></pre></div></div>

<h3 id="typedef--decltype">typedef &amp; decltype</h3>

<h4 id="typedef">typedef</h4>

<h5 id="variable">variable</h5>

<p>è¿™é‡Œè®°å½•å‡ ç‚¹å®¹æ˜“æ··æ·†å’Œè¯¯åˆ¤çš„ä½¿ç”¨æ–¹æ³•ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="kt">double</span> <span class="n">wages</span><span class="p">;</span> <span class="c1">// wages is a type alias of double</span>
<span class="k">typedef</span> <span class="n">wages</span> <span class="n">base</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> <span class="c1">// ???</span>
</code></pre></div></div>

<p>è¿™é‡Œï¼Œåœ¨ç¬¬äºŒè¡Œä»£ç ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ï¼Œ<code class="language-plaintext highlighter-rouge">p</code>æ˜¯<code class="language-plaintext highlighter-rouge">double*</code>çš„ç±»å‹åˆ«åï¼</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pstring</span><span class="p">;</span> <span class="c1">// the same as above</span>
</code></pre></div></div>

<h5 id="array--struct">array &amp; struct</h5>

<p>å¦å¤–ï¼Œå¯¹äºæ•°ç»„çš„ä½¿ç”¨ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="kt">int</span> <span class="n">arrs</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</code></pre></div></div>

<p>è¿™é‡Œçš„å«ä¹‰æ˜¯<code class="language-plaintext highlighter-rouge">arrs</code>æ˜¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">type alias</code>ï¼Œå…¶ä»£è¡¨æœ‰åä¸ª<code class="language-plaintext highlighter-rouge">int</code>å…ƒç´ çš„æ•°ç»„ã€‚(å¯ç±»æ¨åˆ°ç»“æ„ä½“ç­‰ç±»å‹ä¸Š)</p>

<h5 id="function--function-pointers">function &amp; function pointers</h5>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="kt">bool</span> <span class="nf">func</span><span class="p">(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span><span class="p">);</span>
</code></pre></div></div>

<p>è¿™é‡Œçš„<code class="language-plaintext highlighter-rouge">func</code>æ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹çš„<code class="language-plaintext highlighter-rouge">type alias</code>ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="kt">bool</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span><span class="p">)</span>
</code></pre></div></div>

<p>è¿™é‡Œçš„<code class="language-plaintext highlighter-rouge">func</code>æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆã€‚</p>

<h4 id="decltype">decltype</h4>

<p><code class="language-plaintext highlighter-rouge">decltype</code>çš„ç®€å•ç”¨æ³•è¿™é‡Œä¸æï¼Œè¿™é‡Œé¦–å…ˆè¯´ä¸€æ¡å…³é”®çš„è¯­æ³•è§„åˆ™ï¼š</p>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">delcltype((variable))</code>ï¼ˆåŒå±‚æ‹¬å·ï¼‰çš„ç»“æœæ°¸è¿œæ˜¯å¼•ç”¨ï¼Œè€Œ<code class="language-plaintext highlighter-rouge">decltype(variable)</code>çš„ç»“æœåªæœ‰å½“<code class="language-plaintext highlighter-rouge">variable</code>çš„ç»“æœæœ¬èº«æ˜¯å¼•ç”¨æ—¶æ‰æ˜¯å¼•ç”¨ã€‚ï¼ˆæ˜¯å¼•ç”¨æ„å‘³ç€æˆ‘ä»¬å¿…é¡»å¯¹å…¶åˆå§‹åŒ–.ï¼‰</p>

  <p>æ‰€ä»¥ï¼Œç”±äº<code class="language-plaintext highlighter-rouge">[]</code>çš„è¿”å›å€¼ä¸ºä¸€ä¸ªå¼•ç”¨ï¼Œæˆ‘ä»¬ä½¿ç”¨<code class="language-plaintext highlighter-rouge">decltype(a[i])</code>æ—¶å¿…é¡»å¯¹å…¶èµ‹åˆå§‹å€¼ã€‚</p>
</blockquote>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code class="language-plaintext highlighter-rouge">decltype</code>å…³é”®å­—è¿”å›çš„æ˜¯<strong>ç±»å‹</strong>ï¼Œè¿™æ„å‘³ç€å¯¹äºå¦‚ä¸‹ä»£ç ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">foo</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// do something</span>
<span class="p">}</span>
<span class="k">decltype</span><span class="p">(</span><span class="n">foo</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
</code></pre></div></div>

<p>æˆ‘ä»¬ä¼šå¾—åˆ°è¿”å›å€¼ç±»å‹ï¼Œè€Œå¯¹äº</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">foo</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// do something</span>
<span class="p">}</span>
<span class="k">decltype</span><span class="p">(</span><span class="n">foo</span><span class="p">);</span>
</code></pre></div></div>

<p>æˆ‘ä»¬å¾—åˆ°çš„æ˜¯<strong>å‡½æ•°ç±»å‹</strong>ï¼è¡¨ç¤ºå‡ºæ¥æ˜¯ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
</code></pre></div></div>

<p>äºæ˜¯æˆ‘ä»¬å¯ä»¥å°†<code class="language-plaintext highlighter-rouge">typedef</code>ä¸<code class="language-plaintext highlighter-rouge">decltype</code>ç»“åˆæ¥è¡¨ç¤ºå‡½æ•°æŒ‡é’ˆï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">decltype</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
</code></pre></div></div>

<p>å¯¹äºæ•°ç»„ä¹Ÿæ˜¯ä¸€æ ·ï¼Œä»–åªä¼šè¿”å›æ•°ç»„ç±»å‹ï¼Œæˆ‘ä»¬æƒ³è¦æŒ‡é’ˆï¼Œåˆ™éœ€è¦ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">*</code>ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">odd</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">};</span>
<span class="kt">int</span> <span class="n">even</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">};</span>
<span class="k">decltype</span><span class="p">(</span><span class="n">odd</span><span class="p">)</span> <span class="o">*</span><span class="n">arrPtr</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">odd</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">even</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åœ¨è¿™é‡Œï¼Œ<code class="language-plaintext highlighter-rouge">decltype</code>è¿”å›çš„æ˜¯ä¸€ä¸ªæŒ‡å‘å«æœ‰5ä¸ªæ•´å‹æ•°æ®çš„æ•°ç»„çš„æŒ‡é’ˆï¼Œå³ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="p">)[</span><span class="mi">5</span><span class="p">];</span>
</code></pre></div></div>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä¸Šè¾¹çš„ä¾‹å­ä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">odd</code>ä¸<code class="language-plaintext highlighter-rouge">&amp;odd</code>æ˜¯ä¸ä¸€æ ·çš„ï¼Œå¦‚æœåœ¨ä¸Šä¾‹ä¸­ä¸åŠ <code class="language-plaintext highlighter-rouge">&amp;</code>ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ç¼–è¯‘å™¨æŠ¥é”™ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">cannot</span> <span class="n">convert</span> <span class="err">â€˜</span><span class="kt">int</span><span class="o">*</span><span class="err">â€™</span> <span class="n">to</span> <span class="err">â€˜</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="p">)[</span><span class="mi">5</span><span class="p">]</span><span class="err">â€™</span> <span class="n">in</span> <span class="k">return</span>
</code></pre></div></div>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè™½ç„¶æ•°ç»„åä¹Ÿæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œä½†ä»–æ˜¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">int*</code>çš„æŒ‡é’ˆï¼Œä½†<code class="language-plaintext highlighter-rouge">&amp;odd</code>æ˜¯æŒ‡å‘æ•´ä¸ªæ•°ç»„çš„æŒ‡é’ˆï¼Œè¿™ä¸¤è€…çš„åŒºåˆ«å°±å¥½æ¯”çœæ”¿åºœå’Œçœä¼šå¸‚æ”¿åºœï¼Œè™½ç„¶éƒ½åœ¨åŒä¸€ä¸ªä½ç½®ï¼Œåœ°å€æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯ä»–ä»¬çš„æ„ä¹‰å®Œå…¨ä¸åŒï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">*</span><span class="n">odd</span><span class="p">;</span> <span class="c1">// 1</span>
<span class="o">*</span><span class="p">(</span><span class="o">&amp;</span><span class="n">odd</span><span class="p">);</span> <span class="c1">// the same as above</span>

<span class="o">&amp;</span><span class="n">odd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// we will move to the next variable position (go beyond sizeof(odd) length)</span>
<span class="n">odd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// we will get into the next posision in the current odd array (move sizeof(odd[0]) length)</span>
</code></pre></div></div>

<h2 id="multithreading">Multithreading</h2>

<p>æœ¬éƒ¨åˆ†ä½œä¸ºæ‰©å±•å†…å®¹ï¼Œåœ¨è¿™é‡Œä¸äºˆåˆ—å‡ºï¼Œä¸ªäººè§‰å¾—ç›¸æ¯”èµ·è¿™ä¸ªç‰ˆæœ¬çš„<em>CS 106L</em>çš„å¤šçº¿ç¨‹å†…å®¹ï¼Œ<em>CS 106B Su2020</em>æ˜¯æ›´å¥½çš„å…¥é—¨ã€‚</p>
:ET